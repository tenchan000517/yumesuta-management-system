# ゆめマガ進捗管理システム 徹底調査結果

**調査日**: 2025-10-07
**調査対象**: YUMEMAGA_SPREADSHEET_ID (Phase4 逆算スケジューラー)
**調査目的**: 改善要件実装のための現状把握

---

## 📊 1. スプレッドシート全体構造

### 全14シート構成

| No | シート名 | 用途 |
|----|---------|------|
| 1 | シート1 | (空) |
| 2 | **カテゴリ同期マスター** | 工程グループの同期ルール（⭐️重要） |
| 3 | 負荷制約マスター | 担当者の負荷制限 |
| 4 | 期間制約マスター | 期間設定 |
| 5 | 拡張工程マスター | 拡張工程情報 |
| 6 | **設定マスター** | システム設定（月号、日付など） |
| 7 | **新依存関係マスター** | 工程間の依存関係（⭐️重要） |
| 8 | **新工程マスター** | 全97工程の基本情報（⭐️最重要） |
| 9 | 理想形_ガント_2025年11月号 | 理想スケジュール |
| 10 | **逆算配置_ガント_2025年11月号** | 実際の逆算スケジュール（⭐️重要） |
| 11 | 理想形_ガント_2025年10月号 | 過去データ |
| 12 | 工程マスター確認 | 確認用シート |
| 13 | **進捗入力シート** | 実績完了日の入力シート（⭐️最重要） |
| 14 | カレンダーマスター | カレンダー情報 |

---

## 🎯 2. 新工程マスター（97工程）

### 列構成

| 列 | 列名 | 説明 | 例 |
|----|------|------|-----|
| A | 工程No | 工程ID | `A-3` |
| B | 工程名 | 工程の正式名称 | `メイン文字起こし` |
| C | 工数 | 作業時間 | `1` |
| D | 担当区分 | 担当者 | `制作担当` |
| E | 優先度 | 優先度 | `1` |
| F | 必要データ | 工程に必要な成果物 | `録音データ` |
| G | 確定締切 | 締切 | - |
| H | 期間指定 | 期間 | - |
| I | 作業カテゴリ | カテゴリコード | - |

### カテゴリプレフィックス別の工程数

**全15カテゴリ**: A, B, C, E, F, H, I, J, K, L, M, N, P, S, Z

| カテゴリ | 工程数 | 代表工程 | 内容 |
|---------|-------|---------|------|
| A | 15 | A-1: メインインタビュー実施日報告 | メインインタビュー記事 |
| K | 7 | K-1: インタビュー②実施日報告 | サブインタビュー記事 |
| H | 9 | H-1: STAR①実施日報告 | STAR記事① |
| I | 9 | I-1: STAR②実施日報告 | STAR記事② |
| L | 11 | L-1: 企画内容報告 | 記事L |
| M | 12 | M-1: 企画内容報告 | 記事M |
| C | 9 | C-1: 新規企業①情報シート依頼 | 新規企業紹介ページ |
| E | 5 | E-1: 既存企業ページ状態確認 | 既存企業紹介ページ |
| P | 5 | P-1: パートナー一覧ページ状態確認 | パートナー一覧ページ |
| Z | 5 | Z-1: 全ページ完成 | 全体進捗 |
| B | 2 | B-1: 全企画タイトル確定 | 全体調整 |
| F | 3 | F-1: 闇バイト注意喚起（P26-27） | 固定ページ |
| J | 1 | J-1: STAR企画導入ページ制作 | STAR導入 |
| N | 1 | N-1: 全体修正対応（※新規案件絶対厳禁） | 修正対応 |
| S | 2 | S-1: ゆめマガ○月号企画決定 | スタート工程 |

### ⚠️ 重要な発見

**問題点**: 工程名にカテゴリ情報が含まれている

例:
- `A-3: メイン文字起こし` → "メイン" がカテゴリ情報
- `K-3: インタビュー②文字起こし` → "インタビュー②" がカテゴリ情報
- `H-1: STAR①実施日報告` → "STAR①" がカテゴリ情報

**改善案**:
- 工程名から冗長なカテゴリ情報を削除
- 例: `A-3: 文字起こし`, `K-3: 文字起こし`
- カテゴリ情報は工程Noのプレフィックスで識別

---

## 🔗 3. 新依存関係マスター（108件）

### 列構成

| 列 | 列名 | 説明 | 例 |
|----|------|------|-----|
| A | 工程No | 依存先工程 | `A-3` |
| B | 前提工程 | 依存元工程 | `A-2` |
| C | 依存タイプ | 開始前/同日可 | `開始前` |
| D | 日数 | 待機日数 | `0` |

### 依存関係の例

```
S-2 -> S-1 (開始前, 0)
A-1 -> S-2 (開始前, 0)
A-2 -> A-1 (開始前, 0)
A-3 -> A-6 (開始前, 0)  # 文字起こしは写真レタッチの後
A-4 -> A-3 (開始前, 0)  # 内容整理は文字起こしの後
...
```

### 依存元として最も参照される工程 (TOP 10)

| 工程No | 参照回数 | 説明 |
|-------|---------|------|
| S-2 | 9回 | 企画書作成（全カテゴリのスタート地点） |
| A-6 | 3回 | 写真レタッチ |
| A-13 | 3回 | 内部チェック |
| J-1 | 3回 | STAR企画導入ページ制作 |
| A-4 | 2回 | メイン内容整理 |
| A-8 | 2回 | 表紙加工依頼 |
| K-4 | 2回 | インタビュー②内容整理 |
| L-1 | 2回 | 企画内容報告 |
| L-4 | 2回 | データ提出・撮影 |
| L-9 | 2回 | 内部チェック |

### ⭐️ 実装への影響

**改善要件3: 準備OK工程の表示**

依存関係マスターを使用して、以下のロジックで実装可能：
1. 工程Xの前提工程一覧を取得（B列でフィルタ）
2. すべての前提工程の実績日（G列）が入力されているか確認
3. すべて完了していれば「準備OK」と表示

```typescript
// 疑似コード
async function getReadyProcesses(issue: string) {
  const dependencies = await getSheetData(spreadsheetId, '新依存関係マスター!A1:D200');
  const progress = await getSheetData(spreadsheetId, '進捗入力シート!A1:J1000');

  // 工程ごとの完了状態をマップ化
  const completionMap: Record<string, boolean> = {};
  progress.slice(1).forEach(row => {
    completionMap[row[0]] = !!row[6]; // G列: 実績日
  });

  // 準備OK工程を判定
  const readyProcesses: string[] = [];
  dependencies.slice(1).forEach(depRow => {
    const processNo = depRow[0];
    const prerequisite = depRow[1];

    if (prerequisite && completionMap[prerequisite] && !completionMap[processNo]) {
      // 前提工程が完了 && 自分は未完了 = 準備OK
      readyProcesses.push(processNo);
    }
  });

  return readyProcesses;
}
```

---

## 📅 4. ガントシート（逆算配置_ガント_2025年11月号）

### 列構成

| 列 | 列名 | 説明 |
|----|------|------|
| A | 工程 | 工程No + 工程名 (例: `A-3 メイン文字起こし`) |
| B | レイヤー | Layer 1〜6, 次月号 |
| C | 配置理由 | 依存関係の説明 |
| D〜 | 日付列 | 9/21〜11/20（61列） |

### 日付が入っていない工程（7件）

**⚠️ 不具合確認**: 以下の工程はガントシートに日付が入っていません

| 工程No | 工程名 | Layer | 配置理由 |
|-------|--------|-------|---------|
| C-9 | 新規企業追加可能期間 | Layer 6 | 依存関係による配置 |
| E-5 | 既存企業修正変更対応可能期間 | Layer 6 | 依存関係による配置 |
| P-5 | パートナー修正変更対応可能期間 | Layer 6 | 依存関係による配置 |
| F-1 | 闇バイト注意喚起（P26-27） | Layer 6 | 依存関係による配置 |
| F-2 | デジタルプラットフォーム案内（P30-31） | Layer 6 | 依存関係による配置 |
| F-3 | 裏表紙（P32） | Layer 6 | 依存関係による配置 |
| N-1 | 全体修正対応（※新規案件絶対厳禁） | Layer 6 | 依存関係による配置 |

**共通点**: すべて Layer 6

**原因推測**:
- 「○○可能期間」工程は期間を表すため、特定日付が入らない設計かもしれない
- F-1, F-2, F-3, N-1 は固定ページや修正対応で、柔軟な日程調整が必要

---

## ⚙️ 5. 設定マスター

### データ構造

| 項目名 | 設定値 | 備考 |
|--------|-------|------|
| 対象年 | 2025 | 月号の発行年 |
| 対象月号 | 11 | 作成する月号（10=10月号） |
| 開始月オフセット | -2 | 何ヶ月前から開始するか |
| 開始日 | 21 | 開始する日（21日） |
| 締切日 | 20 | 締切の日（20日） |
| 計算開始日 | 2025/09/21 | 自動計算される開始日 |
| 計算終了日 | 2025/11/20 | 自動計算される終了日 |

**⚠️ カテゴリ設定は含まれていない**

設定マスターにはカテゴリに関する設定が存在しません。
カテゴリ定義は「カテゴリ同期マスター」に存在します。

---

## 🔄 6. カテゴリ同期マスター（⭐️最重要発見）

### 列構成

| 列 | 列名 | 説明 |
|----|------|------|
| A | カテゴリグループ | カテゴリ名 |
| B | 同期工程配列 | 同じタイミングで実行する工程 |
| C | 理想実行日 | 理想的な実施日 |
| D | 同期優先度 | 優先度 |
| E | 効率ボーナス | 同期時の効率向上率 |

### カテゴリグループ一覧

| カテゴリグループ | 同期工程配列 | 理想実行日 |
|-----------------|-------------|-----------|
| 文字起こし | A-3, K-3, L-5, M-5, H-3, I-3 | 9日目 |
| 内容整理 | A-4, K-4, L-6, M-6, H-4, I-4 | 10日目 |
| コピー抽出 | A-5, H-5, I-5 | 10日目 |
| レタッチ | L-7, M-7, H-6, I-6 | 11日目 |
| 表紙関連 | A-6, A-7, A-8 | 8日目 |
| ページ制作_メイン | A-12 | 12日目 |
| ページ制作_サブ1 | K-5 | 12日目 |
| ページ制作_サブ2 | L-8, M-8, H-7, I-7 | 14日目 |
| 内部チェック_1 | A-13, C-7, E-3, P-3 | 15日目 |
| 内部チェック_2 | L-9, M-9, K-6, H-8, I-8 | 16日目 |
| **確認送付** | A-14, A-15, K-7, L-10, M-10, H-9, I-9, C-8, E-4, P-4 | 18日目 |
| 修正対応 | L-11, M-11 | 19日目 |
| 最終工程 | Z-2, Z-3, Z-4, Z-5 | 24日目 |

### ⭐️ 重要な発見

**「確認送付」カテゴリグループ**

現在の実装では、カテゴリごとに「確認送付」工程を個別に管理していますが、
**カテゴリ同期マスターでは、すべてのカテゴリの確認送付工程を一つのグループとして定義しています**。

これは、以下の改善要件と関連：
- 改善要件3: 依存関係に基づく準備OK工程の表示
- 改善要件4: Z・Bカテゴリの進捗管理セクション作成

---

## 🚨 7. コード内のカテゴリハードコード箇所

### 発見箇所（4箇所）

#### 1. `app/dashboard/yumemaga-v2/page.tsx:74`

```typescript
confirmationRequired: ['A', 'K', 'H', 'I', 'L', 'M', 'C', 'E', 'P'].includes(catId)
```

**問題点**:
- カテゴリが9個に限定（B, Z が含まれていない）
- 新工程マスターには15カテゴリ存在

#### 2. `app/dashboard/yumemaga-v2/page.tsx:110-116`

```typescript
const getCategoryName = (catId: string) => {
  const names: Record<string, string> = {
    A: 'メインインタビュー', K: 'インタビュー②', H: 'STAR①', I: 'STAR②',
    L: '記事L', M: '記事M', C: '新規企業', E: '既存企業',
    P: 'パートナー一覧', Z: '全体進捗',
  };
  return names[catId] || catId;
};
```

**問題点**:
- カテゴリ名がハードコード（10個）
- F, J, N, S, B が定義されていない

#### 3. `app/dashboard/yumemaga-v2/page.tsx:119-127`

```typescript
const getRequiredData = (catId: string) => {
  const data: Record<string, string[]> = {
    A: ['録音データ', '写真データ'], K: ['録音データ', '写真データ'],
    H: ['録音データ', '写真データ'], I: ['録音データ', '写真データ'],
    L: ['撮影データ'], M: ['撮影データ'],
    C: ['情報シート', '写真データ'], E: ['情報シート', '写真データ'],
    P: ['写真データ'], Z: [],
  };
  return data[catId] || [];
};
```

**問題点**:
- 必要データがハードコード
- 新工程マスターのF列（必要データ）から動的に取得すべき

#### 4. `app/api/yumemaga-v2/progress/route.ts:32-34`

```typescript
const categories: Record<string, any[]> = {
  A: [], K: [], H: [], I: [], L: [], M: [], C: [], E: [], P: [], Z: [],
};
```

**問題点**:
- カテゴリが10個に限定
- 新工程マスターの全15カテゴリをカバーしていない

### カテゴリの不一致まとめ

| 場所 | カテゴリ数 | カテゴリ一覧 | 不足 |
|------|----------|-------------|------|
| 新工程マスター（実際のデータ） | 15 | A, B, C, E, F, H, I, J, K, L, M, N, P, S, Z | - |
| コード内 page.tsx (確認必須) | 9 | A, K, H, I, L, M, C, E, P | **B, F, J, N, S, Z** |
| コード内 page.tsx (名前) | 10 | A, K, H, I, L, M, C, E, P, Z | **B, F, J, N, S** |
| コード内 page.tsx (必要データ) | 10 | A, K, H, I, L, M, C, E, P, Z | **B, F, J, N, S** |
| コード内 progress API | 10 | A, K, H, I, L, M, C, E, P, Z | **B, F, J, N, S** |

---

## 📝 8. 改善要件との対応関係

### 改善要件1: カテゴリの確定

**現状**:
- 新工程マスター: 15カテゴリ（A, B, C, E, F, H, I, J, K, L, M, N, P, S, Z）
- コード内: 9〜10カテゴリ（カテゴリ不一致）

**改善方針**:
- 新工程マスターの全15カテゴリを正式カテゴリとする
- コードから全てのカテゴリハードコードを削除
- カテゴリは新工程マスターの工程Noプレフィックスから動的に抽出

### 改善要件2: 工程名にカテゴリ名が入っている問題

**現状**:
- `A-3: メイン文字起こし` → "メイン" が冗長
- `K-3: インタビュー②文字起こし` → "インタビュー②" が冗長

**改善方針**:
- 新工程マスターの工程名を修正（スプレッドシート側で対応）
- または、表示時にカテゴリプレフィックスを除去する処理を追加

### 改善要件3: 依存関係に基づく準備OK工程の表示とアラート

**現状**:
- 新依存関係マスターが存在（108件の依存関係）
- 依存関係を利用した判定ロジックは未実装

**改善方針**:
1. 新依存関係マスターを読み込み
2. 各工程の前提工程をすべて取得
3. 前提工程がすべて完了（実績日入力済み）なら「準備OK」と表示
4. 予定日を過ぎている場合は「遅延アラート」を表示

### 改善要件4: Z・Bカテゴリの進捗管理セクション作成

**現状**:
- Zカテゴリは全体進捗（5工程）
- Bカテゴリは全体調整（2工程）
- 現在のコードではZ・Bカテゴリを適切に扱っていない

**改善方針**:
- Z・Bカテゴリ専用のUIセクションを作成
- 全体に関わる工程として別枠で表示

### 改善要件9: カテゴリの動的設定

**現状**:
- カテゴリ同期マスターが存在（13グループ）
- 設定マスターにカテゴリ設定はない

**改善方針**:
- 新工程マスターから動的にカテゴリ一覧を抽出
- カテゴリ同期マスターを活用して、カテゴリグループを管理

---

## ❓ 9. 未調査項目（ユーザーへの質問が必要）

### 企業紹介ページ（改善要件7）

**質問内容**:
1. 企業データベースはどこに保存されていますか？（別スプレッドシート？）
2. 既存企業・変更企業・新規企業の判別方法は？
3. 新規作成時の作業タスク一覧は？

### フレキシブル企画（改善要件8）

**質問内容**:
1. フレキシブルな企画とは具体的にどの工程ですか？
2. 通常の企画との違いは何ですか？（工程の追加/削除？）
3. どのように対応すべきですか？

### 作業アシスト機能（改善要件6）

**質問内容**:
1. Google Studioのリンクはどこに保存されていますか？
2. 文字起こしで使用するプロンプトの内容は？
3. 他にアシストが必要な工程は？

---

## 🎯 10. 次のステップ

### 1. ユーザーへの質問（優先度: 高）

上記の未調査項目についてユーザーに確認

### 2. 実装方針の提案（優先度: 高）

調査結果をもとに、以下の実装方針を提案：

#### 方針A: カテゴリの動的抽出

- 新工程マスターから全15カテゴリを動的に抽出
- カテゴリハードコードを削除
- カテゴリ名・必要データも新工程マスターから取得

#### 方針B: 依存関係ベースの準備OK判定

- 新依存関係マスターを活用
- 前提工程完了時に「準備OK」アイコンを表示
- 遅延時にアラートを表示

#### 方針C: カテゴリ同期マスターの活用

- カテゴリ同期マスターを読み込み
- 同じカテゴリグループの工程を一括管理
- 「確認送付」グループの一元管理

### 3. 段階的な実装（優先度: 中）

1. **Phase 1**: カテゴリの動的抽出（ハードコード削除）
2. **Phase 2**: 依存関係ベースの準備OK判定
3. **Phase 3**: Z・Bカテゴリの専用セクション作成
4. **Phase 4**: 作業アシスト機能の実装
5. **Phase 5**: 企業紹介ページの管理機能

---

**最終更新**: 2025-10-07
**次のアクション**: ユーザーへの質問 → 実装方針の承認 → Phase 1の実装開始
