# ゆめマガ工程管理スプレッドシート 構造・ロジック調査レポート

**調査日**: 2025-10-07
**スプレッドシートID**: `1qC3cMSGv8kjt6aoK20IvbaFfD3oLfvTTrFKUU_gQXhw`
**調査ツール**: `/api/investigate-process-sheets`

---

## 📊 エグゼクティブサマリー

このスプレッドシートは **Phase4逆算スケジューラー** として、雑誌制作の97工程を60日間の逆算スケジュールで管理する高度な工程管理システムです。

### 主な特徴
- **逆算ロジック**: 発行日から逆算して各工程の実施日を自動計算
- **マスターデータ駆動**: 6種類のマスターシートで工程の依存関係・制約・同期ルールを定義
- **複数号管理**: 月号ごとにガントシートを生成（例: 2025年11月号、2025年10月号）
- **進捗トラッキング**: 別シートで実績日を入力・管理

---

## 🗂️ スプレッドシート全体構造

### 全14シート構成

| # | シート名 | 役割 | サイズ |
|---|---------|------|--------|
| 1 | **シート1** | （空シート・用途不明） | 1000行 × 26列 |
| 2 | **カテゴリ同期マスター** | 工程グループの同期ルール定義 | 1000行 × 26列 |
| 3 | **負荷制約マスター** | 担当者の負荷制限・期間制約 | 1000行 × 26列 |
| 4 | **期間制約マスター** | 工程実施可能期間の制約 | 1000行 × 26列 |
| 5 | **拡張工程マスター** | 工程の詳細設定（未確認） | 1000行 × 26列 |
| 6 | **設定マスター** | システム全体設定（未確認） | 1000行 × 26列 |
| 7 | **新依存関係マスター** | 工程間の依存関係定義 | 1000行 × 26列 |
| 8 | **新工程マスター** | 全工程の基本情報定義 | 1000行 × 26列 |
| 9 | **理想形_ガント_2025年11月号** | 理想的な工程配置（参考用） | 1000行 × 34列 |
| 10 | **逆算配置_ガント_2025年11月号** | 実際の逆算スケジュール | 1000行 × 64列 |
| 11 | **理想形_ガント_2025年10月号** | 前号の理想配置 | 1000行 × 35列 |
| 12 | **工程マスター確認** | マスターデータ確認用 | 1000行 × 26列 |
| 13 | **進捗入力シート** | 実績完了日の入力シート | 1000行 × 26列 |
| 14 | **カレンダーマスター** | 営業日・休日管理 | 1000行 × 26列 |

---

## 🎯 逆算配置_ガントシート 詳細分析

### シート: `逆算配置_ガント_2025年11月号`

#### 基本情報
- **サイズ**: 1000行 × 64列
- **実データ行数**: 80行（ヘッダー除く）
- **日付範囲**: 9/21 〜 11/8（49日間）

#### 列構成

| 列 | 内容 | 説明 |
|----|------|------|
| A | **工程** | 工程ID + 工程名（例: `A-3 メイン文字起こし`） |
| B | **レイヤー** | 工程の階層（例: `Layer 3`, `Layer 4`） |
| C | **配置理由** | この日に配置された理由（例: `文字起こし同期: 9日目`） |
| D〜AZ | **日付列** | 各日付にセル値が存在 = その日に工程を実施 |

#### 日付列の値パターン

ガントチャートの各日付セルには以下のような値が入る:

```
例: 9/29列に "A-3" → 9/29に「A-3 メイン文字起こし」を実施
```

**重要**: セルに値がある = その日に工程を実施する。空白 = 実施しない。

#### サンプルデータ（最初の10行）

```
工程: A-3 メイン文字起こし
レイヤー: Layer 3
配置理由: 文字起こし同期: 9日目
9/29: A-3 ← この日に実施

工程: A-4 メイン内容整理
レイヤー: Layer 3
配置理由: 内容整理同期: 10日目
9/30: A-4

工程: A-5 キャッチコピー抽出
レイヤー: Layer 3
配置理由: コピー抽出同期: 10日目
9/30: A-5

工程: A-12 メインページ制作（P4-5）
レイヤー: Layer 4
配置理由: ページ制作分散: 12日目開始
10/2: A-12
10/3: A-12
10/4: A-12
（3日間連続実施）

工程: A-14 表紙確認送付
レイヤー: Layer 5
配置理由: 内部チェック完了後の確認送付
10/5: A-14

工程: K-2 インタビュー②データ提出
レイヤー: Layer 3
配置理由: K-3の前日に逆算配置
9/28: K-2
```

#### レイヤーの意味

`Layer 3`, `Layer 4`, `Layer 5` は工程の依存関係の深さを示すと推測されます。

- **Layer 3**: 初期工程（データ提出、文字起こし、内容整理）
- **Layer 4**: 中間工程（ページ制作）
- **Layer 5**: 後期工程（確認送付）

#### 配置理由の分類

| 配置理由パターン | 意味 |
|----------------|------|
| `文字起こし同期: 9日目` | カテゴリ同期マスターで定義されたグループ実行 |
| `内容整理同期: 10日目` | 同上 |
| `ページ制作分散: 12日目開始` | 負荷分散のため複数日に分割実行 |
| `K-3の前日に逆算配置` | 依存関係マスターで定義された前提工程 |
| `内部チェック完了後の確認送付` | 条件付き実行ルール |

---

## 📝 進捗入力シート 詳細分析

### シート: `進捗入力シート`

#### 基本情報
- **サイズ**: 1000行 × 26列
- **実データ行数**: 11行（ヘッダー除く）

#### 列構成

| 列 | 列名 | 説明 |
|----|------|------|
| A | **工程No** | 工程ID（例: `A-2`, `K-2`） |
| B | **工程名** | 工程の正式名称 |
| C | **必要データ** | この工程で必要な成果物 |
| D | **予定完了日** | （現在空白 - ガントから自動計算？） |
| E | **実績完了日** | ユーザーが手入力する実際の完了日 |
| F | **備考** | 入力ガイド（例: `録音データ提出完了日を入力`） |

#### サンプルデータ

```
工程No: A-2
工程名: メインインタビューデータ提出・撮影
必要データ: 録音データ
予定完了日: （空白）
実績完了日: （空白 - ユーザーが入力）
備考: 録音データ提出完了日を入力

工程No: K-2
工程名: インタビュー②データ提出
必要データ: 録音データ
予定完了日: （空白）
実績完了日: （空白）
備考: 録音データ提出完了日を入力
```

#### 重要な発見

**現状の問題**:
- `予定完了日`列が空白 → ガントチャートの日付と連携していない可能性
- APIルート (`process-schedule/route.ts`) では、この列を使ってステータス判定している
- **改善が必要**: ガントから予定日を自動取得するロジックが必要

---

## 🔧 マスターシート群の役割

### 1. カテゴリ同期マスター

**役割**: 複数の工程を同じ日に実行するグループを定義

#### サンプルデータ

| カテゴリグループ | 同期工程配列 | 理想実行日 | 同期優先度 | 効率ボーナス | 説明 |
|----------------|-------------|-----------|----------|------------|------|
| 文字起こし | A-3,K-3,L-5,M-5,H-3,I-3 | 9 | 1 | 1.2 | 音声データの一括処理で効率向上 |
| 内容整理 | A-4,K-4,L-6,M-6,H-4,I-4 | 10 | 1 | 1.2 | 情報整理の集中実行で品質統一 |
| コピー抽出 | A-5,H-5,I-5 | 10 | 2 | 1.1 | キャッチコピー作成の同日実行 |
| レタッチ | L-7,M-7,H-6,I-6 | 11 | 2 | 1.1 | 写真加工の一括処理で色調統一 |
| 表紙関連 | A-6,A-7,A-8 | 8 | 1 | 1.3 | 表紙制作工程の連携実行 |

**ロジック推測**:
- `理想実行日` = 発行日から逆算した理想的な実施日
- `同期優先度` = 同期の重要度（1 = 最優先）
- `効率ボーナス` = 同時実行時の効率改善率（1.2 = 20%改善）

### 2. 負荷制約マスター

**役割**: 担当者の負荷制限・期間制約を定義

#### サンプルデータ

| 担当者 | 最大同時実行数 | 最大負荷_人日 | 制限カテゴリ | 適用期間_開始日 | 適用期間_終了日 | 説明 |
|-------|-------------|------------|------------|--------------|--------------|------|
| 制作陣 | 3 | 6 | ページ制作,ネーム作成 | 1 | 30 | 制作陣の基本制約 |
| 制作陣 | 1 | 3 | ページ制作 | 12 | 16 | ページ制作期間の厳格制限 |
| 制作陣 | 2 | 4 | その他 | 17 | 20 | 最終段階での負荷軽減 |
| インタビュワー・撮影陣 | 5 | 8 | すべて | 1 | 30 | インタビュワーの基本制約 |
| インタビュワー・撮影陣 | 2 | 4 | 確認送付 | 18 | 24 | 確認期間の集中対応制限 |
| 制作陣 | 0 | 0 | 新規案件,変更対応 | 14 | 20 | 新規案件厳禁期間 |

**ロジック推測**:
- `最大同時実行数` = 同時に実行できる工程の数
- `最大負荷_人日` = 期間内の合計作業日数制限
- `適用期間` = 発行日からの逆算日数（1 = 発行59日前、30 = 発行30日前）

### 3. 新依存関係マスター

**役割**: 工程間の依存関係（「Aの後にBを実行」）を定義

（データ未取得 - 次ステップで調査）

### 4. 新工程マスター

**役割**: 全工程の基本情報（所要日数、担当者、カテゴリなど）を定義

（データ未取得 - 次ステップで調査）

### 5. カレンダーマスター

**役割**: 営業日・休日の管理

（データ未取得 - 次ステップで調査）

---

## 🧮 逆算スケジュールのロジック（推測）

### アルゴリズムの流れ

```
1. 【入力】発行日を設定（例: 2025年11月8日）

2. 【マスター読み込み】
   - 新工程マスター → 全工程の基本情報取得
   - 新依存関係マスター → 工程間の順序制約取得
   - カテゴリ同期マスター → 同時実行ルール取得
   - 負荷制約マスター → 担当者の負荷制限取得
   - カレンダーマスター → 営業日情報取得

3. 【逆算計算】
   発行日から逆算して各工程の実施日を計算:

   a. 最終工程（発行日直前）から開始
   b. 依存関係を辿って前提工程の日付を決定
   c. カテゴリ同期ルールを適用（同じグループは同日実行）
   d. 負荷制約をチェック（超過する場合は日付を前倒し）
   e. カレンダーマスターで休日を回避

4. 【出力】ガントチャートシートに配置
   - 各工程の実施日にセル値を入力
   - 配置理由を記録（どのルールで配置されたか）
```

### 重要な制約ルール

1. **依存関係制約**: 「A完了 → B開始」の順序を守る
2. **同期制約**: 同じカテゴリの工程は同日実行（効率化）
3. **負荷制約**: 担当者の同時実行数・負荷上限を超えない
4. **期間制約**: 特定の期間は特定の作業を禁止（例: 14〜20日目は新規案件禁止）
5. **営業日制約**: 休日は作業しない

---

## 🔍 現在のAPIとの対応関係

### `app/api/process-schedule/route.ts` の処理

```typescript
// 1. ガントシートから日付とタスクを取得
const headers = ganttRawData[0]; // ['工程', 'レイヤー', '配置理由', '9/21', '9/22', ...]
const dateHeaders = headers.slice(3); // 日付列のみ抽出

// 2. 各行をProcessTaskに変換
const tasks: ProcessTask[] = ganttRawData.slice(1).map((row) => {
  const dates: Record<string, string> = {};
  dateHeaders.forEach((date, index) => {
    const value = row[index + 3] || '';
    if (value) {
      dates[date] = value; // セルに値がある日付を記録
    }
  });

  return {
    processName: row[0],
    layer: row[1],
    reason: row[2],
    dates, // {' 9/29': 'A-3', '9/30': 'A-4'}
  };
});

// 3. 進捗入力シートからステータス取得
const progressData = progressRawData.slice(1).map((row) => {
  const actualDate = row[2]; // 実績完了日（E列）
  const statusRaw = row[3]; // ステータス（F列 - 現在未使用）

  // ステータス判定
  let status = 'not_started';
  if (actualDate) {
    status = 'completed';
  } else if (statusRaw === '進行中') {
    status = 'in_progress';
  } else if (statusRaw === '遅延') {
    status = 'delayed';
  }

  return { processName, plannedDate, actualDate, status, assignee, notes };
});
```

### 問題点と改善余地

1. **予定日が未設定**: `進捗入力シート`の`予定完了日`列（D列）が空白
   → ガントチャートから自動抽出する必要あり

2. **ステータス判定ロジックが不完全**:
   - 現在: `実績完了日`が入力されているか だけで判定
   - 改善: 今日の日付と比較して「予定日超過 = 遅延」を自動判定

3. **ガントチャートの表示範囲が狭い**:
   - 現在: `.slice(0, 30)` で30日分のみ表示
   - 改善: 全期間表示（49日分）

---

## 📋 次のステップ（推奨調査項目）

### ステップ1: 残りのマスターシート調査

- [ ] **新工程マスター**: 工程の所要日数、担当者、カテゴリを確認
- [ ] **新依存関係マスター**: 工程間の依存関係を確認
- [ ] **カレンダーマスター**: 休日ルールを確認

### ステップ2: 逆算ロジックの詳細解明

- [ ] 理想形ガントと逆算配置ガントの差分を比較
- [ ] 配置理由のパターンを完全に分類
- [ ] レイヤーの定義を確認

### ステップ3: ダッシュボードUI改善

- [ ] ガントチャート全期間表示（30日 → 49日）
- [ ] 予定日の自動取得ロジック追加
- [ ] 遅延判定の自動化（今日の日付と比較）
- [ ] マスターデータの可視化（依存関係図、負荷グラフなど）

---

## 📌 重要な発見のまとめ

1. **高度なマスターデータ駆動型システム**:
   6種類のマスターシートで工程の依存関係・制約・同期ルールを定義し、自動的にガントチャートを生成

2. **効率化ロジック**:
   カテゴリ同期で関連工程を同日実行（効率ボーナス最大1.3倍）

3. **負荷管理**:
   担当者の負荷制限を期間別に細かく設定（例: ページ制作期間は最大同時実行1件）

4. **柔軟な制約管理**:
   特定期間の作業禁止（例: 新規案件厳禁期間）

5. **現状のギャップ**:
   スプレッドシートの高度なロジックに対し、現在のダッシュボードは基本的な表示のみ
   → マスターデータの可視化、依存関係の表示、負荷グラフなどの追加余地あり

---

**調査完了日時**: 2025-10-07 02:36:44 UTC

