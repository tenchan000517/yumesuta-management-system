# ゆめマガ制作進捗管理システム - データ構造設計書

**作成日**: 2025-10-07
**ステータス**: 確定

---

## 📋 設計方針

### 基本原則
1. **進捗入力シート**を中心としたデータ管理
2. **ガントシート**は月号ごとに生成・参照のみ
3. **月号での明確な区別**により事前準備工程と制作工程を分離

---

## 📊 データ構造

### 1. 進捗入力シート（中心的データソース）

#### 最終構造

| 列名 | 説明 | 例 | 備考 |
|------|------|-----|------|
| **月号** | 対象月号 | `2025年11月号` | 事前準備工程と区別するため必須 |
| **工程No** | 工程ID | `A-3` | 一意識別子 |
| **工程名** | 工程の正式名称 | `メイン文字起こし` | |
| **必要データ** | 工程に必要な成果物 | `録音データ` | 複数の場合は`・`区切り |
| **逆算予定日** | ガントから自動取得 | `9/29` | 自動計算（読み取り専用） |
| **入力予定日** | ユーザーが調整可能 | `9/30` | ユーザーが変更可能 |
| **実績日** | 実際の完了日 | `10/1` | ユーザーが入力 |
| **先方確認ステータス** | 確認状態 | `確認待ち` | 未送付/確認待ち/確認OK/- |
| **備考** | 補足情報 | `録音データ提出完了日を入力` | |

#### 先方確認ステータスの値

| 値 | 意味 | 表示 |
|----|------|------|
| `未送付` | まだ先方に送付していない | 🔵 未送付 |
| `確認待ち` | 送付済み、返答待ち | 🟡 確認待ち |
| `確認OK` | 先方確認完了 | 🟢 確認OK |
| `-` | 確認不要な工程 | - |

#### データ例

```
月号          | 工程No | 工程名                     | 必要データ      | 逆算予定日 | 入力予定日 | 実績日 | 先方確認ステータス | 備考
-------------|--------|---------------------------|----------------|----------|----------|--------|------------------|------
2025年11月号 | A-2    | メインインタビューデータ提出 | 録音データ      | 9/28     | 9/28     | 9/29   | -                | 録音データ提出完了日を入力
2025年11月号 | A-3    | メイン文字起こし           | 録音データ      | 9/29     | 9/30     | -      | -                |
2025年11月号 | A-14   | 表紙確認送付              | -              | 10/5     | 10/5     | 10/5   | 確認待ち          |
2025年12月号 | S-1    | ゆめマガ12月号企画決定     | -              | 10/21    | -        | -      | -                | 事前準備
```

---

### 2. ガントシート（月号ごと・参照専用）

#### シート名パターン
- `逆算配置_ガント_2025年11月号`
- `逆算配置_ガント_2025年12月号`
- `逆算配置_ガント_2026年1月号`
- ...（月号ごとに増える）

#### 構造（変更なし）

| 列 | 内容 |
|----|------|
| A | 工程（工程No + 工程名） |
| B | レイヤー |
| C | 配置理由 |
| D〜 | 日付列（各日付にセル値 = 実施日） |

#### 役割
- Phase4逆算スケジューラーによる自動生成
- **逆算予定日**の抽出元
- ダッシュボード下部のガントチャート表示用

---

## 🔄 データフロー

```
【マスターデータ】
  ├─ 設定マスター ──────→ 月号設定（対象年・月・期間）
  ├─ 拡張工程マスター ───→ 工程詳細（必要データ、カテゴリなど）
  ├─ 新依存関係マスター ─→ 工程間の依存関係
  └─ その他マスター

           ↓

【Phase4逆算スケジューラー】
  スケジュール自動計算

           ↓

【ガントシート（月号ごと）】
  逆算配置_ガント_○月号

           ↓（自動抽出）

【進捗入力シート】
  月号 | 工程No | ... | 逆算予定日 | 入力予定日 | 実績日 | 先方確認ステータス

           ↓（参照・更新）

【ダッシュボード】
  ┌─ 上部: 進捗管理（進捗入力シート参照）
  │   ├─ 進捗サマリー
  │   ├─ カテゴリ別予実管理
  │   ├─ データ提出進捗
  │   └─ 先方確認ステータス
  │
  └─ 下部: ガントチャート（ガントシート参照）
      └─ 全工程の予定表示
```

---

## 🎯 ダッシュボードとの連携

### 上部（進捗管理エリア）

**データソース**: 進捗入力シート

#### 1. 進捗サマリー
- 完了数 = `実績日`が入力されている件数
- 進行中 = `入力予定日 ≤ 今日 < 実績日`の件数
- 未着手 = `入力予定日 > 今日`の件数
- 遅延 = `入力予定日 < 今日 かつ 実績日が空白`の件数

#### 2. カテゴリ別予実管理
- 工程Noのプレフィックス（A, K, H, I, L, M）でグループ化
- 各カテゴリの進捗率を計算
- 先方確認ステータスを表示・更新

#### 3. データ提出進捗
- `必要データ`列から提出物を抽出
- カテゴリ別に必須データの提出状況を表示
- 未提出 + 期限超過 = アラート

#### 4. 工程詳細（展開時）
- 各工程の予定日・実績日を表示
- 実績日入力フィールド
- 先方確認ステータス更新ドロップダウン

### 下部（ガントチャートエリア）

**データソース**: ガントシート

- 選択中の月号のガントシートを表示
- 日付 × 工程のマトリクス表示
- セルに値がある = その日に実施予定

---

## 🔧 実装時の注意点

### 1. 逆算予定日の自動取得

**処理フロー**:
1. 設定マスターから対象月号を取得（例: `2025年11月号`）
2. 対応するガントシート名を構築（`逆算配置_ガント_2025年11月号`）
3. ガントシートから各工程の実施日を抽出
4. 進捗入力シートの`逆算予定日`列を更新

**コード例**:
```typescript
// ガントシートから工程の実施日を抽出
const ganttData = await getSheetData(spreadsheetId, `逆算配置_ガント_${monthIssue}!A1:ZZ1000`);
const headers = ganttData[0]; // ['工程', 'レイヤー', '配置理由', '9/21', '9/22', ...]
const dateHeaders = headers.slice(3);

const processSchedule: Record<string, string> = {};
ganttData.slice(1).forEach(row => {
  const processName = row[0]; // "A-3 メイン文字起こし"
  const processNo = processName.split(' ')[0]; // "A-3"

  // この工程が実施される日付を抽出（最初の実施日を予定日とする）
  for (let i = 0; i < dateHeaders.length; i++) {
    if (row[i + 3]) { // セルに値がある = 実施日
      processSchedule[processNo] = dateHeaders[i];
      break;
    }
  }
});

// 進捗入力シートに反映
// (逆算予定日列を更新)
```

### 2. 月号の管理

**月号フォーマット**: `YYYY年MM月号`（例: `2025年11月号`）

**月号一覧の取得**:
```typescript
// ガントシート一覧から月号を抽出
const metadata = await getSpreadsheetMetadata(spreadsheetId);
const ganttSheets = metadata.sheets
  .filter(s => s.properties.title.includes('逆算配置_ガント'))
  .map(s => {
    const match = s.properties.title.match(/(\d+年\d+月号)/);
    return match ? match[1] : null;
  })
  .filter(Boolean);

// ['2025年11月号', '2025年12月号', ...]
```

### 3. 先方確認ステータスの更新

**API設計**:
```typescript
// PUT /api/process-schedule/confirmation
{
  monthIssue: '2025年11月号',
  processNo: 'A-14',
  status: '確認待ち' // 未送付 | 確認待ち | 確認OK | -
}
```

**Google Sheets更新**:
```typescript
import { updateSheetCell } from '@/lib/google-sheets';

// 該当行を特定して更新
const rowIndex = findRowByProcessNo(progressData, processNo);
const columnIndex = headers.indexOf('先方確認ステータス');
await updateSheetCell(
  spreadsheetId,
  '進捗入力シート',
  rowIndex,
  columnIndex,
  status
);
```

---

## 📝 次のステップ

### Phase 1: データ構造の準備
- [ ] 進捗入力シートに`月号`列を追加
- [ ] `逆算予定日`列を追加（自動計算用）
- [ ] `入力予定日`列を追加（ユーザー調整用）
- [ ] `先方確認ステータス`列を追加

### Phase 2: APIの実装
- [ ] 逆算予定日の自動取得API
- [ ] 月号一覧取得API
- [ ] 進捗データ取得API（月号フィルタ付き）
- [ ] 実績日更新API
- [ ] 先方確認ステータス更新API

### Phase 3: ダッシュボードの実装
- [ ] 月号選択UI
- [ ] 進捗サマリー表示
- [ ] カテゴリ別予実管理カード
- [ ] データ提出進捗管理
- [ ] ガントチャート表示（月号切り替え対応）

---

**最終更新**: 2025-10-07
