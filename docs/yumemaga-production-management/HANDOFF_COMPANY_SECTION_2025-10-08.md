# 企業セクション実装 - 引き継ぎドキュメント

**作成日**: 2025-10-08
**作成者**: Claude Code
**対象**: 次世代実装者
**完成度**: 50%（基本実装完了、残り50%はデータ整備・改善）

---

## 📊 実装サマリー

### ✅ 完了した内容

1. **企業別工程管理API作成** (`/api/yumemaga-v2/company-processes`)
2. **企業カードコンポーネント作成** (`CompanyCard.tsx`)
3. **企業管理セクションコンポーネント作成** (`CompanyManagementSection.tsx`)
4. **メインページへの統合** (`page.tsx`)
5. **設計ドキュメント作成** (`COMPANY_PROCESS_ANALYSIS.md`, `COMPANY_PROCESS_MAPPING.md`)

### ⏳ 未完了・要改善事項（残り50%）

1. **企業マスターのデータ整備** - 初掲載号・最終更新号の設定
2. **企業ステータス判定ロジックの改善** - 前号判定の実装
3. **工程データの紐付け確認** - カテゴリC/Eの工程が正しく取得されるか
4. **遅延判定・準備OK判定の統合** - 企業工程にも適用
5. **確認送付ステータス管理** - Phase 3の確認ステータスを企業工程にも適用

---

## 🗂️ 作成したファイル

### API
```
app/api/yumemaga-v2/company-processes/route.ts
```

### コンポーネント
```
components/company-management/CompanyCard.tsx
components/company-management/CompanyManagementSection.tsx
```

### ドキュメント
```
docs/yumemaga-production-management/COMPANY_PROCESS_ANALYSIS.md
docs/yumemaga-production-management/COMPANY_PROCESS_MAPPING.md
```

---

## 🚨 重要: データ整備が必要

現在、企業セクションにデータが表示されない可能性があります。理由は以下の通り:

### 問題1: 企業マスターの「初掲載号」「最終更新号」が未設定

企業マスター（スプレッドシート）の以下の列にデータが必要です:

| 列番号 | 列名 | 必要なデータ | 例 |
|-------|------|------------|-----|
| 48列目（AV列） | 初掲載号 | `2025年11月号` など | `2025年10月号` |
| 49列目（AW列） | 最終更新号 | `2025年11月号` など | `2025年11月号` |
| 50列目（AX列） | ステータス | `active` | `active` |

#### 修正手順

1. **Google Sheetsで企業マスターを開く**
2. **AV列（初掲載号）を確認**
   - 6社すべてに初掲載号を入力
   - フォーマット: `2024年10月号`, `2025年11月号` など
3. **AW列（最終更新号）を確認**
   - 今号（例: `2025年11月号`）に掲載する企業は、最終更新号を `2025年11月号` に設定
4. **AX列（ステータス）を確認**
   - すべて `active` に設定

#### データ例（マルトモの場合）

| 企業ID | 企業名 | ... | 初掲載号（AV列） | 最終更新号（AW列） | ステータス（AX列） |
|-------|--------|-----|---------------|---------------|----------------|
| marutomo | 株式会社マルトモ | ... | 2024年10月号 | 2025年11月号 | active |

→ この場合、マルトモは「既存企業（変更）」として判定されます

---

## 🔧 企業ステータスの判定ロジック

現在実装されている判定ロジック:

```typescript
function getCompanyStatus(company, currentIssue) {
  // 初掲載号が今号 → 新規企業
  if (company.firstIssue === currentIssue) {
    return { status: 'new', processCategoryId: 'C' };
  }

  // 最終更新号が今号 → 既存企業（変更）
  if (company.lastIssue === currentIssue) {
    return { status: 'updated', processCategoryId: 'E' };
  }

  // それ以外で最終更新号がある → 既存企業（継続）
  if (company.lastIssue) {
    return { status: 'existing', processCategoryId: 'E' };
  }

  return { status: 'none', processCategoryId: null };
}
```

### 改善が必要な点

**TODO**: 前号判定の実装

現在、「既存企業（継続）」の判定が不正確です。正しくは:

```typescript
// 最終更新号が前号 → 既存企業（継続）
const previousIssue = getPreviousIssue(currentIssue);
if (company.lastIssue === previousIssue) {
  return { status: 'existing', processCategoryId: 'E' };
}
```

`getPreviousIssue()` 関数を実装する必要があります。

---

## 📋 工程データの紐付け

### カテゴリC（新規企業）の工程

進捗入力シートに以下の工程が登録されている必要があります:

```
C-1: データ提出・撮影
C-2: 文字起こし
C-3: 内容整理
C-4: ページ制作
C-5: 内部チェック
C-6: 確認送付
C-7: 修正対応
```

### カテゴリE（既存企業）の工程

```
E-1: ページ確認
E-2: 追加撮影（任意）
E-3: ページ更新
E-4: 内部チェック
```

### 確認方法

進捗入力シートの**D列（月号）**が今号（例: `2025年11月号`）で、**A列（工程No）**が `C-` または `E-` で始まるデータがあるか確認してください。

---

## 🎨 UI/UX の仕様

### 企業カード

```
┌──────────────────────┐
│ 🏢 マルトモ [新規]    │
│                      │
│ 進捗: 45% (5/11工程) │
│ ステータス: 内部チェック │
│ ━━━━━━━━━━━━━━━━━━━ │
│ ● 完了: 3  ● 進行中: 1 │
│ ● 未着手: 7           │
│                      │
│ [工程を表示 ▼]       │
└──────────────────────┘
```

展開時:

```
┌──────────────────────┐
│ ◆ ヒアリング [完了]   │
│    予: 9/20 実: 9/20 │
│ ◆ 撮影 [完了]        │
│    予: 9/25 実: 9/26 │
│    ⚠️ 1日遅延        │
│ ◆ 内容整理 [進行中]   │
│    予: 10/1 実: -    │
│    [完了] [編集]     │
└──────────────────────┘
```

### セクション全体

```
┌─────────────────────────────────────┐
│ 🏢 企業紹介ページ管理                │
│                                     │
│ [総企業数: 6社] [新規: 3社] [変更: 2社] │
│ [継続: 1社] [平均進捗: 67%]          │
│                                     │
│ [全社展開] [全社折りたたみ] [更新] [▲] │
└─────────────────────────────────────┘

[マルトモカード] [あーきぺんこカード] [テクノシンエイカード]
[稲垣製作所カード] [一榮工業カード] [林工業所カード]
```

---

## 🧪 動作確認手順

### 1. 企業マスターのデータ確認

```bash
# スプレッドシートを開く
# 企業マスターシートのAV列（初掲載号）、AW列（最終更新号）を確認
```

### 2. 開発サーバー起動

```bash
npm run dev
```

### 3. ブラウザで確認

```
http://localhost:3000/dashboard/yumemaga-v2
```

### 4. 確認ポイント

- [ ] **企業紹介ページ管理セクション**が表示される
- [ ] **サマリー**に企業数が表示される（例: 総企業数: 6社）
- [ ] **企業カード**が表示される（6社分）
- [ ] 各企業に**ステータスバッジ**が表示される（新規/変更/継続）
- [ ] 企業カードをクリックで**展開/折りたたみ**できる
- [ ] 工程の**「完了」ボタン**で実績日が入力できる
- [ ] **「更新」ボタン**でデータが再取得される

### 5. デバッグ方法

企業が表示されない場合:

```bash
# ブラウザの開発者ツール（F12）→ Consoleタブを開く
# 以下のログを確認:

📊 企業マスター: X社取得
📅 ガントシート: X工程のスケジュール取得
✅ 企業別工程: X社の進捗を返却
```

- `企業マスター: 0社取得` → 企業マスターのステータスが `active` か確認
- `企業別工程: 0社の進捗を返却` → 初掲載号・最終更新号が設定されているか確認

---

## 🔄 次のステップ（残り50%の実装）

### Step 1: 企業マスターのデータ整備（最優先）

- [ ] 6社すべてに「初掲載号」「最終更新号」を設定
- [ ] ステータスを `active` に設定
- [ ] データ保存後、ブラウザで「更新」ボタンをクリック

### Step 2: 企業ステータス判定の改善

- [ ] `getPreviousIssue()` 関数を実装
- [ ] 「継続」判定ロジックを修正

### Step 3: 工程データの確認

- [ ] 進捗入力シートにC/E工程が登録されているか確認
- [ ] 月号が正しく設定されているか確認

### Step 4: 遅延判定・準備OK判定の統合

- [ ] 企業工程にも遅延バッジを表示
- [ ] 企業工程にも準備OKバッジを表示

### Step 5: 確認送付ステータス管理

- [ ] 企業工程にも確認送付ステータスを適用
- [ ] 「内部チェック」「確認送付」「修正対応」ステータスの管理

---

## 📚 参考ドキュメント

### 設計書
- `docs/yumemaga-production-management/COMPANY_PROCESS_ANALYSIS.md` - 現状分析と理想的なUI/UX設計
- `docs/yumemaga-production-management/COMPANY_PROCESS_MAPPING.md` - 企業別工程マッピング定義

### スキーマ定義
- `docs/yumemaga-production-management/COMPANY_MASTER_SCHEMA.md` - 企業マスター62列構造

### 調査結果
- `docs/yumemaga-production-management/COMPANY_MASTER_INVESTIGATION.md` - yumesutaHPとの対応調査

---

## ⚠️ 既知の問題・制約事項

### 問題1: 企業マスターの列番号が間違っている可能性

現在の実装では以下の列番号を使用していますが、**実際の企業マスターと異なる可能性**があります:

```typescript
firstIssue: row[47],  // AV列
lastIssue: row[48],   // AW列
status: row[49],      // AX列
```

**確認方法**: スプレッドシートで企業マスターを開き、実際の列番号を確認してください。

### 問題2: 工程名のクリーンナップが不完全

工程名から工程Noを除去する処理がありますが、すべての工程名に対応していない可能性があります:

```typescript
// "C-1 データ提出" → "データ提出"
const match = processName.match(/^[A-Z]-\d+\s+(.+)$/);
```

**対策**: 進捗入力シートの工程名フォーマットを統一してください。

### 問題3: 前号判定が未実装

現在、「継続」企業の判定が不正確です。`getPreviousIssue()` 関数を実装する必要があります。

---

## 💡 改善アイデア

### アイデア1: 企業別工程テンプレート

スプレッドシートに「企業別工程マスター」を作成し、企業ステータス（新規/変更/継続）ごとの標準工程を定義する。

### アイデア2: 逆算スケジュール自動生成

発行日から逆算して、企業ごとの予定日を自動生成する機能。

### アイデア3: yumesutaHPとの同期

企業マスターのデータをyumesutaHPの `company-data.ts` と同期する機能。

---

## ✅ 完成基準（残り50%完了時）

以下がすべて✅になったら完成:

- [ ] 企業マスターのデータ整備完了（6社すべて設定済み）
- [ ] 企業カードが正しく表示される（6社分）
- [ ] 企業ステータスが正しく判定される（新規/変更/継続）
- [ ] 工程データが正しく紐付けられる
- [ ] 実績日の入力・編集が動作する
- [ ] 遅延判定・準備OK判定が企業工程にも適用される
- [ ] 確認送付ステータスが企業工程にも適用される

---

## 🎯 最重要タスク

**今すぐやるべきこと（優先度順）**:

1. **企業マスターのデータ整備** - 初掲載号・最終更新号の設定（15分）
2. **ブラウザで動作確認** - 企業が表示されるか確認（5分）
3. **工程データの確認** - C/E工程が登録されているか確認（10分）
4. **前号判定の実装** - `getPreviousIssue()` 関数（30分）
5. **遅延・準備OK判定の統合** - 企業工程にも適用（1時間）

---

**作成者**: Claude Code
**最終更新**: 2025-10-08
**次回更新**: データ整備完了後
**完成予想**: データ整備後 + 4-6時間の実装で100%完成
