# データ提出機能 設計書

**作成日**: 2025-10-08
**目的**: データ提出機能の完全な設計仕様を定義
**対象**: 実装担当者、仕様確認

---

## 📖 目次

1. [概要](#概要)
2. [Google Driveディレクトリ構造](#google-driveディレクトリ構造)
3. [カテゴリ別データ要件](#カテゴリ別データ要件)
4. [UI/UX設計](#uiux設計)
5. [API設計](#api設計)
6. [実装優先度](#実装優先度)

---

## 1. 概要

### 1.1 基本コンセプト

**データ提出機能 = Google Drive連携 + ドラッグ&ドロップ + ファイル選択による効率化**

```
【従来の課題】
❌ どこにデータを保存すればいいかわからない
❌ ファイル命名規則がバラバラ
❌ データ提出状況が可視化されていない

【改善後】
✅ ドラッグ&ドロップで直感的にアップロード
✅ ファイル選択でも効率的に追加可能
✅ Google Drive上で自動的にディレクトリ構造を管理
✅ データ提出状況をリアルタイムで可視化
```

### 1.2 データ提出が必要なカテゴリ

| カテゴリ | 録音データ | 写真データ | 企画内容 | 情報シート | 特殊要件 |
|---------|----------|----------|---------|-----------|---------|
| **A** 表紙制作 | - | ✅ | - | - | - |
| **D** メインインタビューページ | ✅ | ✅ | - | - | - |
| **K** レジェンドインタビュー | ✅ | ✅ | - | - | - |
| **H** STAR① | ✅ | ✅ | - | - | スプレッドシート提出判定 |
| **I** STAR② | ✅ | ✅ | - | - | スプレッドシート提出判定 |
| **L** 愛知県立高等技術専門校 | ✅ | ✅ | ✅ | - | 年間計画あり |
| **M** @18コラボ企画 | ✅ | ✅ | ✅ | - | - |
| **C** 新規企業 | - | ✅ | - | ✅ | 企業マスター連動 |
| **E** 既存企業 | - | - | - | - | 変更時のみ（任意） |
| **P** パートナー一覧 | - | - | - | - | パートナーマスター連動 |

---

## 2. Google Driveディレクトリ構造

### 2.1 基本原則

1. **カテゴリがドライブの最上位ディレクトリ**
2. **掲載号ディレクトリ**: `YYYY_MM` 形式（例: `2025_11`）
   - UIでは `YYYY年MM月号` に変換表示
   - 年またぎ対応
3. **企業/パートナー系**: 掲載号の概念なし、企業/パートナーごとのディレクトリ
4. **メイン/サブ構造**: 企業・パートナー系はメインを優先参照

---

### 2.2 カテゴリ系（A, D, K, L, M）

**基本構造**:
```
📁 [カテゴリID]_カテゴリ名/
  ├─ 📁 録音データ/
  │   └─ 📁 [YYYY_MM]/
  │       └─ 📄 YYYYMMDD_内容説明.mp3
  │
  ├─ 📁 写真データ/
  │   └─ 📁 [YYYY_MM]/
  │       └─ 📄 写真ファイル群
  │
  └─ 📁 企画内容/（L, Mのみ）
      └─ 📁 [YYYY_MM]/
          └─ 📄 企画書.docx
```

**具体例（Dカテゴリ: メインインタビューページ）**:
```
📁 D_メインインタビューページ/
  ├─ 📁 録音データ/
  │   ├─ 📁 2025_11/
  │   │   └─ 📄 20251015_○○社長インタビュー.mp3
  │   └─ 📁 2025_12/
  │       └─ 📄 20251115_△△社長インタビュー.mp3
  │
  └─ 📁 写真データ/
      ├─ 📁 2025_11/
      │   ├─ 📄 IMG_001.jpg
      │   └─ 📄 IMG_002.jpg
      └─ 📁 2025_12/
          └─ 📄 IMG_003.jpg
```

---

### 2.3 STAR系（H, I）

**特殊要件**: スプレッドシートで提出判定、入力行数をUIに表示

```
📁 H_STAR①/
  ├─ 📁 インタビューデータ/
  │   └─ 📁 [YYYY_MM]/
  │       └─ 📄 該当スプレッドシート（Google Sheets形式）
  │
  ├─ 📁 録音データ/
  │   └─ 📁 [YYYY_MM]/
  │       └─ 📄 録音ファイル
  │
  └─ 📁 写真データ/
      └─ 📁 [YYYY_MM]/
          └─ 📄 写真ファイル群
```

**提出判定ロジック**:
1. スプレッドシートに新規入力があるか確認
2. 入力のある行数をカウント
3. UIに「提出済み（3件）」と表示

---

### 2.4 企画系（L: 愛知県立高等技術専門校）

**特殊要件**: 年間計画ディレクトリ

```
📁 L_愛知県立高等技術専門校/
  ├─ 📁 年間計画/
  │   └─ 📄 2025年度_年間計画書.xlsx
  │
  ├─ 📁 企画内容/
  │   └─ 📁 [YYYY_MM]/
  │       └─ 📄 企画書.docx
  │
  ├─ 📁 録音データ/
  │   └─ 📁 [YYYY_MM]/
  │       └─ 📄 録音ファイル
  │
  └─ 📁 写真データ/
      └─ 📁 [YYYY_MM]/
          └─ 📄 写真ファイル群
```

---

### 2.5 企業系（C: 新規企業）

**企業マスター連動**: 企業ごとのディレクトリ、掲載号の概念なし

```
📁 C_新規企業/
  ├─ 📁 [企業名1]/
  │   ├─ 📁 メイン/
  │   │   ├─ 📄 ロゴ画像.png
  │   │   ├─ 📄 ヒーロー画像.jpg
  │   │   ├─ 📄 QRコード.png
  │   │   ├─ 📄 代表者写真.jpg
  │   │   ├─ 📄 サービス写真.jpg
  │   │   ├─ 📄 社員写真.jpg
  │   │   └─ 📄 取り組み.jpg
  │   │
  │   ├─ 📁 サブ/
  │   │   └─ 📄 その他素材
  │   │
  │   └─ 📁 情報シート/
  │       └─ 📄 企業情報シート.xlsx
  │
  └─ 📁 [企業名2]/
      └─ （同様の構造）
```

**ディレクトリ管理**:
- **メイン**: 優先参照ディレクトリ（ロゴ、ヒーロー、QR、代表者、サービス、社員、取り組み）
- **サブ**: その他の素材
- **情報シート**: 企業情報シート

**ファイル種別判定**:
| ファイル種別 | 保存先 | 優先度 | 備考 |
|------------|--------|-------|------|
| ロゴ画像 | メイン | 高 | 正方形推奨 |
| ヒーロー画像 | メイン | 高 | 横長推奨 |
| QRコード | メイン | 中 | 正方形 |
| 代表者写真 | メイン | 高 | - |
| サービス写真 | メイン | 中 | - |
| 社員写真 | メイン | 中 | - |
| 取り組み | メイン | 中 | - |
| 情報シート | 情報シート | 高 | Excel形式 |
| その他 | サブ | 低 | - |

---

### 2.6 パートナー系（P: パートナー一覧）

**パートナーマスター連動**: パートナーごとのディレクトリ、掲載号の概念なし

```
📁 P_パートナー一覧/
  ├─ 📁 [パートナー名1]/
  │   ├─ 📁 メイン/
  │   │   ├─ 📄 ロゴ画像.png
  │   │   ├─ 📄 ヒーロー画像.jpg
  │   │   ├─ 📄 QRコード.png
  │   │   ├─ 📄 代表者写真.jpg
  │   │   ├─ 📄 サービス写真.jpg
  │   │   ├─ 📄 社員写真.jpg
  │   │   └─ 📄 取り組み.jpg
  │   │
  │   └─ 📁 サブ/
  │       └─ 📄 その他素材
  │
  └─ 📁 [パートナー名2]/
      └─ （同様の構造）
```

**企業系との違い**:
- 情報シートディレクトリなし（パートナーマスターで管理）
- その他は企業系と同じ構造

---

## 3. カテゴリ別データ要件

### 3.1 A（表紙制作）

| データ種別 | 必須/任意 | 保存先 | ファイル形式 |
|-----------|---------|--------|------------|
| 写真データ | 必須 | `A_表紙制作/写真データ/[YYYY_MM]/` | .jpg, .png, .raw |

**ワークフロー**:
```
A-2: データ提出・撮影（写真データ提出）
  ↓
A-4: 写真レタッチ（提出された写真を使用）
  ↓
A-5: 表紙用写真選定
  ↓
A-11: 表紙完成
```

---

### 3.2 D（メインインタビューページ）

| データ種別 | 必須/任意 | 保存先 | ファイル形式 |
|-----------|---------|--------|------------|
| 録音データ | 必須 | `D_メインインタビューページ/録音データ/[YYYY_MM]/` | .mp3, .wav, .m4a |
| 写真データ | 必須 | `D_メインインタビューページ/写真データ/[YYYY_MM]/` | .jpg, .png, .raw |

**ワークフロー**:
```
D-2: データ提出・撮影（録音データ+写真データ提出）
  ↓
D-3: 文字起こし（録音データ使用）
D-5: 写真レタッチ（写真データ使用）
  ↓
D-6: ページ制作（P4-5）
```

---

### 3.3 K（レジェンドインタビュー）

| データ種別 | 必須/任意 | 保存先 | ファイル形式 |
|-----------|---------|--------|------------|
| 録音データ | 必須 | `K_レジェンドインタビュー/録音データ/[YYYY_MM]/` | .mp3, .wav, .m4a |
| 写真データ | 必須 | `K_レジェンドインタビュー/写真データ/[YYYY_MM]/` | .jpg, .png, .raw |

---

### 3.4 H（STAR①）、I（STAR②）

| データ種別 | 必須/任意 | 保存先 | ファイル形式 |
|-----------|---------|--------|------------|
| インタビューデータ | 必須 | `H_STAR①/インタビューデータ/[YYYY_MM]/` | Google Sheets |
| 録音データ | 任意 | `H_STAR①/録音データ/[YYYY_MM]/` | .mp3, .wav, .m4a |
| 写真データ | 必須 | `H_STAR①/写真データ/[YYYY_MM]/` | .jpg, .png |

**特殊処理**:
- スプレッドシートに新規入力があるか確認
- 入力のある行数をカウント → UIに「提出済み（3件）」と表示

---

### 3.5 L（愛知県立高等技術専門校）

| データ種別 | 必須/任意 | 保存先 | ファイル形式 |
|-----------|---------|--------|------------|
| 年間計画 | 必須（初回） | `L_愛知県立高等技術専門校/年間計画/` | .xlsx, .pdf |
| 企画内容 | 必須 | `L_愛知県立高等技術専門校/企画内容/[YYYY_MM]/` | .docx, .pdf |
| 録音データ | 任意 | `L_愛知県立高等技術専門校/録音データ/[YYYY_MM]/` | .mp3, .wav, .m4a |
| 写真データ | 必須 | `L_愛知県立高等技術専門校/写真データ/[YYYY_MM]/` | .jpg, .png |

---

### 3.6 M（@18コラボ企画）

| データ種別 | 必須/任意 | 保存先 | ファイル形式 |
|-----------|---------|--------|------------|
| 企画内容 | 必須 | `M_@18コラボ企画/企画内容/[YYYY_MM]/` | .docx, .pdf |
| 録音データ | 任意 | `M_@18コラボ企画/録音データ/[YYYY_MM]/` | .mp3, .wav, .m4a |
| 写真データ | 必須 | `M_@18コラボ企画/写真データ/[YYYY_MM]/` | .jpg, .png |

---

### 3.7 C（新規企業）

| データ種別 | 必須/任意 | 保存先 | ファイル形式 |
|-----------|---------|--------|------------|
| ロゴ画像 | 必須 | `C_新規企業/[企業名]/メイン/` | .png, .svg |
| ヒーロー画像 | 必須 | `C_新規企業/[企業名]/メイン/` | .jpg, .png |
| QRコード | 必須 | `C_新規企業/[企業名]/メイン/` | .png |
| 代表者写真 | 必須 | `C_新規企業/[企業名]/メイン/` | .jpg, .png |
| サービス写真 | 任意 | `C_新規企業/[企業名]/メイン/` | .jpg, .png |
| 社員写真 | 任意 | `C_新規企業/[企業名]/メイン/` | .jpg, .png |
| 取り組み | 任意 | `C_新規企業/[企業名]/メイン/` | .jpg, .png |
| 情報シート | 必須 | `C_新規企業/[企業名]/情報シート/` | .xlsx |
| その他素材 | 任意 | `C_新規企業/[企業名]/サブ/` | 任意 |

---

### 3.8 P（パートナー一覧）

| データ種別 | 必須/任意 | 保存先 | ファイル形式 |
|-----------|---------|--------|------------|
| ロゴ画像 | 必須 | `P_パートナー一覧/[パートナー名]/メイン/` | .png, .svg |
| ヒーロー画像 | 必須 | `P_パートナー一覧/[パートナー名]/メイン/` | .jpg, .png |
| QRコード | 必須 | `P_パートナー一覧/[パートナー名]/メイン/` | .png |
| 代表者写真 | 必須 | `P_パートナー一覧/[パートナー名]/メイン/` | .jpg, .png |
| その他素材 | 任意 | `P_パートナー一覧/[パートナー名]/サブ/` | 任意 |

---

## 4. UI/UX設計

### 4.1 データ提出セクション（全体レイアウト）

```
┌─────────────────────────────────────────────────┐
│ 📤 データ提出状況                                │
│                                                 │
│ 掲載号: [2025年11月号 ▼]                        │
│                                                 │
│ ┌─────────────────────────────────────────────┐ │
│ │ 📁 A: 表紙制作                               │ │
│ │                                              │ │
│ │ 写真データ: ⚠️ 未提出（期限: 10/15）          │ │
│ │ [ファイルを選択] [ドラッグ&ドロップ]          │ │
│ │                                              │ │
│ │ [Driveフォルダを開く]                        │ │
│ └─────────────────────────────────────────────┘ │
│                                                 │
│ ┌─────────────────────────────────────────────┐ │
│ │ 📁 D: メインインタビューページ                │ │
│ │                                              │ │
│ │ ✅ 録音データ: 提出済み                       │ │
│ │    └─ 📄 20251015_○○社長.mp3 (10/15 14:30) │ │
│ │                                              │ │
│ │ ✅ 写真データ: 提出済み（3件）                │ │
│ │    ├─ 📷 IMG_001.jpg (10/15 15:00)          │ │
│ │    ├─ 📷 IMG_002.jpg (10/15 15:01)          │ │
│ │    └─ 📷 IMG_003.jpg (10/15 15:02)          │ │
│ │                                              │ │
│ │ [Driveフォルダを開く]                        │ │
│ └─────────────────────────────────────────────┘ │
│                                                 │
│ ┌─────────────────────────────────────────────┐ │
│ │ 📁 C: 新規企業                               │ │
│ │                                              │ │
│ │ 企業: [マルトモ ▼]                           │ │
│ │                                              │ │
│ │ メインディレクトリ:                           │ │
│ │ ✅ ロゴ画像: logo.png (10/10 10:00)          │ │
│ │ ✅ ヒーロー画像: hero.jpg (10/10 10:05)      │ │
│ │ ⚠️ QRコード: 未提出                          │ │
│ │ ✅ 代表者写真: ceo.jpg (10/10 10:10)         │ │
│ │                                              │ │
│ │ [ファイルを選択] [ドラッグ&ドロップ]          │ │
│ │ [Driveフォルダを開く]                        │ │
│ └─────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────┘
```

---

### 4.2 ドラッグ&ドロップ機能

**動作仕様**:
1. ユーザーがファイルをドラッグ&ドロップ
2. ファイル種別を自動判定（拡張子・ファイル名から）
3. 適切なディレクトリに自動配置
4. アップロード完了後、UIをリアルタイム更新

**ドロップゾーン**:
```
┌─────────────────────────────────────────────┐
│                                             │
│      📁 ここにファイルをドロップ             │
│                                             │
│   または [ファイルを選択] をクリック         │
│                                             │
└─────────────────────────────────────────────┘
```

**ドロップ時の処理**:
```typescript
interface DropZoneProps {
  categoryId: string;
  dataType: 'recording' | 'photo' | 'planning' | 'info_sheet';
  issue: string; // "2025_11"
  companyName?: string; // 企業系の場合のみ
}

function handleDrop(files: File[], props: DropZoneProps) {
  // 1. ファイル種別判定
  const fileType = detectFileType(files[0]);

  // 2. アップロード先ディレクトリ決定
  const targetPath = buildPath(props);

  // 3. Google Driveにアップロード
  await uploadToDrive(files, targetPath);

  // 4. UIを更新
  refreshDataSubmissionStatus();
}
```

---

### 4.3 ファイル選択機能

**動作仕様**:
1. 「ファイルを選択」ボタンをクリック
2. OS標準のファイル選択ダイアログを表示
3. 複数ファイルの同時選択可能
4. 選択後、自動的にアップロード開始

**実装例**:
```tsx
<input
  type="file"
  multiple
  accept=".mp3,.wav,.m4a,.jpg,.png,.xlsx"
  onChange={(e) => handleFileSelect(e.target.files)}
  style={{ display: 'none' }}
  ref={fileInputRef}
/>

<button onClick={() => fileInputRef.current?.click()}>
  📁 ファイルを選択
</button>
```

---

### 4.4 企業/パートナー選択UI

**企業選択（Cカテゴリ）**:
```
┌─────────────────────────────────────────────┐
│ 📁 C: 新規企業                               │
│                                             │
│ 企業を選択: [マルトモ ▼]                     │
│             ├─ マルトモ                      │
│             ├─ あーきぺんこ                  │
│             ├─ テクノシンエイ               │
│             ├─ 稲垣一栄                      │
│             └─ その他...                    │
│                                             │
│ メインディレクトリ:                          │
│ ✅ ロゴ画像: logo.png                        │
│ ✅ ヒーロー画像: hero.jpg                    │
│ ⚠️ QRコード: 未提出                          │
│                                             │
│ [ファイルを選択] [ドラッグ&ドロップ]         │
└─────────────────────────────────────────────┘
```

**パートナー選択（Pカテゴリ）**:
```
┌─────────────────────────────────────────────┐
│ 📁 P: パートナー一覧                         │
│                                             │
│ パートナーを選択: [パートナーA ▼]            │
│                  ├─ パートナーA             │
│                  ├─ パートナーB             │
│                  └─ パートナーC             │
│                                             │
│ メインディレクトリ:                          │
│ ✅ ロゴ画像: logo.png                        │
│ ✅ ヒーロー画像: hero.jpg                    │
│                                             │
│ [ファイルを選択] [ドラッグ&ドロップ]         │
└─────────────────────────────────────────────┘
```

---

### 4.5 提出状況の可視化

**ステータス表示**:
```typescript
type SubmissionStatus = 'submitted' | 'pending' | 'overdue';

interface DataSubmissionItem {
  dataType: string;
  status: SubmissionStatus;
  files: FileInfo[];
  deadline?: string;
  daysLate?: number;
}
```

**表示パターン**:
```
✅ 録音データ: 提出済み
   └─ 📄 20251015_interview.mp3 (10/15 14:30)

⚠️ 写真データ: 未提出（期限: 10/15）
   └─ 期限超過 2日

📋 企画内容: 任意（未提出）
```

---

## 5. API設計

### 5.1 データ提出状況取得API

**エンドポイント**: `GET /api/yumemaga-v2/data-submission?issue=2025_11`

**レスポンス**:
```typescript
{
  success: true,
  data: {
    issue: "2025_11",
    categories: [
      {
        categoryId: "A",
        categoryName: "表紙制作",
        dataTypes: [
          {
            dataType: "photo",
            dataTypeName: "写真データ",
            status: "pending",
            required: true,
            deadline: "2025-10-15",
            daysLate: 2,
            files: []
          }
        ]
      },
      {
        categoryId: "D",
        categoryName: "メインインタビューページ",
        dataTypes: [
          {
            dataType: "recording",
            dataTypeName: "録音データ",
            status: "submitted",
            required: true,
            files: [
              {
                fileName: "20251015_interview.mp3",
                fileSize: 15728640,
                uploadedAt: "2025-10-15T14:30:00Z",
                driveFileId: "1a2b3c4d5e6f",
                driveUrl: "https://drive.google.com/file/d/1a2b3c4d5e6f"
              }
            ]
          },
          {
            dataType: "photo",
            dataTypeName: "写真データ",
            status: "submitted",
            required: true,
            files: [
              {
                fileName: "IMG_001.jpg",
                fileSize: 2097152,
                uploadedAt: "2025-10-15T15:00:00Z",
                driveFileId: "2b3c4d5e6f7g",
                driveUrl: "https://drive.google.com/file/d/2b3c4d5e6f7g"
              }
            ]
          }
        ]
      }
    ]
  }
}
```

---

### 5.2 ファイルアップロードAPI

**エンドポイント**: `POST /api/yumemaga-v2/data-submission/upload`

**リクエスト**:
```typescript
{
  categoryId: "D",
  dataType: "recording",
  issue: "2025_11",
  companyName?: "マルトモ", // 企業系の場合のみ
  files: [File, File, ...] // multipart/form-data
}
```

**レスポンス**:
```typescript
{
  success: true,
  data: {
    uploadedFiles: [
      {
        fileName: "20251015_interview.mp3",
        driveFileId: "1a2b3c4d5e6f",
        driveUrl: "https://drive.google.com/file/d/1a2b3c4d5e6f"
      }
    ]
  }
}
```

---

### 5.3 Google Drive連携

**使用ライブラリ**: `lib/google-drive.ts`

**主要関数**:
```typescript
// フォルダ作成
async function createFolder(parentFolderId: string, folderName: string): Promise<string>

// ファイルアップロード
async function uploadFile(folderId: string, file: File): Promise<DriveFile>

// ファイル一覧取得
async function listFilesInFolder(folderId: string): Promise<DriveFile[]>

// ディレクトリパス解決（存在しなければ作成）
async function ensureDirectory(path: string[]): Promise<string>
```

**ディレクトリパス解決例**:
```typescript
// カテゴリ系
const path = ['D_メインインタビューページ', '録音データ', '2025_11'];
const folderId = await ensureDirectory(path);

// 企業系
const path = ['C_新規企業', 'マルトモ', 'メイン'];
const folderId = await ensureDirectory(path);
```

---

## 6. 実装優先度

### Phase 1: 基本機能（最優先）

**工数**: 8時間

- [x] カテゴリ系（A, D, K）のデータ提出UI
- [x] ドラッグ&ドロップ機能
- [x] ファイル選択機能
- [x] Google Driveへのアップロード
- [x] データ提出状況の可視化

---

### Phase 2: 企業/パートナー系（高優先）

**工数**: 6時間

- [ ] 企業マスター連動
- [ ] パートナーマスター連動
- [ ] メイン/サブディレクトリ管理
- [ ] ファイル種別自動判定

---

### Phase 3: STAR系・企画系（中優先）

**工数**: 4時間

- [ ] STARスプレッドシート連動
- [ ] 入力行数カウント
- [ ] 年間計画ディレクトリ（L系）

---

### Phase 4: 最適化（低優先）

**工数**: 4時間

- [ ] アップロード進捗表示
- [ ] エラーハンドリング強化
- [ ] ファイルプレビュー機能
- [ ] 一括ダウンロード機能

---

## 7. 成功基準

### 7.1 機能的成功基準

- [ ] すべてのカテゴリでドラッグ&ドロップが動作
- [ ] ファイル選択でも同様にアップロード可能
- [ ] Google Driveに正しいディレクトリ構造で保存される
- [ ] データ提出状況がリアルタイムで更新される
- [ ] 期限超過データが赤色アラートで表示される

### 7.2 ユーザビリティ成功基準

- [ ] ドラッグ&ドロップの動作が直感的
- [ ] アップロード完了まで30秒以内（5MBファイル）
- [ ] エラー時のメッセージが明確
- [ ] モバイルでも操作可能

### 7.3 技術的成功基準

- [ ] Google Drive APIの制限内で動作
- [ ] 同時アップロードに対応
- [ ] ファイル名の重複を適切に処理
- [ ] セキュリティ要件を満たす（認証・認可）

---

## 8. 次のステップ

1. **Phase 1実装開始**: カテゴリ系データ提出UI
2. **Google Drive連携テスト**: ディレクトリ作成・ファイルアップロード
3. **ユーザーテスト**: 実際のデータで動作確認
4. **Phase 2以降の実装**: 企業/パートナー系、STAR系

---

**作成者**: Claude Code
**最終更新**: 2025-10-08
**次回更新**: Phase 1実装完了後
