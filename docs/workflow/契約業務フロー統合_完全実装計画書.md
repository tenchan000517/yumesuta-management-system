# 契約業務フロー統合 - 完全実装計画書

**作成日**: 2025年10月11日
**作成者**: Claude Code
**目的**: 契約業務フロー統合 Phase 1（MVP）の完全な実装計画
**バージョン**: v1.0

---

## 📋 目次

1. [プロジェクト概要](#プロジェクト概要)
2. [システム設計](#システム設計)
3. [技術仕様](#技術仕様)
4. [データフロー設計](#データフロー設計)
5. [UI/UX設計](#uiux設計)
6. [API設計](#api設計)
7. [コンポーネント設計](#コンポーネント設計)
8. [型定義](#型定義)
9. [静的データ設計](#静的データ設計)
10. [実装スケジュール](#実装スケジュール)
11. [テスト計画](#テスト計画)
12. [Phase 2以降への拡張](#phase-2以降への拡張)

---

## プロジェクト概要

### 目的

**基本KGI**: 「工程ごとにカードになっていて、一個一個丁寧にアシスト（メール文など）がガイドされ、実行していけるようになっている」

- **ミスがゼロ**: メール例文のコピペ、チェックリストの活用
- **ギャップがゼロ**: マニュアルの可視化、手順の明示
- **安全な業務遂行**: 組織として標準化された手順

### Phase 1（MVP）の実装範囲

#### ✅ 実装する機能

**UI機能**:
- プログレスバー（スクロール追従・半透明背景）
- 5カラムカードグリッド（レスポンシブ対応: PC 5列、タブレット 3列、モバイル 2列）
- Notion風サイドパネル（右からスライドイン・300msアニメーション）
- カードの状態別スタイル（完了・進行中・未着手）

**インタラクション機能**:
- カードクリックでサイドパネル展開
- チェックリスト機能（LocalStorage保存）
- メール例文モーダル表示＋コピー機能
- 外部リンクボタン（原本URL、マネーフォワード等）
- 手動更新ボタン

**データ連動（読み取りのみ）**:
- 契約・入金管理シートのデータ取得・表示
- テーブル形式での一覧表示

**静的データ**:
- 13ステップの詳細情報（`/data/contract-workflow.ts`）
- メール例文（`/data/email-templates.ts`）
- LocalStorageでの進捗状態保存

#### ❌ Phase 2以降に延期

- スプレッドシートへの書き込み（日付記録等）
- Google Driveへのファイルアップロード
- Google Driveファイル一覧の取得・表示
- 入力フォームからのスプレッドシート更新
- 自動リマインダー機能
- 複数契約の同時管理

---

## システム設計

### アーキテクチャ概要

```
ユーザー操作（ブラウザ）
  ↓
Next.js 15 App Router（Client Component）
  ↓
API Routes（/api/contract/list）
  ↓
Google Sheets API（lib/google-sheets.ts）
  ↓
営業予実管理スプレッドシート（契約・入金管理シート）
```

### データフロー

**初回マウント時**:
```
ページマウント
  ↓
useEffect実行
  ↓
fetch('/api/contract/list')  # 契約・入金管理データ取得
  ↓
データ整形・State更新
  ↓
LocalStorageから進捗状態を復元
  ↓
画面表示
```

**手動更新時**:
```
更新ボタンクリック
  ↓
setLoading(true)
  ↓
fetch('/api/contract/list')
  ↓
データ整形・State更新
  ↓
setLoading(false)
  ↓
最終更新時刻を表示
```

**カードクリック時**:
```
カードクリック
  ↓
setSelectedStep(stepNumber)
  ↓
サイドパネル展開（300msアニメーション）
  ↓
ステップ詳細表示
```

**チェックリスト更新時**:
```
チェックボックスクリック
  ↓
State更新
  ↓
LocalStorageに保存
  {
    workflow_contract_state: {
      stepStatuses: { 1: 'completed', 4: 'in_progress', ... },
      checklists: { 's1-c1': true, 's1-c2': false, ... }
    }
  }
```

---

## 技術仕様

### 技術スタック

**フロントエンド**:
- フレームワーク: Next.js 15 (App Router)
- 言語: TypeScript
- スタイリング: Tailwind CSS v4
- アイコン: lucide-react
- 状態管理: React useState + LocalStorage

**バックエンド**:
- API: Next.js API Routes
- データソース: Google Sheets
- 認証: Google Service Account
- ライブラリ: googleapis

### 環境変数

**必須**:
```bash
GOOGLE_SERVICE_ACCOUNT_KEY=<JSON形式のサービスアカウント認証情報>
SALES_SPREADSHEET_ID=13PzSnGekGxDWX7B1_TwczNibR6j_JxDb3UuquPX1GyQ
```

### ディレクトリ構造

```
/app/dashboard/workflow/contract/
  └─ page.tsx                          # メインページ

/components/workflow/
  ├─ ProgressBar.tsx                   # プログレスバー
  ├─ StepCard.tsx                      # ステップカード
  ├─ SidePanel.tsx                     # サイドパネル
  ├─ EmailModal.tsx                    # メール例文モーダル
  └─ ContractTable.tsx                 # 契約・入金管理テーブル

/types/
  └─ workflow.ts                       # 業務フロー関連の型定義

/data/
  ├─ contract-workflow.ts              # 13ステップの詳細データ
  └─ email-templates.ts                # メール例文データ

/lib/
  └─ workflow-storage.ts               # LocalStorage管理

/app/api/contract/
  └─ list/route.ts                     # 契約一覧取得API
```

---

## データフロー設計

### 契約・入金管理シートの構造

**スプレッドシートID**: `13PzSnGekGxDWX7B1_TwczNibR6j_JxDb3UuquPX1GyQ`
**シート名**: `契約・入金管理`
**シートID**: `791125447`

#### ヘッダー構造（全16項目）

| 列 | 項目名 | データ型 | 必須 | 説明 | 業務フローステップ対応 |
|----|--------|---------|------|------|---------------------|
| A | ID | 数値 | ✅ | 契約ID（連番） | - |
| B | 企業名 | 文字列 | ✅ | 契約企業名 | ステップ① 情報収集 |
| C | 契約サービス | 文字列 | ✅ | サービス名（例: ゆめマガ） | ステップ① 情報収集 |
| D | 契約日 | 日付 | - | 契約成立日（YYYY/MM/DD形式） | ステップ⑦ 契約完了確認 |
| E | 契約金額 | 金額 | ✅ | 契約金額（税込、¥表記あり） | ステップ① 情報収集 |
| F | 入金方法 | 文字列 | ✅ | 一括 / 分割 | ステップ① 情報収集 |
| G | 契約書送付 | 日付 | - | 基本契約書送付日（YYYY/MM/DD形式） | ステップ③ 基本契約書の押印・送信 |
| H | 契約書回収 | 日付 | - | 基本契約書回収日（YYYY/MM/DD形式） | ステップ⑦ 契約完了確認 |
| I | 申込書送付 | 日付 | - | 申込書送付日（YYYY/MM/DD形式） | ステップ⑤ 申込書の押印・送信 |
| J | 申込書回収 | 日付 | - | 申込書回収日（YYYY/MM/DD形式） | ステップ⑦ 契約完了確認 |
| K | 入金予定日 | 日付 | ✅ | 入金予定日（YYYY/MM/DD形式） | ステップ⑧ 請求書作成・送付 |
| L | 入金実績日 | 日付 | - | 実際の入金日（YYYY/MM/DD形式） | ステップ⑨ 入金確認 |
| M | 入金ステータス | 文字列 | ✅ | 未入金 / 入金済 | ステップ⑨ 入金確認 |
| N | 遅延日数 | 数値 | - | 入金遅延日数（自動計算） | - |
| O | 掲載開始号 | 文字列 | ✅ | 掲載開始号（例: 2025年12月号） | ステップ⑬ 掲載 |
| P | 備考 | 文字列 | - | 備考欄 | - |

#### データ形式の詳細

**日付フィールド（D, G, H, I, J, K, L列）**:
- 形式: `YYYY/MM/DD`（例: `2025/10/09`）
- 空欄の扱い: 空文字列（`""`）または`undefined`
- APIから取得: 文字列として取得される

**金額フィールド（E列）**:
- 形式: `¥XXX,XXX`（例: `¥744,000`）
- 表示: カンマ区切り、円記号付き
- APIから取得: `¥`記号とカンマが含まれる文字列

**文字列フィールド（B, C, F, M, O, P列）**:
- 形式: プレーンテキスト
- 空欄の扱い: 空文字列（`""`）または`undefined`

**入金ステータス（M列）の値**:
- `未入金`: 入金実績日（L列）が空欄の場合
- `入金済`: 入金実績日（L列）に日付が入っている場合

---

## UI/UX設計

### 全体レイアウト

```
┌──────────────────────────────────────────────────────────────┐
│ 🔝 プログレスバー（固定・半透明・スクロール追従）              │
│ ●━━━●━━━●━━━○━━━○                                          │
│ ① 情報 ③ 契約 ⑦ 完了 ⑨ 入金 ⑬ 掲載                        │
├──────────────────────────────────────────────────────────────┤
│ 戻るボタン                                   更新ボタン       │
│                                                              │
│ 契約業務フロー（13ステップ）                                  │
│                                                              │
├──────────────────────────────────────────────────────────────┤
│ メインエリア（フル幅）                                        │
│                                                              │
│ 📊 5カラムカードグリッド:                                     │
│ ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐              │
│ │ ✅  │ │ ✅  │ │ ✅  │ │ 🔵  │ │ ⬜  │              │
│ │ ①  │ │ ②  │ │ ③  │ │ ④  │ │ ⑤  │              │
│ │情報 │ │契約 │ │押印 │ │申込 │ │押印 │              │
│ │収集 │ │書作成│ │送信 │ │書作成│ │送信 │              │
│ └─────┘ └─────┘ └─────┘ └─────┘ └─────┘              │
│ ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐              │
│ │ ⬜  │ │ ⬜  │ │ ⬜  │ │ ⬜  │ │ ⬜  │              │
│ │ ⑥  │ │ ⑦  │ │ ⑧  │ │ ⑨  │ │ ⑩  │              │
│ │重要 │ │契約 │ │請求 │ │入金 │ │入金 │              │
│ │説明 │ │完了 │ │書  │ │確認 │ │更新 │              │
│ └─────┘ └─────┘ └─────┘ └─────┘ └─────┘              │
│ ┌─────┐ ┌─────┐ ┌─────┐                                │
│ │ ⬜  │ │ ⬜  │ │ ⬜  │                                │
│ │ ⑪  │ │ ⑫  │ │ ⑬  │                                │
│ │原稿 │ │制作 │ │掲載 │                                │
│ │依頼 │ │校正 │ │    │                                │
│ └─────┘ └─────┘ └─────┘                                │
│                                                              │
│ 📊 下部: スプレッドシート連動エリア                           │
│ ┌────────────────────────────────────────────────────┐       │
│ │ 契約・入金管理（テーブル表示）                      │       │
│ └────────────────────────────────────────────────────┘       │
└──────────────────────────────────────────────────────────────┘
```

### カラースキーム

**ステータスカラー**:
```typescript
// ステップカード
'bg-green-50 border-green-200'  // 完了
'bg-blue-50 border-blue-500'    // 進行中
'bg-gray-50 border-gray-200'    // 未着手

// テキストカラー
'text-green-600'  // 完了
'text-blue-600'   // 進行中
'text-gray-500'   // 未着手

// バッジ
'bg-green-100 text-green-800'  // 入金済
'bg-yellow-100 text-yellow-800' // 未入金
```

### レスポンシブデザイン

**カードグリッド**:
```typescript
<div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
  {/* PC: 5カラム、タブレット: 3カラム、モバイル: 2カラム */}
</div>
```

---

## API設計

### `/api/contract/list`

**メソッド**: `GET`

**機能**: 契約・入金管理シートのデータを取得

**実装ファイル**: `/app/api/contract/list/route.ts`

#### レスポンス形式

```typescript
{
  success: boolean;
  data?: ContractData[];
  error?: string;
}
```

#### `ContractData`型定義

```typescript
export interface ContractData {
  id: number;                      // A列
  companyName: string;             // B列
  contractService: string;         // C列
  contractDate: string;            // D列（YYYY/MM/DD形式）
  amount: string;                  // E列（¥XXX,XXX形式）
  paymentMethod: string;           // F列
  contractSentDate?: string;       // G列
  contractReceivedDate?: string;   // H列
  applicationSentDate?: string;    // I列
  applicationReceivedDate?: string;// J列
  paymentDueDate: string;          // K列
  paymentActualDate?: string;      // L列
  paymentStatus: string;           // M列
  delayDays?: number;              // N列
  publicationIssue: string;        // O列
  notes?: string;                  // P列
}
```

#### 実装例

```typescript
// /app/api/contract/list/route.ts
import { NextResponse } from 'next/server';
import { getSheetData } from '@/lib/google-sheets';
import type { ContractData } from '@/types/workflow';

export async function GET() {
  try {
    const spreadsheetId = process.env.SALES_SPREADSHEET_ID!;
    const sheetName = '契約・入金管理';

    // Google Sheetsから全データ取得
    const rawData = await getSheetData(
      spreadsheetId,
      `${sheetName}!A:P`
    );

    // データパース
    const contracts = parseContractData(rawData);

    return NextResponse.json({
      success: true,
      data: contracts
    });
  } catch (error) {
    console.error('契約データ取得エラー:', error);
    return NextResponse.json(
      {
        success: false,
        error: error instanceof Error ? error.message : '不明なエラー'
      },
      { status: 500 }
    );
  }
}

function parseContractData(rows: any[][]): ContractData[] {
  const data: ContractData[] = [];

  // 1行目（ヘッダー）をスキップ
  for (let i = 1; i < rows.length; i++) {
    const row = rows[i];

    // 空行をスキップ
    if (!row[0] || !row[1]) continue;

    data.push({
      id: parseInt(row[0]) || 0,
      companyName: row[1] || '',
      contractService: row[2] || '',
      contractDate: row[3] || '',
      amount: row[4] || '',
      paymentMethod: row[5] || '',
      contractSentDate: row[6] || undefined,
      contractReceivedDate: row[7] || undefined,
      applicationSentDate: row[8] || undefined,
      applicationReceivedDate: row[9] || undefined,
      paymentDueDate: row[10] || '',
      paymentActualDate: row[11] || undefined,
      paymentStatus: row[12] || '未入金',
      delayDays: parseInt(row[13]) || undefined,
      publicationIssue: row[14] || '',
      notes: row[15] || undefined
    });
  }

  return data;
}
```

---

## コンポーネント設計

### 1. ProgressBar.tsx

**目的**: スクロール追従型のマイルストーンプログレスバー

**Props**:
```typescript
interface ProgressBarProps {
  milestones: Milestone[];  // ①③⑦⑨⑬
  currentStep: number;
  completedSteps: number[];
}
```

**実装**:
```typescript
// /components/workflow/ProgressBar.tsx
'use client';

import React from 'react';
import type { Milestone } from '@/types/workflow';

interface ProgressBarProps {
  milestones: Milestone[];
  currentStep: number;
  completedSteps: number[];
}

export function ProgressBar({ milestones, currentStep, completedSteps }: ProgressBarProps) {
  return (
    <div className="sticky top-0 z-50 bg-white/80 backdrop-blur-sm border-b border-gray-200 py-4 px-8 transition-all">
      <div className="max-w-7xl mx-auto">
        <div className="flex items-center justify-between">
          {milestones.map((milestone, index) => (
            <React.Fragment key={milestone.stepNumber}>
              <div className="flex items-center gap-2">
                <div className={`w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm ${
                  completedSteps.includes(milestone.stepNumber)
                    ? 'bg-green-500 text-white'
                    : currentStep === milestone.stepNumber
                    ? 'bg-blue-500 text-white'
                    : 'bg-gray-300 text-gray-600'
                }`}>
                  {completedSteps.includes(milestone.stepNumber) ? '✓' : milestone.stepNumber}
                </div>
                <span className="text-xs font-semibold text-gray-700 hidden md:block">
                  {milestone.label}
                </span>
              </div>
              {index < milestones.length - 1 && (
                <div className={`flex-1 h-1 mx-2 ${
                  completedSteps.includes(milestone.stepNumber)
                    ? 'bg-green-500'
                    : 'bg-gray-300'
                }`} />
              )}
            </React.Fragment>
          ))}
        </div>
      </div>
    </div>
  );
}
```

---

### 2. StepCard.tsx

**目的**: 各ステップを表示するカードコンポーネント

**Props**:
```typescript
interface StepCardProps {
  step: WorkflowStep;
  status: StepStatus;
  onClick: () => void;
}
```

**実装**:
```typescript
// /components/workflow/StepCard.tsx
'use client';

import React from 'react';
import { CheckCircle2, Circle } from 'lucide-react';
import type { WorkflowStep, StepStatus } from '@/types/workflow';

interface StepCardProps {
  step: WorkflowStep;
  status: StepStatus;
  onClick: () => void;
}

export function StepCard({ step, status, onClick }: StepCardProps) {
  return (
    <div
      onClick={onClick}
      className={`rounded-lg p-4 cursor-pointer hover:shadow-lg transition-all border-2 ${
        status === 'completed'
          ? 'bg-green-50 border-green-200'
          : status === 'in_progress'
          ? 'bg-blue-50 border-blue-500'
          : 'bg-gray-50 border-gray-200'
      }`}
    >
      <div className="flex items-center gap-2 mb-2">
        {status === 'completed' ? (
          <CheckCircle2 className="w-6 h-6 text-green-600" />
        ) : status === 'in_progress' ? (
          <Circle className="w-6 h-6 text-blue-600 fill-blue-600" />
        ) : (
          <Circle className="w-6 h-6 text-gray-400" />
        )}
        <span className={`text-xs font-bold ${
          status === 'completed' ? 'text-green-600' :
          status === 'in_progress' ? 'text-blue-600' :
          'text-gray-500'
        }`}>
          {status === 'completed' ? '完了' : status === 'in_progress' ? '進行中' : '未着手'}
        </span>
      </div>
      <h3 className={`text-sm font-bold ${
        status === 'pending' ? 'text-gray-700' : 'text-gray-900'
      }`}>
        {step.stepNumber}. {step.title}
      </h3>
    </div>
  );
}
```

---

### 3. SidePanel.tsx

**目的**: Notion風のサイドパネル（ステップ詳細表示）

**Props**:
```typescript
interface SidePanelProps {
  step: WorkflowStep | null;
  isOpen: boolean;
  onClose: () => void;
  onUpdateChecklist: (itemId: string) => void;
  onUpdateStatus: (stepNumber: number, status: StepStatus) => void;
  onOpenEmailModal: (templateId: string) => void;
}
```

**実装の詳細は非常に長いため、概要のみ記載**:
- 右からスライドイン（300msアニメーション）
- 背景オーバーレイ（bg-black/30）
- ステップ詳細表示（概要、やることリスト、チェックリスト、ガイド、注意事項）
- ガイドボタン（メール例文モーダル、外部リンク）
- チェックリスト機能（LocalStorage連動）

---

### 4. EmailModal.tsx

**目的**: メール例文を表示してコピーするモーダル

**実装**:
```typescript
// /components/workflow/EmailModal.tsx
'use client';

import React from 'react';
import { X, Copy } from 'lucide-react';
import type { EmailTemplate } from '@/types/workflow';

interface EmailModalProps {
  email: EmailTemplate | null;
  isOpen: boolean;
  onClose: () => void;
}

export function EmailModal({ email, isOpen, onClose }: EmailModalProps) {
  if (!isOpen || !email) return null;

  const handleCopy = () => {
    const text = `件名: ${email.subject}\n\n${email.body}`;
    navigator.clipboard.writeText(text);
    alert('クリップボードにコピーしました');
  };

  return (
    <div className="fixed inset-0 bg-black/50 z-60 flex items-center justify-center p-4">
      <div className="bg-white rounded-lg shadow-2xl max-w-2xl w-full max-h-[80vh] overflow-hidden">
        <div className="p-6 border-b">
          <div className="flex items-center justify-between">
            <h3 className="text-xl font-bold text-gray-900">メール例文</h3>
            <button onClick={onClose} className="p-2 hover:bg-gray-100 rounded-lg">
              <X className="w-6 h-6" />
            </button>
          </div>
        </div>
        <div className="p-6 overflow-y-auto max-h-[60vh]">
          <div className="mb-4">
            <label className="text-sm font-semibold text-gray-700 mb-1 block">件名:</label>
            <p className="text-sm text-gray-900 p-3 bg-gray-50 rounded">{email.subject}</p>
          </div>
          <div>
            <label className="text-sm font-semibold text-gray-700 mb-1 block">本文:</label>
            <pre className="text-sm text-gray-900 p-4 bg-gray-50 rounded whitespace-pre-wrap font-sans">
              {email.body}
            </pre>
          </div>
        </div>
        <div className="p-6 border-t flex gap-3">
          <button
            onClick={onClose}
            className="flex-1 px-6 py-3 border border-gray-300 rounded-lg hover:bg-gray-50"
          >
            閉じる
          </button>
          <button
            onClick={handleCopy}
            className="flex-1 px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 flex items-center justify-center gap-2"
          >
            <Copy className="w-5 h-5" />
            コピー
          </button>
        </div>
      </div>
    </div>
  );
}
```

---

### 5. ContractTable.tsx

**目的**: 契約・入金管理シートのデータをテーブル表示

**実装**:
```typescript
// /components/workflow/ContractTable.tsx
'use client';

import React from 'react';
import { Table } from 'lucide-react';
import type { ContractData } from '@/types/workflow';

interface ContractTableProps {
  contracts: ContractData[];
  loading: boolean;
}

export function ContractTable({ contracts, loading }: ContractTableProps) {
  return (
    <div className="bg-white rounded-lg shadow p-6">
      <h3 className="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
        <Table className="w-5 h-5 text-blue-600" />
        契約・入金管理
      </h3>
      {loading ? (
        <div className="animate-pulse space-y-2">
          {[1, 2, 3].map(i => (
            <div key={i} className="h-12 bg-gray-200 rounded"></div>
          ))}
        </div>
      ) : (
        <div className="overflow-x-auto">
          <table className="min-w-full divide-y divide-gray-200">
            <thead>
              <tr className="bg-gray-50">
                <th className="px-4 py-3 text-left text-xs font-semibold text-gray-700">企業名</th>
                <th className="px-4 py-3 text-left text-xs font-semibold text-gray-700">契約日</th>
                <th className="px-4 py-3 text-left text-xs font-semibold text-gray-700">契約金額</th>
                <th className="px-4 py-3 text-left text-xs font-semibold text-gray-700">入金予定日</th>
                <th className="px-4 py-3 text-left text-xs font-semibold text-gray-700">入金実績日</th>
                <th className="px-4 py-3 text-left text-xs font-semibold text-gray-700">ステータス</th>
              </tr>
            </thead>
            <tbody className="divide-y divide-gray-200">
              {contracts.map((contract) => (
                <tr key={contract.id} className="hover:bg-gray-50">
                  <td className="px-4 py-3 text-sm text-gray-900">{contract.companyName}</td>
                  <td className="px-4 py-3 text-sm text-gray-600">{contract.contractDate}</td>
                  <td className="px-4 py-3 text-sm text-gray-900 font-semibold">{contract.amount}</td>
                  <td className="px-4 py-3 text-sm text-gray-600">{contract.paymentDueDate}</td>
                  <td className="px-4 py-3 text-sm text-gray-600">{contract.paymentActualDate || '-'}</td>
                  <td className="px-4 py-3">
                    <span className={`inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold ${
                      contract.paymentStatus === '入金済'
                        ? 'bg-green-100 text-green-800'
                        : 'bg-yellow-100 text-yellow-800'
                    }`}>
                      {contract.paymentStatus}
                    </span>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      )}
    </div>
  );
}
```

---

## 型定義

### `/types/workflow.ts`

```typescript
// /types/workflow.ts

export type StepStatus = 'pending' | 'in_progress' | 'completed';

export interface ChecklistItem {
  id: string;
  text: string;
  checked: boolean;
}

export interface GuideLink {
  id: string;
  label: string;
  type: 'modal' | 'external' | 'internal';
  target?: string;  // モーダルID or URL
  icon?: string;    // 📧 📋 🔗 etc
}

export interface EmailTemplate {
  id: string;
  subject: string;
  body: string;
}

export interface WorkflowStep {
  stepNumber: number;
  title: string;
  overview: string;
  status: StepStatus;
  actions: string[];           // やることリスト（HTML可）
  checklist: ChecklistItem[];
  guides: GuideLink[];
  sourceUrl?: string;           // 原本URL（ステップ②④）
  emailTemplate?: EmailTemplate;// メール例文（ステップ⑤⑪⑫⑬）
  notes?: string[];             // 注意事項
}

export interface Milestone {
  stepNumber: number;
  label: string;
}

export interface ContractData {
  id: number;                      // A列
  companyName: string;             // B列
  contractService: string;         // C列
  contractDate: string;            // D列（YYYY/MM/DD形式）
  amount: string;                  // E列（¥XXX,XXX形式）
  paymentMethod: string;           // F列
  contractSentDate?: string;       // G列
  contractReceivedDate?: string;   // H列
  applicationSentDate?: string;    // I列
  applicationReceivedDate?: string;// J列
  paymentDueDate: string;          // K列
  paymentActualDate?: string;      // L列
  paymentStatus: string;           // M列
  delayDays?: number;              // N列
  publicationIssue: string;        // O列
  notes?: string;                  // P列
}

export interface WorkflowState {
  stepStatuses: Record<number, StepStatus>;
  checklists: Record<string, boolean>;
}
```

---

## 静的データ設計

### 1. `/data/contract-workflow.ts`

**目的**: 13ステップの詳細情報を定義

**実装の概要**（全13ステップを定義します）:

```typescript
// /data/contract-workflow.ts
import type { WorkflowStep, Milestone } from '@/types/workflow';

export const contractWorkflowSteps: WorkflowStep[] = [
  {
    stepNumber: 1,
    title: '情報収集',
    overview: '顧客に情報収集フォーマットを送信し、契約に必要な情報を収集します。',
    status: 'pending',
    actions: [
      '顧客に「契約書作成_情報収集フォーマット」を送信',
      '記入してもらう'
    ],
    checklist: [
      { id: 's1-c1', text: '企業名は正式名称か', checked: false },
      { id: 's1-c2', text: '住所は「番地」「号」まで記載されているか', checked: false },
      { id: 's1-c3', text: '代表者役職が記入されているか', checked: false },
      { id: 's1-c4', text: '支払期限が記載されているか', checked: false }
    ],
    guides: []
  },
  {
    stepNumber: 2,
    title: '基本契約書作成',
    overview: 'Google Docsの原本をコピーして、顧客情報を入力し基本契約書を作成します。',
    status: 'pending',
    actions: [
      '原本をコピー',
      '冒頭の企業名を修正: 【甲の会社名・団体名】 → 株式会社〇〇〇',
      '下部の顧客情報を更新:<ul><li>契約締結日</li><li>住所</li><li>企業名</li><li>代表者名</li></ul>'
    ],
    checklist: [
      { id: 's2-c1', text: '企業名が正しく修正されているか', checked: false },
      { id: 's2-c2', text: '住所が正しく入力されているか', checked: false },
      { id: 's2-c3', text: '代表者名が正しく入力されているか', checked: false },
      { id: 's2-c4', text: '契約締結日が正しいか', checked: false }
    ],
    guides: [
      {
        id: 's2-g1',
        label: '原本を開く',
        type: 'external',
        target: 'https://docs.google.com/document/d/1B_GK3cknmtgGgpKVjKUerOOgQ7RgQcwwdLMBy12gBDo/edit?tab=t.0',
        icon: '🔗'
      }
    ],
    sourceUrl: 'https://docs.google.com/document/d/1B_GK3cknmtgGgpKVjKUerOOgQ7RgQcwwdLMBy12gBDo/edit?tab=t.0',
    notes: [
      '原本をコピーして作成してください',
      '【甲の会社名・団体名】等のプレースホルダーを置換してください'
    ]
  },
  // ... 残り11ステップを定義
];

export const milestones: Milestone[] = [
  { stepNumber: 1, label: '情報' },
  { stepNumber: 3, label: '契約' },
  { stepNumber: 7, label: '完了' },
  { stepNumber: 9, label: '入金' },
  { stepNumber: 13, label: '掲載' }
];
```

**（注）**: 実際のファイルには13ステップすべてを業務フローガイドに従って詳細に定義します。

---

### 2. `/data/email-templates.ts`

**目的**: メール例文を定義

**実装**:

```typescript
// /data/email-templates.ts
import type { EmailTemplate } from '@/types/workflow';

export const emailTemplates: Record<string, EmailTemplate> = {
  '契約書送信完了メール': {
    id: 'contract-send-complete',
    subject: '【重要】契約書類2点のご確認をお願いいたします',
    body: `〇〇様

いつもお世話になっております。
株式会社ゆめスタの飯田でございます。

この度は、弊社「ゆめスタマガジン」への広告掲載に
お申し込みいただき、誠にありがとうございます。

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
【契約書類のご確認について】
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

マネーフォワードより、以下2点の契約書類を
お送りいたしましたので、ご確認をお願いいたします。

①「広告掲載基本契約書」
②「広告掲載申込書兼個別契約書」

※マネーフォワードからのメールが届いておりますので、
　そちらのリンクから書類をご確認いただけます。

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
【重要事項説明のご案内】
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

弊社では、お客様に安心してサービスをご利用いただくため、
契約内容を直接ご説明する「重要事項説明」の実施を
推奨しております。

お時間を15〜20分程度頂戴することになり恐縮ですが、
以下のような重要なポイントを丁寧にご説明させていただきます：

・契約期間と自動更新の仕組み
・中途解約時の返金について
・原稿提出期限と掲載開始のタイミング
・その他、ご不明点やご質問への回答

オンライン面談（Zoom等）にて実施いたしますので、
ご都合のよろしい日時を3候補程度お知らせいただけますと
幸いでございます。

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
【弊社の想い】
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

重要事項説明は任意とさせていただいておりますが、
弊社としましては、お客様との信頼関係を何より大切にしたいと
考えております。

契約内容をしっかりとご理解いただいた上で、
安心してサービスをご利用いただくことが、
長くお付き合いいただける第一歩だと考えております。

お忙しいところ恐縮ではございますが、
ぜひご検討いただけますと幸いです。

何卒、よろしくお願い申し上げます。

株式会社ゆめスタ
飯田思遠
TEL: 090-4264-9939
Email: info@yumesuta.com`
  },

  '入金確認メール': {
    id: 'payment-confirm',
    subject: '入金確認のご連絡・原稿情報のご提出について',
    body: `〇〇様

お世話になっております。
株式会社ゆめスタの飯田です。

この度は、ご入金いただきありがとうございました。
入金を確認いたしましたので、ご連絡申し上げます。

つきましては、記事作成に必要な情報をご提供いただきたく、
別途フォームをお送りいたしますので、
ご記入のうえ、7日以内にご提出をお願いいたします。

よろしくお願いいたします。

株式会社ゆめスタ
飯田思遠`
  },

  '校正依頼メール': {
    id: 'proofreading-request',
    subject: '校正用原稿のご確認について',
    body: `〇〇様

お世話になっております。
株式会社ゆめスタの飯田です。

校正用原稿が完成いたしましたので、
添付ファイルをご確認ください。

修正がございましたら、〇月〇日までに
ご連絡をお願いいたします。

期日までにご連絡がない場合は、
ご承認いただいたものとして掲載させていただきます。

よろしくお願いいたします。

株式会社ゆめスタ
飯田思遠`
  },

  '掲載完了メール': {
    id: 'publication-complete',
    subject: '掲載完了のご報告',
    body: `〇〇様

お世話になっております。
株式会社ゆめスタの飯田です。

〇月号への掲載が完了いたしましたので、
ご報告申し上げます。

引き続き、よろしくお願いいたします。

株式会社ゆめスタ
飯田思遠`
  }
};
```

---

### 3. `/lib/workflow-storage.ts`

**目的**: LocalStorageでの進捗状態管理

**実装**:

```typescript
// /lib/workflow-storage.ts
import type { WorkflowState } from '@/types/workflow';

const STORAGE_KEY = 'workflow_contract_state';

export function saveWorkflowState(state: WorkflowState): void {
  if (typeof window === 'undefined') return;

  try {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  } catch (error) {
    console.error('LocalStorage保存エラー:', error);
  }
}

export function loadWorkflowState(): WorkflowState | null {
  if (typeof window === 'undefined') return null;

  try {
    const data = localStorage.getItem(STORAGE_KEY);
    return data ? JSON.parse(data) : null;
  } catch (error) {
    console.error('LocalStorage読み込みエラー:', error);
    return null;
  }
}

export function clearWorkflowState(): void {
  if (typeof window === 'undefined') return;

  try {
    localStorage.removeItem(STORAGE_KEY);
  } catch (error) {
    console.error('LocalStorage削除エラー:', error);
  }
}
```

---

## 実装スケジュール

### Phase 1-1: 基本UI実装（1日目）

**作業内容**:
1. 型定義作成（`types/workflow.ts`）
2. 静的データ作成（`data/contract-workflow.ts`、`data/email-templates.ts`）
3. ページ作成（`app/dashboard/workflow/contract/page.tsx`）
4. プログレスバーコンポーネント作成
5. カードグリッドコンポーネント作成

**完了条件**:
- [ ] 13ステップがカードグリッドで表示される
- [ ] プログレスバーが表示され、スクロール追従する

---

### Phase 1-2: インタラクション実装（2日目）

**作業内容**:
1. サイドパネルコンポーネント作成
2. カードクリック→サイドパネル展開
3. チェックリスト機能実装
4. LocalStorage保存機能実装
5. メール例文モーダル実装
6. コピー機能実装

**完了条件**:
- [ ] カードクリックでサイドパネルが右からスライドイン
- [ ] チェックリストをチェックでき、LocalStorageに保存される
- [ ] メール例文ボタンでモーダルが開く
- [ ] コピーボタンでメール例文がクリップボードにコピーされる

---

### Phase 1-3: データ連動実装（3日目）

**作業内容**:
1. API作成（`/api/contract/list/route.ts`）
2. 契約・入金管理シートのデータ取得
3. ContractTableコンポーネント作成
4. 手動更新機能実装
5. エラーハンドリング実装

**完了条件**:
- [ ] 契約・入金管理シートのデータがテーブルで表示される
- [ ] 手動更新ボタンでデータが再取得される

---

### Phase 1-4: メインダッシュボード統合（4日目）

**作業内容**:
1. `app/page.tsx`に「バックオフィス業務フロー」タブ追加
2. ナビゲーション設定
3. テスト
4. 微調整

**完了条件**:
- [ ] 「バックオフィス業務フロー」タブがメインダッシュボードに表示される
- [ ] 契約業務フローページに遷移できる
- [ ] 既存の6機能と同じデザインで統一されている

---

## テスト計画

### 基本動作テスト

1. ダッシュボードから「バックオフィス業務フロー」→「契約業務フロー」に移動
2. ステップ①〜⑬がカードグリッドで表示される
3. プログレスバーが表示され、マイルストーンが正しく表示される
4. カードをクリックするとサイドパネルが右からスライドイン
5. サイドパネルに各ステップの詳細情報が表示される
6. チェックリストをチェックできる
7. メール例文ボタンをクリックするとモーダルが開く
8. コピーボタンでメール例文がクリップボードにコピーされる
9. 外部リンクボタンで原本URLが新しいタブで開く
10. 契約・入金管理シートのデータがテーブルで表示される
11. 手動更新ボタンでデータが再取得される
12. ページを再読み込みするとチェック状態が保存されている

### レスポンシブテスト

**PC（1920×1080）**:
- [ ] カードグリッドが5カラムで表示される
- [ ] プログレスバーが正しく表示される
- [ ] サイドパネルが適切な幅で表示される

**タブレット（768×1024）**:
- [ ] カードグリッドが3カラムで表示される
- [ ] プログレスバーが正しく表示される

**モバイル（375×667）**:
- [ ] カードグリッドが2カラムで表示される
- [ ] プログレスバーがコンパクトに表示される
- [ ] サイドパネルが全幅で表示される

### エラーハンドリングテスト

1. Google Sheetsへのアクセスエラー
2. ネットワークエラー
3. LocalStorage保存エラー

---

## Phase 2以降への拡張

### Phase 2-1: スプレッドシート書き込み機能

**実装内容**:
- 各ステップ完了時に対応する列（契約書送付、申込書送付等）に日付を記録
- API実装: `/api/contract/update`（PUT）
- `updateSheetCell`メソッドを使用した日付記録

**必要なAPI**:
```typescript
// /app/api/contract/update/route.ts
export async function PUT(request: Request) {
  const { contractId, field, value } = await request.json();

  // Google Sheets APIで該当セルを更新
  // ...
}
```

---

### Phase 2-2: Google Drive連動機能

**実装内容**:
- フォルダ自動作成（企業フォルダ、契約フォルダ）
- ファイルアップロード（契約書PDF、請求書PDF、エビデンス）
- ファイル一覧取得・表示

**必要なAPI**:
1. `/api/drive/create-folder`（POST） - フォルダ作成
2. `/api/drive/upload`（POST） - ファイルアップロード
3. `/api/drive/files`（GET） - ファイル一覧取得

**フォルダ構造**:
```
エビデンス保存用ドライブ/
├── 企業A/
│   ├── 契約01_2025年12月号/
│   │   ├── 広告掲載基本契約書_企業A_20251009.pdf
│   │   ├── 広告掲載申込書_企業A_20251009.pdf
│   │   └── 請求書_企業A_20251015.pdf
```

---

### Phase 2-3: 入力フォーム機能

**実装内容**:
- サイドパネル内に入力フォームを追加
- 入力値を直接スプレッドシートに記録
- リアルタイム同期

---

### Phase 2-4: 自動リマインダー機能

**実装内容**:
- 期日管理
- アラート表示（期日が近い、期日超過）
- メール通知（オプション）

---

## 完了条件

Phase 1が完了したと判断する条件:

- [ ] 「バックオフィス業務フロー」タブがメインダッシュボードに表示される
- [ ] 契約業務フローページに遷移できる
- [ ] プログレスバーが表示され、スクロール追従する
- [ ] 13ステップがカードグリッドで表示される
- [ ] カードクリックでサイドパネルが右からスライドイン
- [ ] サイドパネルに各ステップの詳細情報が表示される
- [ ] チェックリストをチェックでき、LocalStorageに保存される
- [ ] メール例文ボタンでモーダルが開く
- [ ] コピーボタンでメール例文がクリップボードにコピーされる
- [ ] 外部リンクボタンで原本URLが開く
- [ ] 契約・入金管理シートのデータがテーブルで表示される
- [ ] 手動更新ボタンでデータが再取得される
- [ ] 既存の6機能と同じデザインで統一されている

---

## 付録

### A. 業務フロー13ステップの詳細

**（注）**: `/mnt/c/ゆめスタバックエンド/active/契約書作成_業務フローガイド.md`を参照

---

### B. 情報収集フォーマット

**（注）**: `/mnt/c/ゆめスタバックエンド/active/契約書作成_情報収集フォーマット.md`を参照

---

### C. 参照ドキュメント一覧

1. **要件定義**:
   - `/mnt/c/yumesuta-management-system/docs/workflow/契約業務フロー統合_要件定義.md`

2. **システム側要望・方針**:
   - `/mnt/c/yumesuta-management-system/docs/workflow/契約業務フロー統合_システム側要望・方針.md`

3. **フェーズ1成果物**:
   - `/mnt/c/yumesuta-management-system/docs/workflow/system-survey/UI思想サマリー.md`
   - `/mnt/c/yumesuta-management-system/docs/workflow/system-survey/UX思想サマリー.md`
   - `/mnt/c/yumesuta-management-system/docs/workflow/system-survey/API仕様書.md`
   - `/mnt/c/yumesuta-management-system/docs/workflow/system-survey/技術仕様書.md`

4. **フェーズ2成果物**:
   - `/mnt/c/yumesuta-management-system/docs/workflow/active-data-survey/アクティブスプレッドシート調査レポート.md`
   - `/mnt/c/yumesuta-management-system/docs/workflow/active-data-survey/Google Drive構造調査レポート.md`

5. **フェーズ3成果物**:
   - `/mnt/c/yumesuta-management-system/docs/workflow/implementation-draft/実装草案.md`

6. **フェーズ4成果物**:
   - `/mnt/c/yumesuta-management-system/docs/workflow/detailed-survey/スプレッドシート詳細調査レポート.md`
   - `/mnt/c/yumesuta-management-system/docs/workflow/detailed-survey/Google Drive詳細調査レポート.md`

7. **業務フローガイド**:
   - `/mnt/c/ゆめスタバックエンド/active/契約書作成_業務フローガイド.md`
   - `/mnt/c/ゆめスタバックエンド/active/契約書作成_情報収集フォーマット.md`
   - `/mnt/c/ゆめスタバックエンド/active/契約書リーガルチェック_プロンプト.md`

---

**作成日**: 2025年10月11日
**作成者**: Claude Code
**バージョン**: v1.0
**最終更新**: 2025年10月11日

以上
