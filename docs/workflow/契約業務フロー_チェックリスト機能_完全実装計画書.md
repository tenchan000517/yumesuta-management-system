# 契約業務フロー - チェックリスト機能 完全実装計画書

**作成日**: 2025年10月12日
**作成者**: Claude Code
**対象読者**: 次世代Claude Code（前提知識ゼロ）
**目的**: チェックリスト機能とProgressBar表示制御の完全な実装
**バージョン**: v1.0（暗黙知排除版）

---

## 🚀 次回セッション開始方法（最重要）

### セッション開始時に読むべきこと

**次回のClaude Codeへ**:

このドキュメントを最初から最後まで読んでください。特に以下のセクションを重点的に：
1. [現在の進捗状況](#現在の進捗状況) ← **ここから読む**
2. [次のタスク](#次のタスク) ← **何をするか**
3. [実装手順](#実装手順) ← **どうやるか**

### 現在の進捗状況（2025年10月12日時点）

**✅ 完了済み**:
- Phase 1: ProgressBar表示制御（完了）
  - ✅ ProgressBarを契約選択時のみ表示
  - ✅ 契約選択解除時にstepsをリセット
  - ✅ LocalStorage関連のコード削除
  - ✅ `lib/workflow-storage.ts` 削除

- Phase 2（シート作成）: 完了
  - ✅ GASスクリプト作成（`scripts/gas-create-checklist-sheet.js`）
  - ✅ 「チェックリスト管理」シート作成完了
  - ✅ ヘッダー行設定（35列: A〜AI）

**🔄 次のタスク: Phase 2-3（チェック項目IDの確認）**

### 次のタスク

**タスク名**: チェック項目IDの確認

**所要時間**: 20分

**目的**:
- `data/contract-workflow.ts` のチェック項目IDを確認
- GASスクリプトのヘッダーと一致しているか確認
- 不一致があれば修正

**手順**:
1. `data/contract-workflow.ts` を開く
2. 各ステップの `checklist` 配列を確認
3. 各チェック項目の `id` を抽出
4. `scripts/gas-create-checklist-sheet.js` の `headers` 配列と比較
5. 不一致があれば、どちらかを修正

**期待される結果**:
- チェック項目IDの一覧表を作成（Markdown形式）
- GASスクリプトのヘッダーと100%一致していることを確認

**次のフェーズ**: Phase 3（API実装）

---

## 📋 目次

1. [現状の問題点](#現状の問題点)
2. [修正の目的](#修正の目的)
3. [Phase 1: ProgressBar表示制御](#phase-1-progressbar表示制御)
4. [Phase 2: チェックリストシート設計](#phase-2-チェックリストシート設計)
5. [Phase 3: API設計](#phase-3-api設計)
6. [Phase 4: UI/UX設計](#phase-4-uiux設計)
7. [Phase 5: コンポーネント設計](#phase-5-コンポーネント設計)
8. [実装手順](#実装手順)
9. [テスト計画](#テスト計画)
10. [重要な注意事項](#重要な注意事項)

---

## 現状の問題点

### 問題1: ProgressBarが「何の進捗」を表しているか不明確

**現在の動作**:
```tsx
// ProgressBarは常に表示される（contract/page.tsx 292-297行目）
<ProgressBar
  milestones={milestones}
  currentStep={currentStep}
  completedSteps={completedSteps}
/>
```

**問題**:
- **契約未選択時**: LocalStorageから復元された状態が表示される → **意味がない**
- **契約選択時**: 選択した契約の進捗が表示される → **正しい**
- **契約選択解除時**: 前の契約の進捗が残り続ける → **間違っている**

**結果**: ユーザーは「このProgressBarは何を表しているのか？」と混乱する

---

### 問題2: stepsの状態管理が混乱している

**2つの異なるソースからstepsが更新される**:

1. **LocalStorageからの復元**（contract/page.tsx 50-61行目）:
```tsx
useEffect(() => {
  const savedState = loadWorkflowState();
  if (savedState) {
    setSteps(prevSteps => prevSteps.map(step => ({
      ...step,
      status: savedState.stepStatuses[step.stepNumber] || 'pending',
      // ...
    })));
  }
}, []);
```

2. **契約選択時のAPIデータ**（contract/page.tsx 138-148行目）:
```tsx
const updatedSteps = contractWorkflowSteps.map(step => {
  const completedAtKey = `step${step.stepNumber}CompletedAt` as keyof ContractData;
  const completedAt = result.contract[completedAtKey];
  return {
    ...step,
    status: completedAt ? ('completed' as StepStatus) : ('pending' as StepStatus),
  };
});
setSteps(updatedSteps);
```

**問題**: LocalStorageの状態と契約データの状態が競合している

---

### 問題3: 契約選択解除時にstepsがリセットされない

**現在のコード**（contract/page.tsx 124-128行目）:
```tsx
const handleSelectContract = async (contractId: number | null) => {
  if (!contractId) {
    setSelectedContractId(null);
    setSelectedContract(null);
    return; // stepsはそのまま！ ← 問題
  }
  // ...
}
```

**問題**: 契約選択を解除しても、stepsの状態が前の契約のまま残る

---

### 問題4: LocalStorageの使用が無意味

**現状の実装**:
- チェックリスト状態をLocalStorageに保存
- ページリロード時に復元

**問題**:
1. **契約IDと紐づいていない** → どの契約のチェックリストか不明
2. **他ユーザーと共有できない** → チーム作業で使えない
3. **ブラウザ依存** → 別のPC/ブラウザで見ると消える
4. **契約データと乖離** → スプレッドシートに記録されない

**結論**: LocalStorageは削除し、スプレッドシートで管理すべき

---

## 修正の目的

### 最終ゴール

1. **ProgressBarは契約選択時のみ表示** → 「何の進捗か」を明確にする
2. **チェックリストはスプレッドシートで管理** → 契約IDに紐づけ、全ユーザーで共有
3. **LocalStorageを完全削除** → 状態管理をシンプルにする

---

## Phase 1: ProgressBar表示制御

### 目的

ProgressBarを契約選択時のみ表示し、「何の進捗を表しているか」を明確にする。

### 実装内容

#### 1. ProgressBarを条件付きレンダリング

**修正前**（contract/page.tsx 291-297行目）:
```tsx
return (
  <div className="min-h-screen bg-gray-50">
    {/* プログレスバー */}
    <ProgressBar
      milestones={milestones}
      currentStep={currentStep}
      completedSteps={completedSteps}
    />
```

**修正後**:
```tsx
return (
  <div className="min-h-screen bg-gray-50">
    {/* プログレスバー（契約選択時のみ表示） */}
    {selectedContract && (
      <ProgressBar
        milestones={milestones}
        currentStep={currentStep}
        completedSteps={completedSteps}
      />
    )}
```

---

#### 2. 契約選択解除時にstepsをリセット

**修正前**（contract/page.tsx 124-129行目）:
```tsx
const handleSelectContract = async (contractId: number | null) => {
  if (!contractId) {
    setSelectedContractId(null);
    setSelectedContract(null);
    return;
  }
  // ...
}
```

**修正後**:
```tsx
const handleSelectContract = async (contractId: number | null) => {
  if (!contractId) {
    setSelectedContractId(null);
    setSelectedContract(null);

    // stepsを初期状態にリセット
    setSteps(contractWorkflowSteps.map(step => ({
      ...step,
      status: 'pending' as StepStatus,
      checklist: step.checklist.map(item => ({ ...item, checked: false }))
    })));

    return;
  }
  // ...
}
```

---

#### 3. LocalStorage関連のコードを削除

**削除対象1**: LocalStorageからの復元useEffect（contract/page.tsx 50-66行目）
```tsx
// 削除
useEffect(() => {
  const savedState = loadWorkflowState();
  if (savedState) {
    setSteps(prevSteps => prevSteps.map(step => ({
      ...step,
      status: savedState.stepStatuses[step.stepNumber] || 'pending',
      checklist: step.checklist.map(item => ({
        ...item,
        checked: savedState.checklists[item.id] || false
      }))
    })));
  }

  // 初回マウント時にデータ取得
  fetchContracts();
  fetchReminders();
}, []);
```

**修正後**:
```tsx
// 初回マウント時にデータ取得のみ
useEffect(() => {
  fetchContracts();
  fetchReminders();
}, []);
```

---

**削除対象2**: LocalStorageへの保存useEffect（contract/page.tsx 68-83行目）
```tsx
// 削除
useEffect(() => {
  const state: WorkflowState = {
    stepStatuses: steps.reduce((acc, step) => {
      acc[step.stepNumber] = step.status;
      return acc;
    }, {} as Record<number, StepStatus>),
    checklists: steps.reduce((acc, step) => {
      step.checklist.forEach(item => {
        acc[item.id] = item.checked;
      });
      return acc;
    }, {} as Record<string, boolean>)
  };
  saveWorkflowState(state);
}, [steps]);
```

---

### 完了条件

- [ ] ProgressBarが契約選択時のみ表示される
- [ ] 契約選択解除時にProgressBarが消える
- [ ] 契約選択解除時にstepsが初期状態にリセットされる
- [ ] LocalStorage関連のコードが完全に削除される
- [ ] `lib/workflow-storage.ts`（LocalStorage関連）の削除

---

## Phase 2: チェックリストシート設計

### 背景

現在のチェックリストはLocalStorageに保存されており、以下の問題がある：
1. 契約IDと紐づいていない
2. 他ユーザーと共有できない
3. ブラウザ依存

**解決策**: 新規シート `チェックリスト管理` を作成し、契約IDごとにチェック状態を管理

---

### シート構造

#### シート名: `チェックリスト管理`

**配置場所**: `契約・入金管理` スプレッドシート内の新規シート

**列構成**:

| 列 | ヘッダー名 | 説明 | データ型 | 例 |
|----|-----------|------|---------|---|
| A | 契約ID | 契約・入金管理シートのA列と同じ | 数値 | 1 |
| B | ステップ1-項目1 | 「企業情報を収集する」 | TRUE/FALSE | TRUE |
| C | ステップ1-項目2 | 「担当者情報を確認する」 | TRUE/FALSE | FALSE |
| D | ステップ1-項目3 | 「掲載希望号を確認する」 | TRUE/FALSE | TRUE |
| E | ステップ2-項目1 | 「テンプレートを準備する」 | TRUE/FALSE | FALSE |
| F | ステップ2-項目2 | 「企業情報を記入する」 | TRUE/FALSE | FALSE |
| ... | ... | ... | ... | ... |

---

### チェック項目の一覧

**各ステップのチェック項目**（contract-workflow.ts より抽出）:

#### ステップ1: 情報収集（3項目）
- B列: `step1_check1` - 企業情報を収集する
- C列: `step1_check2` - 担当者情報を確認する
- D列: `step1_check3` - 掲載希望号を確認する

#### ステップ2: 基本契約書作成（4項目）
- E列: `step2_check1` - テンプレートを準備する
- F列: `step2_check2` - 企業情報を記入する
- G列: `step2_check3` - 契約内容を確認する
- H列: `step2_check4` - PDFを作成する

#### ステップ3: 基本契約書の押印・送付（3項目）
- I列: `step3_check1` - 契約書を郵送する
- J列: `step3_check2` - 送付記録を残す
- K列: `step3_check3` - 返送を待つ

#### ステップ4: 申込書作成（4項目）
- L列: `step4_check1` - テンプレートを準備する
- M列: `step4_check2` - 掲載情報を記入する
- N列: `step4_check3` - 申込内容を確認する
- O列: `step4_check4` - PDFを作成する

#### ステップ5: 申込書の押印・送信（2項目）
- P列: `step5_check1` - 申込書を送信する
- Q列: `step5_check2` - 送信記録を残す

#### ステップ6: 請求書作成（3項目）
- R列: `step6_check1` - 請求金額を計算する
- S列: `step6_check2` - 請求書を作成する
- T列: `step6_check3` - 送付準備をする

#### ステップ7: 請求書送付（2項目）
- U列: `step7_check1` - 請求書を郵送する
- V列: `step7_check2` - 送付記録を残す

#### ステップ8: 入金確認（2項目）
- W列: `step8_check1` - 入金を確認する
- X列: `step8_check2` - 記録を更新する

#### ステップ9: 情報入力（3項目）
- Y列: `step9_check1` - 企業情報を入力する
- Z列: `step9_check2` - 掲載内容を入力する
- AA列: `step9_check3` - 入力内容を確認する

#### ステップ10: 確認依頼（2項目）
- AB列: `step10_check1` - 確認メールを送信する
- AC列: `step10_check2` - 返信を待つ

#### ステップ11: 修正対応（2項目）
- AD列: `step11_check1` - 修正箇所を確認する
- AE列: `step11_check2` - 修正を反映する

#### ステップ12: 最終確認（2項目）
- AF列: `step12_check1` - 最終確認を依頼する
- AG列: `step12_check2` - 承認を得る

#### ステップ13: 掲載完了（2項目）
- AH列: `step13_check1` - 掲載を確認する
- AI列: `step13_check2` - 完了報告をする

**合計**: 34列（A列 + 33項目）

---

### データ例

| 契約ID | step1_check1 | step1_check2 | step1_check3 | step2_check1 | ... | step13_check2 |
|--------|--------------|--------------|--------------|--------------|-----|---------------|
| 1 | TRUE | TRUE | FALSE | FALSE | ... | FALSE |
| 2 | FALSE | FALSE | FALSE | FALSE | ... | FALSE |
| 3 | TRUE | TRUE | TRUE | TRUE | ... | TRUE |

---

### シート作成スクリプト

**ファイル**: `scripts/gas-create-checklist-sheet.js`

**実行方法**:
1. 営業予実管理スプレッドシートを開く
   - https://docs.google.com/spreadsheets/d/13PzSnGekGxDWX7B1_TwczNibR6j_JxDb3UuquPX1GyQ
2. 拡張機能 → Apps Script
3. `scripts/gas-create-checklist-sheet.js` の内容をコピー&ペースト
4. 関数 `createChecklistSheet()` を実行
5. 権限を承認（初回のみ）

**スクリプト内容**:
- シート「チェックリスト管理」を作成
- ヘッダー行を設定（35列: A〜AI）
  - A列: 契約ID
  - B〜AI列: チェック項目（34項目）
- ヘッダー行のスタイル設定
  - 背景色: 青（#4285F4）
  - 文字色: 白
  - 太字
- 列幅を調整
- 1行目を固定（スクロール時も表示）

**作成されるヘッダー**:
```
A列: 契約ID
B〜D列: ステップ1（3項目）
E〜H列: ステップ2（4項目）
I〜K列: ステップ3（3項目）
L〜O列: ステップ4（4項目）
P〜Q列: ステップ5（2項目）
R〜T列: ステップ6（3項目）
U〜V列: ステップ7（2項目）
W〜X列: ステップ8（2項目）
Y〜AA列: ステップ9（3項目）
AB〜AC列: ステップ10（2項目）
AD〜AE列: ステップ11（2項目）
AF〜AG列: ステップ12（2項目）
AH〜AI列: ステップ13（2項目）
```

---

## Phase 3: API設計

### 1. `/api/contract/checklist/[id]` - チェックリスト取得・更新API

**ファイル**: `app/api/contract/checklist/[id]/route.ts`

#### GET: チェックリスト取得

**パラメータ**:
- `id`: 契約ID（URLパラメータ）

**レスポンス形式**:
```typescript
{
  success: boolean;
  checklist?: Record<string, boolean>; // { "step1_check1": true, ... }
  error?: string;
}
```

**実装コード**:
```typescript
import { NextRequest, NextResponse } from 'next/server';
import { getSheetData } from '@/lib/google-sheets';

export async function GET(
  request: NextRequest,
  { params }: { params: { id: string } }
) {
  try {
    const contractId = parseInt(params.id);
    const spreadsheetId = process.env.SALES_SPREADSHEET_ID!;

    // チェックリスト管理シートから契約IDに一致する行を取得
    const data = await getSheetData(spreadsheetId, 'チェックリスト管理!A2:AI');
    const row = data.find((r: any[]) => parseInt(r[0]) === contractId);

    if (!row) {
      // 行がない場合は全てfalse
      return NextResponse.json({
        success: true,
        checklist: {},
      });
    }

    // B列以降をチェックリストオブジェクトに変換
    const headers = [
      'step1_check1', 'step1_check2', 'step1_check3',
      'step2_check1', 'step2_check2', 'step2_check3', 'step2_check4',
      // ... 全てのヘッダー
    ];

    const checklist: Record<string, boolean> = {};
    headers.forEach((key, index) => {
      checklist[key] = row[index + 1] === 'TRUE' || row[index + 1] === true;
    });

    return NextResponse.json({
      success: true,
      checklist,
    });
  } catch (error: any) {
    return NextResponse.json(
      { success: false, error: error.message },
      { status: 500 }
    );
  }
}
```

---

#### PUT: チェックリスト更新

**パラメータ**:
- `id`: 契約ID（URLパラメータ）

**リクエストボディ**:
```typescript
{
  checkId: string;  // 例: "step1_check1"
  checked: boolean; // true or false
}
```

**レスポンス形式**:
```typescript
{
  success: boolean;
  error?: string;
}
```

**実装コード**:
```typescript
export async function PUT(
  request: NextRequest,
  { params }: { params: { id: string } }
) {
  try {
    const contractId = parseInt(params.id);
    const { checkId, checked } = await request.json();

    const spreadsheetId = process.env.SALES_SPREADSHEET_ID!;

    // 1. 契約IDに一致する行を検索
    const data = await getSheetData(spreadsheetId, 'チェックリスト管理!A2:AI');
    let rowIndex = data.findIndex((r: any[]) => parseInt(r[0]) === contractId);

    // 2. 行がない場合は新規作成
    if (rowIndex === -1) {
      const newRow = [contractId, ...Array(34).fill(false)];
      await appendSheetRow(spreadsheetId, 'チェックリスト管理', newRow);
      rowIndex = data.length;
    }

    // 3. 列インデックスを取得
    const headers = [
      'step1_check1', 'step1_check2', 'step1_check3',
      // ... 全てのヘッダー
    ];
    const columnIndex = headers.indexOf(checkId);
    if (columnIndex === -1) {
      return NextResponse.json(
        { success: false, error: 'Invalid checkId' },
        { status: 400 }
      );
    }

    // 4. セルを更新（B列 = インデックス1 = columnIndex + 1）
    const column = String.fromCharCode(66 + columnIndex); // B, C, D, ...
    const actualRowNumber = rowIndex + 2; // ヘッダー1行 + データ開始行2行目
    const cellAddress = `${column}${actualRowNumber}`;

    await updateSheetCell(
      spreadsheetId,
      'チェックリスト管理',
      cellAddress,
      checked ? 'TRUE' : 'FALSE'
    );

    return NextResponse.json({ success: true });
  } catch (error: any) {
    return NextResponse.json(
      { success: false, error: error.message },
      { status: 500 }
    );
  }
}
```

---

### 2. `appendSheetRow` 関数の追加

**ファイル**: `lib/google-sheets.ts`

```typescript
/**
 * スプレッドシートに新規行を追加
 */
export async function appendSheetRow(
  spreadsheetId: string,
  sheetName: string,
  values: any[]
): Promise<void> {
  const sheets = getGoogleSheetsClient();

  await sheets.spreadsheets.values.append({
    spreadsheetId,
    range: `${sheetName}!A:A`,
    valueInputOption: 'USER_ENTERED',
    requestBody: {
      values: [values],
    },
  });
}
```

---

## Phase 4: UI/UX設計

### 変更なし

**理由**: チェックリストのUIは変更しない。バックエンド（保存先）だけを変更する。

**現在のUI**: サイドパネル内のチェックリスト
- チェックボックスをクリック
- `onUpdateChecklist(itemId)` が呼ばれる
- LocalStorageに保存 ← **ここをAPI呼び出しに変更**

---

## Phase 5: コンポーネント設計

### 1. SidePanelの修正

**ファイル**: `components/workflow/SidePanel.tsx`

**現在の実装**（チェックリスト更新部分）:
```tsx
<input
  type="checkbox"
  checked={item.checked}
  onChange={() => onUpdateChecklist(item.id)}
  className="w-4 h-4 text-blue-600"
/>
```

**修正内容**:
1. `onUpdateChecklist` の呼び出しに加えて、**API呼び出しを追加**
2. 契約IDが必要（propsで受け取る）

**修正後のコード**:
```tsx
// Props追加
interface SidePanelProps {
  // ... 既存のprops
  contractId?: number; // 追加
}

// チェックリスト更新関数
const handleChecklistUpdate = async (itemId: string, checked: boolean) => {
  // 1. ローカル状態を即座に更新（UXのため）
  onUpdateChecklist(itemId);

  // 2. APIに保存
  if (contractId) {
    try {
      const response = await fetch(`/api/contract/checklist/${contractId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          checkId: itemId,
          checked: !checked, // 反転
        }),
      });

      const result = await response.json();
      if (!result.success) {
        console.error('チェックリスト更新エラー:', result.error);
        alert('チェックリストの保存に失敗しました');
        // 失敗したら元に戻す
        onUpdateChecklist(itemId);
      }
    } catch (error) {
      console.error('チェックリスト更新エラー:', error);
      alert('チェックリストの保存に失敗しました');
      // 失敗したら元に戻す
      onUpdateChecklist(itemId);
    }
  }
};

// JSX修正
<input
  type="checkbox"
  checked={item.checked}
  onChange={() => handleChecklistUpdate(item.id, item.checked)}
  className="w-4 h-4 text-blue-600"
/>
```

---

### 2. contract/page.tsxの修正

**修正1**: 契約選択時にチェックリストを取得

```tsx
const handleSelectContract = async (contractId: number | null) => {
  if (!contractId) {
    // ... リセット処理
    return;
  }

  try {
    // 契約データ取得
    const response = await fetch(`/api/contract/${contractId}`);
    const result = await response.json();

    if (result.success) {
      setSelectedContractId(contractId);
      setSelectedContract(result.contract);

      // チェックリスト取得
      const checklistResponse = await fetch(`/api/contract/checklist/${contractId}`);
      const checklistResult = await checklistResponse.json();

      if (checklistResult.success) {
        // 進捗状況 + チェックリストをステップに反映
        const updatedSteps = contractWorkflowSteps.map(step => {
          const completedAtKey = `step${step.stepNumber}CompletedAt` as keyof ContractData;
          const completedAt = result.contract[completedAtKey];

          // チェックリストを反映
          const updatedChecklist = step.checklist.map(item => ({
            ...item,
            checked: checklistResult.checklist[item.id] || false,
          }));

          return {
            ...step,
            status: completedAt ? ('completed' as StepStatus) : ('pending' as StepStatus),
            checklist: updatedChecklist,
          };
        });

        setSteps(updatedSteps);
      }
    }
  } catch (error) {
    console.error('契約取得エラー:', error);
  }
};
```

**修正2**: SidePanelに`contractId`を渡す

```tsx
<SidePanel
  step={selectedStep}
  isOpen={isPanelOpen}
  onClose={() => setIsPanelOpen(false)}
  onUpdateChecklist={handleUpdateChecklist}
  onUpdateStatus={handleUpdateStatus}
  onOpenEmailModal={handleOpenEmailModal}
  companyId={selectedContract?.companyId}
  contractId={selectedContract?.id}  // ← これを追加
  companyName={selectedContract?.companyName}
  onStepCompleted={handleStepCompleted}
/>
```

---

## 実装手順

### Step 1: Phase 1実装（ProgressBar表示制御）

**所要時間**: 10分

**タスク**:
1. `app/dashboard/workflow/contract/page.tsx`を修正
   - [ ] ProgressBarを条件付きレンダリング（`selectedContract &&`）
   - [ ] `handleSelectContract(null)` 時にstepsをリセット
   - [ ] LocalStorage関連のuseEffectを削除
2. `lib/workflow-storage.ts`を削除
3. テスト: 契約選択/選択解除でProgressBarが表示/非表示になるか

---

### Step 2: チェックリスト管理シート作成

**所要時間**: 5分

**タスク**:
1. ✅ `scripts/gas-create-checklist-sheet.js` は既に作成済み
2. 営業予実管理スプレッドシートを開く
   - https://docs.google.com/spreadsheets/d/13PzSnGekGxDWX7B1_TwczNibR6j_JxDb3UuquPX1GyQ
3. 拡張機能 → Apps Script
4. `scripts/gas-create-checklist-sheet.js` の内容をコピー&ペースト
5. 関数 `createChecklistSheet()` を実行
6. 権限を承認（初回のみ）
7. スプレッドシートで確認: シート「チェックリスト管理」が作成されているか
   - [ ] ヘッダー行が青色背景、白文字、太字
   - [ ] A列: 契約ID
   - [ ] B〜AI列: step1_check1 〜 step13_check2（34項目）

---

### Step 3: チェックリスト項目のID定義

**所要時間**: 20分

**タスク**:
1. `data/contract-workflow.ts`を確認
2. 各ステップのチェック項目に対応するIDを抽出
3. `scripts/create-checklist-sheet.ts`のヘッダー配列が正しいか確認
4. チェック項目の合計数を確認（34項目）

**重要**: `contract-workflow.ts`のチェック項目IDと、シートの列ヘッダーが一致している必要がある

---

### Step 4: API実装

**所要時間**: 30分

**タスク**:
1. `lib/google-sheets.ts`に`appendSheetRow`関数を追加
2. `app/api/contract/checklist/[id]/route.ts`を作成
   - [ ] GET: チェックリスト取得
   - [ ] PUT: チェックリスト更新
3. curlでテスト:
```bash
# 取得
curl "http://127.0.0.1:3000/api/contract/checklist/1"

# 更新
curl -X PUT "http://127.0.0.1:3000/api/contract/checklist/1" \
  -H "Content-Type: application/json" \
  -d '{"checkId":"step1_check1","checked":true}'
```

---

### Step 5: UI実装

**所要時間**: 30分

**タスク**:
1. `components/workflow/SidePanel.tsx`を修正
   - [ ] `contractId`をpropsに追加
   - [ ] `handleChecklistUpdate`関数を追加
   - [ ] チェックボックスのonChangeを修正
2. `app/dashboard/workflow/contract/page.tsx`を修正
   - [ ] 契約選択時にチェックリストを取得
   - [ ] SidePanelに`contractId`を渡す
3. テスト: チェックボックスをクリックしてスプレッドシートに反映されるか

---

### Step 6: 動作確認

**所要時間**: 20分

**テストケース**:
1. 契約を選択 → ProgressBarが表示される
2. チェックボックスをクリック → スプレッドシートに保存される
3. ページをリロード → チェック状態が復元される
4. 契約選択を解除 → ProgressBarが消える
5. 別の契約を選択 → 別のチェック状態が読み込まれる

---

## テスト計画

### テストケース1: ProgressBar表示制御

1. 契約未選択時 → ProgressBarが表示されない
2. 契約を選択 → ProgressBarが表示される
3. 契約選択を解除 → ProgressBarが消える
4. 別の契約を選択 → ProgressBarが再度表示される

---

### テストケース2: チェックリスト保存・復元

1. 契約を選択
2. ステップカードをクリック → サイドパネルが開く
3. チェックボックスをクリック
4. スプレッドシート「チェックリスト管理」を確認 → TRUE/FALSEが記録されている
5. ページをリロード
6. 同じ契約を選択
7. サイドパネルを開く → チェック状態が復元されている

---

### テストケース3: 複数契約のチェックリスト

1. 契約1を選択 → チェック項目1, 2をチェック
2. 契約2を選択 → チェック項目3をチェック
3. 契約1を再選択 → チェック項目1, 2がチェック済み（3は未チェック）
4. 契約2を再選択 → チェック項目3がチェック済み（1, 2は未チェック）

---

### テストケース4: エラーハンドリング

1. ネットワークエラーをシミュレート（DevToolsでオフライン）
2. チェックボックスをクリック
3. エラーメッセージが表示される
4. チェック状態が元に戻る

---

## 重要な注意事項

### ❌ やってはいけないこと

1. **LocalStorageを残さない**
   - `lib/workflow-storage.ts`を完全に削除する
   - `loadWorkflowState`, `saveWorkflowState`の呼び出しを全て削除

2. **チェック項目IDを変更しない**
   - `data/contract-workflow.ts`のチェック項目IDは変更しない
   - シートのヘッダーと一致させる必要がある

3. **行番号の計算を間違えない**
   - ヘッダー1行 + データ開始行2行目 = `rowIndex + 2`

4. **列の計算を間違えない**
   - A列 = 契約ID
   - B列 = step1_check1（インデックス0）
   - C列 = step1_check2（インデックス1）
   - `String.fromCharCode(66 + columnIndex)` で列名を取得

---

### ✅ やるべきこと

1. **エラーハンドリングを徹底する**
   - API呼び出し失敗時は元の状態に戻す
   - ユーザーにエラーメッセージを表示

2. **楽観的UI更新を実装する**
   - チェックボックスをクリックしたら即座にUIを更新
   - APIは非同期で実行

3. **console.logを残す**
   - デバッグ用にログを追加
   - 特にAPI呼び出し時とエラー時

4. **契約IDのバリデーション**
   - `contractId`が存在する場合のみAPI呼び出し

---

## 完了条件

Phase 1（ProgressBar表示制御）:
- [ ] ProgressBarが契約選択時のみ表示される
- [ ] 契約選択解除時にProgressBarが消える
- [ ] LocalStorage関連のコードが完全に削除される

Phase 2-5（チェックリスト機能）:
- [ ] チェックリスト管理シートが作成される
- [ ] `/api/contract/checklist/[id]`が正しく動作する
- [ ] チェックボックスをクリックするとスプレッドシートに保存される
- [ ] ページをリロードしてもチェック状態が復元される
- [ ] 複数の契約で独立したチェック状態を管理できる
- [ ] エラー時に適切なフィードバックが表示される

---

## 参照ドキュメント

1. **契約業務フロー定義**: `data/contract-workflow.ts`
2. **Google Sheets lib**: `lib/google-sheets.ts`
3. **SidePanel**: `components/workflow/SidePanel.tsx`
4. **contract/page.tsx**: `app/dashboard/workflow/contract/page.tsx`

---

**作成日**: 2025年10月12日
**作成者**: Claude Code
**バージョン**: v1.0（暗黙知排除版）
**次のステップ**: Phase 1の実装を開始

以上
