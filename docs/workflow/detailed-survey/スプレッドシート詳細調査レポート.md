# スプレッドシート詳細調査レポート

**作成日**: 2025年10月11日
**作成者**: Claude Code
**目的**: 契約業務フロー統合の実装に必要な、スプレッドシートの詳細仕様を調査・記録する

---

## 📋 調査対象

### 営業予実管理スプレッドシート

**スプレッドシートID**: `13PzSnGekGxDWX7B1_TwczNibR6j_JxDb3UuquPX1GyQ`
**環境変数**: `SALES_SPREADSHEET_ID`

### 調査対象シート

**シート名**: 契約・入金管理
**シートID**: 791125447

---

## 📊 契約・入金管理シートの詳細仕様

### ヘッダー構造（全16項目）

| 列 | 項目名 | データ型 | 必須 | 説明 | 業務フローステップ対応 |
|----|--------|---------|------|------|---------------------|
| A | ID | 数値 | ✅ | 契約ID（連番） | - |
| B | 企業名 | 文字列 | ✅ | 契約企業名 | ステップ① 情報収集 |
| C | 契約サービス | 文字列 | ✅ | サービス名（例: ゆめマガ） | ステップ① 情報収集 |
| D | 契約日 | 日付 | - | 契約成立日（YYYY/MM/DD形式） | ステップ⑦ 契約完了確認 |
| E | 契約金額 | 金額 | ✅ | 契約金額（税込、¥表記あり） | ステップ① 情報収集 |
| F | 入金方法 | 文字列 | ✅ | 一括 / 分割 | ステップ① 情報収集 |
| G | 契約書送付 | 日付 | - | 基本契約書送付日（YYYY/MM/DD形式） | ステップ③ 基本契約書の押印・送信 |
| H | 契約書回収 | 日付 | - | 基本契約書回収日（YYYY/MM/DD形式） | ステップ⑦ 契約完了確認 |
| I | 申込書送付 | 日付 | - | 申込書送付日（YYYY/MM/DD形式） | ステップ⑤ 申込書の押印・送信 |
| J | 申込書回収 | 日付 | - | 申込書回収日（YYYY/MM/DD形式） | ステップ⑦ 契約完了確認 |
| K | 入金予定日 | 日付 | ✅ | 入金予定日（YYYY/MM/DD形式） | ステップ⑧ 請求書作成・送付 |
| L | 入金実績日 | 日付 | - | 実際の入金日（YYYY/MM/DD形式） | ステップ⑨ 入金確認 |
| M | 入金ステータス | 文字列 | ✅ | 未入金 / 入金済 | ステップ⑨ 入金確認 |
| N | 遅延日数 | 数値 | - | 入金遅延日数（自動計算） | - |
| O | 掲載開始号 | 文字列 | ✅ | 掲載開始号（例: 2025年12月号） | ステップ⑬ 掲載 |
| P | 備考 | 文字列 | - | 備考欄 | - |

### データ形式の詳細

#### 日付フィールド（D, G, H, I, J, K, L列）

**形式**: `YYYY/MM/DD`（例: `2025/10/09`）
**空欄の扱い**: 空文字列（`""`）
**表示**: Google Sheets上では自動的に日付形式で表示される

**実装時の注意**:
- Google Sheets APIから取得した日付は文字列として取得される
- 空欄の場合は`undefined`または空文字列（`""`）になる
- フォーマット変換が必要な場合は`new Date()`でパースする

#### 金額フィールド（E列）

**形式**: `¥XXX,XXX`（例: `¥744,000`）
**表示**: カンマ区切り、円記号付き
**実装時の注意**:
- APIから取得した値は`¥`記号とカンマが含まれる文字列
- 数値として扱う場合は`¥`とカンマを除去してから`parseInt()`でパース
- 表示時はカンマ区切りに再フォーマット

#### 文字列フィールド（B, C, F, M, O, P列）

**形式**: プレーンテキスト
**空欄の扱い**: 空文字列（`""`）または`undefined`

**入金ステータス（M列）の値**:
- `未入金`: 入金実績日（L列）が空欄の場合
- `入金済`: 入金実績日（L列）に日付が入っている場合

#### 数値フィールド（A, N列）

**形式**: 数値（カンマなし）
**空欄の扱い**: 空文字列（`""`）または`0`

---

## 📝 サンプルデータ

### サンプル行1（現在のデータ）

```
A: 1
B: 信藤建設
C: ゆめマガ
D: 2025/10/09
E: ¥744,000
F: 一括
G: （空欄）
H: （空欄）
I: （空欄）
J: （空欄）
K: 2025/11/30
L: （空欄）
M: 未入金
N: （空欄）
O: 2025年12月号
P: （空欄）
```

### サンプル行2（入金完了の例）

```
A: 2
B: 株式会社ABC
C: ゆめマガ
D: 2025/09/15
E: ¥960,000
F: 一括
G: 2025/09/15
H: 2025/09/25
I: 2025/09/15
J: 2025/09/25
K: 2025/10/15
L: 2025/10/15
M: 入金済
N: 0
O: 2025年11月号
P: （空欄）
```

---

## 🔄 契約業務フロー13ステップとの対応関係

| ステップ | タイトル | 主要関連列 | 記録タイミング | 記録内容 |
|---------|---------|-----------|--------------|---------|
| ① | 情報収集 | B, C, E, F, K, O | 契約前 | 企業名、サービス名、金額、入金予定日、掲載開始号 |
| ② | 基本契約書作成 | - | - | （Google Docsで作成） |
| ③ | 基本契約書の押印・送信 | G | 送信時 | 契約書送付日 |
| ④ | 申込書作成 | - | - | （Google Spreadsheetsで作成） |
| ⑤ | 申込書の押印・送信 | I | 送信時 | 申込書送付日 |
| ⑥ | 重要事項説明（任意） | - | - | - |
| ⑦ | 契約完了確認 | D, H, J | 契約完了時 | 契約日、契約書回収日、申込書回収日 |
| ⑧ | 請求書作成・送付 | K | 請求書作成時 | 入金予定日（既に記録済みの場合が多い） |
| ⑨ | 入金確認 | L, M, N | 入金確認時 | 入金実績日、入金ステータス、遅延日数 |
| ⑩ | 入金管理シート更新 | - | - | （月次予実管理シートに記録） |
| ⑪ | 入金確認連絡・原稿依頼 | - | - | - |
| ⑫ | 制作・校正 | - | - | （ゆめマガ制作進捗ダッシュボード） |
| ⑬ | 掲載 | O | 掲載開始時 | 掲載開始号（既に記録済みの場合が多い） |

### 重要な発見

**7ステップが直接スプレッドシートと連動**:
- ステップ③: 契約書送付日（G列）
- ステップ⑤: 申込書送付日（I列）
- ステップ⑦: 契約日（D列）、契約書回収日（H列）、申込書回収日（J列）
- ステップ⑧: 入金予定日（K列）
- ステップ⑨: 入金実績日（L列）、入金ステータス（M列）
- ステップ⑬: 掲載開始号（O列）

---

## 📋 Phase 1（MVP）実装時の取り扱い

### 読み取り（取得）対象

契約業務フローダッシュボードで以下のデータを取得・表示:

1. **契約一覧テーブル**
   - 企業名（B列）
   - 契約日（D列）
   - 契約金額（E列）
   - 入金予定日（K列）
   - 入金実績日（L列）
   - 入金ステータス（M列）

2. **表示フィールド**
   - 全16項目を取得
   - テーブル形式で表示（実装草案の`ContractTable`コンポーネント）

### 書き込み（操作）対象

**Phase 1では書き込みなし**:
- LocalStorageのみ使用
- Google Sheetsへの書き込みは Phase 2以降

---

## 📊 API設計

### エンドポイント

**パス**: `/api/contract/list`
**メソッド**: `GET`

### レスポンス形式

```typescript
{
  success: boolean;
  data: ContractData[];
  error?: string;
}
```

### `ContractData`型定義

```typescript
export interface ContractData {
  id: number;                      // A列
  companyName: string;             // B列
  contractService: string;         // C列
  contractDate: string;            // D列（YYYY/MM/DD形式）
  amount: string;                  // E列（¥XXX,XXX形式）
  paymentMethod: string;           // F列
  contractSentDate?: string;       // G列
  contractReceivedDate?: string;   // H列
  applicationSentDate?: string;    // I列
  applicationReceivedDate?: string;// J列
  paymentDueDate: string;          // K列
  paymentActualDate?: string;      // L列
  paymentStatus: string;           // M列
  delayDays?: number;              // N列
  publicationIssue: string;        // O列
  notes?: string;                  // P列
}
```

### データパース処理

**実装方針**:

1. Google Sheets APIから取得した2次元配列（`any[][]`）をパース
2. 1行目（ヘッダー）をスキップ
3. 各行を`ContractData`型に変換
4. 空行はスキップ

**パースロジックの例**:

```typescript
function parseContractData(rows: any[][]): ContractData[] {
  const data: ContractData[] = [];

  // 1行目（ヘッダー）をスキップ
  for (let i = 1; i < rows.length; i++) {
    const row = rows[i];

    // 空行をスキップ
    if (!row[0] || !row[1]) continue;

    data.push({
      id: parseInt(row[0]) || 0,
      companyName: row[1] || '',
      contractService: row[2] || '',
      contractDate: row[3] || '',
      amount: row[4] || '',
      paymentMethod: row[5] || '',
      contractSentDate: row[6] || undefined,
      contractReceivedDate: row[7] || undefined,
      applicationSentDate: row[8] || undefined,
      applicationReceivedDate: row[9] || undefined,
      paymentDueDate: row[10] || '',
      paymentActualDate: row[11] || undefined,
      paymentStatus: row[12] || '未入金',
      delayDays: parseInt(row[13]) || undefined,
      publicationIssue: row[14] || '',
      notes: row[15] || undefined
    });
  }

  return data;
}
```

---

## 🎯 実装時の注意事項

### 日付フィールドの扱い

1. **取得時**: Google Sheets APIから取得した日付は文字列（`YYYY/MM/DD`）
2. **表示時**: そのまま表示（フォーマット変換不要）
3. **空欄**: `undefined`または空文字列（`""`）として扱う

### 金額フィールドの扱い

1. **取得時**: `¥`記号とカンマが含まれる文字列（例: `¥744,000`）
2. **表示時**: そのまま表示（フォーマット済み）
3. **数値計算が必要な場合**: `¥`とカンマを除去してから`parseInt()`

**金額パース関数の例**:

```typescript
function parseAmount(amountStr: string): number {
  // ¥とカンマを除去
  const numStr = amountStr.replace(/[¥,]/g, '');
  return parseInt(numStr) || 0;
}
```

### 入金ステータスの判定

**ロジック**:
- 入金実績日（L列）が空欄 → `未入金`
- 入金実績日（L列）に日付あり → `入金済`

**実装例**:

```typescript
function getPaymentStatus(paymentActualDate?: string): string {
  return paymentActualDate && paymentActualDate !== '' ? '入金済' : '未入金';
}
```

---

## 📚 参照ドキュメント

### 必読

1. **契約書作成_業務フローガイド.md**
   - 13ステップの詳細手順
   - 各ステップのやること、チェックリスト

2. **実装草案.md**
   - UI/UX設計
   - コンポーネント設計
   - Phase 1実装範囲

3. **アクティブスプレッドシート調査レポート.md**
   - 全シート一覧
   - 契約・入金管理シートの概要

---

## ✅ 調査完了事項

- ✅ 契約・入金管理シートの全16項目の詳細仕様を把握
- ✅ データ形式（日付、金額、文字列、数値）を理解
- ✅ 契約業務フロー13ステップとの対応関係を明確化
- ✅ Phase 1実装時のAPI設計方針を策定
- ✅ データパースロジックの実装方針を決定

---

**調査完了日**: 2025年10月11日
**調査者**: Claude Code
**次の作業**: Google Drive詳細調査レポート作成

以上
