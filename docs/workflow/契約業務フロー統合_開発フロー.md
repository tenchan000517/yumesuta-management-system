# 契約業務フロー統合 - 開発フロー

**作成日**: 2025年10月11日
**作成者**: システム開発マネージャー
**目的**: 契約業務フロー統合の開発フェーズと作業手順の明確化

---

## 🎯 現在の進捗状況

**現在のフェーズ**: Phase 2 - スプレッドシート書き込み・Google Drive連動
**ステータス**: 🔄 進行中（Phase 2.1実装完了）
**最終更新日**: 2025年10月12日
**担当者**: Claude Code（次世代）

### 進捗サマリー
- ✅ 事務側要件定義受領
- ✅ システム側要望・方針ドキュメント作成
- ✅ 開発フロードキュメント作成
- ✅ フェーズ1: 既存システム調査完了
- ✅ フェーズ2: アクティブデータ調査完了
- ✅ フェーズ3: 実装草案ディスカッション完了
- ✅ フェーズ4: 詳細データ追加調査完了
- ✅ フェーズ5: 完全実装計画書作成完了
- ✅ フェーズ6: Phase 1（MVP）実装・テスト完了
- ✅ フェーズ1.5: 完全実装計画書作成完了
- ✅ フェーズ1.5: Phase 1.5-1（リソースメニュー・フィルタ）完了
- ✅ フェーズ1.5: Phase 1.5-2（リマインダーカード）完了
- ✅ フェーズ1.5: Phase 1.5-3（新規契約作成機能）完了
- ✅ フェーズ1.5: Phase 1.5-4（メインページ統合）完了
- ✅ フェーズ1.5: Phase 1.5-4.5（リマインダー表示改善）完了
- ✅ フェーズ1.5: Phase 1.5-5（統合テスト）完了
- ✅ フェーズ1.6: 完全実装計画書作成完了
- ✅ フェーズ1.6: 契約企業マスタシート作成完了（GASスクリプトで実施）
- ✅ フェーズ1.6: API修正完了（reminders, create, [id], list, company-master）
- ✅ フェーズ1.6: UI実装完了（SidePanel企業情報セクション、詳細モーダル）
- ✅ フェーズ1.6: Phase 1.6完了
- ✅ Phase 2: Phase 2完全実装計画書作成完了
- ✅ Phase 2: Phase 2.1（ステップ完了時のスプレッドシート書き込み）完了

### 引き継ぎ事項（フェーズ1）

**重要発見事項**:
- Google Drive APIは、メインダッシュボードと調査対象の2つのダッシュボードでは使用されていません。OAuth認証ステータスチェックAPI (`/api/auth/status`) のみ確認されています。
- すべてのダッシュボードで手動更新方式（初回マウント時に自動取得、以降は手動更新ボタン）が採用されています。
- API取得は`Promise.all`を使用した並列取得パターンが主流です。
- UI/UXは完全にカードベースレイアウトで統一されており、Tailwind CSS v4 + lucide-reactアイコンで実装されています。
- 型定義は`types/`ディレクトリ配下で機能ごとに分割管理されています。

### 引き継ぎ事項（フェーズ2）

**重要発見事項**:
- 営業予実管理スプレッドシートには**9つのシート**があり、そのうち「契約・入金管理」シートが契約業務フロー13ステップに直接対応しています。
- 契約・入金管理シートは**16項目**で構成され、契約フロー の7ステップ（③⑤⑦⑧⑨⑩⑬）がスプレッドシートと連動します。
- Google Drive エビデンス保存フォルダは現在空で、企業ごと・契約ごとの階層構造で保存する設計方針を策定しました。
- 既存のシート構造を活用することで、新規シート作成が不要であることを確認しました。

### 引き継ぎ事項（フェーズ3）

**実装方針の決定事項**:
- UI形式: **カードグリッド（5カラム）+ Notion風サイドパネル**方式を採用
- プログレスバー: **スクロール追従型マイルストーン**（主要5ステップ: ①③⑦⑨⑬）を上部固定表示
- サイドパネル: カードクリック時に右からスライドイン（300msアニメーション）
- Phase 1実装範囲: 基本UI、チェックリスト（LocalStorage）、メール例文モーダル、契約・入金管理シート連動（読み取りのみ）
- Phase 2以降: スプレッドシート書き込み、Google Drive連動、ファイルアップロード
- フェーズ4で詳細調査が必要な項目: 業務フローガイド全文、契約・入金管理シート全データ、Google Drive API実装方法

### 引き継ぎ事項（フェーズ4）

**詳細調査完了事項**:
- 業務フローガイド全文（13ステップ）、情報収集フォーマット、リーガルチェックプロンプトの読み込み完了
- 契約・入金管理シート全16項目の詳細仕様を把握（データ型、形式、業務フローとの対応関係）
- API設計（`/api/contract/list`）とデータパース処理の実装方針を策定
- Google Drive フォルダ階層構造（企業フォルダ→契約フォルダ→ファイル）の詳細設計完了
- ファイル命名規則（基本契約書、申込書、請求書、エビデンス）の詳細仕様を策定
- Phase 2以降のGoogle Drive API実装設計（フォルダ作成、ファイルアップロード、ファイル一覧取得）を完了
- 2つの詳細調査レポート作成完了

### 引き継ぎ事項（フェーズ5）

**完全実装計画書作成完了**:
- フェーズ1〜4の全ドキュメント（10件）と業務フローガイド（3件）を統合
- 完全実装計画書を作成（100ページ超の詳細ドキュメント）
- プロジェクト概要、システム設計、技術仕様、データフロー設計、UI/UX設計、API設計、コンポーネント設計、型定義、静的データ設計、実装スケジュール、テスト計画、Phase 2以降への拡張を網羅
- 実装に必要な全てのコード例、型定義、データ構造を記載
- Phase 1（MVP）の完了条件を明確化
- Phase 1-1〜1-4の4日間実装スケジュールを策定
- **次世代Claude Codeはこの完全実装計画書に従って実装を開始できます**

### 引き継ぎ事項（フェーズ6）

**Phase 1（MVP）実装完了**:
- ✅ **Phase 1-1**: 基本UI実装完了
  - 型定義作成（types/workflow.ts）
  - 静的データ作成（data/contract-workflow.ts, data/email-templates.ts）
  - LocalStorage管理（lib/workflow-storage.ts）
  - プログレスバーコンポーネント（components/workflow/ProgressBar.tsx）
  - ステップカードコンポーネント（components/workflow/StepCard.tsx）
- ✅ **Phase 1-2**: インタラクション実装完了
  - サイドパネルコンポーネント（components/workflow/SidePanel.tsx）
  - メール例文モーダル（components/workflow/EmailModal.tsx）
  - チェックリスト機能・LocalStorage保存機能
- ✅ **Phase 1-3**: データ連動実装完了
  - 契約一覧API（/api/contract/list）
  - ContractTableコンポーネント（components/workflow/ContractTable.tsx）
  - Google Sheets連動（読み取りのみ）
- ✅ **Phase 1-4**: メインダッシュボード統合完了
  - app/page.tsx に「契約業務フロー」メニュー追加（192-195行目）
  - メインページ実装完了（app/dashboard/workflow/contract/page.tsx）

**実装された機能**:
- 13ステップのカードグリッド表示（5カラム、レスポンシブ対応）
- スクロール追従型プログレスバー（主要5ステップ: ①③⑦⑨⑬）
- Notion風サイドパネル（右からスライドイン・300msアニメーション）
- チェックリスト機能（LocalStorage保存）
- メール例文モーダル＋コピー機能
- 外部リンクボタン（原本URL）
- 契約・入金管理シート連動（読み取りのみ）
- 手動更新ボタン

**未実装（Phase 2以降）**:
- スプレッドシートへの書き込み
- Google Driveファイルアップロード
- 入力フォームからのスプレッドシート更新
- 自動リマインダー機能
- 複数契約の同時管理

**テスト完了**:
- ✅ 動作確認・テスト実施完了
- ✅ ユーザー受け入れテスト完了

**Phase 1で判明した問題点**:
- Phase 1の実装では「どの企業の」契約を管理しているのか不明確
- 新規契約の開始方法が未実装
- 進捗管理列が存在しない（LocalStorageのみで他ユーザーと共有不可）
- リソースへのアクセス導線がない（契約未選択時に情報収集フォーマットにアクセス不可）

**次のステップ**:
- フェーズ1.5: Phase 1の問題点を修正し、実運用可能にする

---

### 引き継ぎ事項（フェーズ1.5計画策定）

**Phase 1.5完全実装計画書作成完了**:
- Phase 1実装後にユーザーとのディスカッションで判明した4つの問題点を整理
- ユーザーから2025年10月12日に指示された要件を事実のみで記録
- 7つの要件（新規契約作成、契約選択、進捗管理、リマインダー、フィルタ、リソースメニュー、カードクリック時の挙動）を定義
- データ構造設計（契約・入金管理シートにQ〜AC列を追加）
- API設計（4つのAPI: reminders, create, [id], parse）
- UI/UX設計（リマインダーカード、フィルタ、新規契約モーダル等）
- コンポーネント設計（4つの新規コンポーネント）
- 実装スケジュール（5日間: Phase 1.5-1〜1.5-5）
- テスト計画
- **次世代Claude Codeはこの計画書に従って実装を開始できます**

**重要**: Phase 1.5完全実装計画書（`docs/workflow/契約業務フロー統合_Phase1.5_完全実装計画書.md`）を必ず読んでから作業を開始してください

---

### 引き継ぎ事項（フェーズ1.5実装 Phase 1.5-4 完了）

**2025年10月12日 Phase 1.5-4実装とデバッグ完了**:

#### ✅ 完了した作業

**Phase 1.5-4: メインページ統合**
- ✅ 新規コンポーネント（ResourceMenu, FilterDropdown, ReminderCard, NewContractModal）のインポート
- ✅ リマインダー機能の状態管理追加（reminders, isLoadingReminders, filterMode, selectedContractId, selectedContract）
- ✅ fetchReminders()関数の実装
- ✅ handleSelectContract()関数の実装（契約選択→13ステップ表示）
- ✅ handleReminderAction()関数の実装
- ✅ handleNewContractSuccess()関数の実装
- ✅ ヘッダーにResourceMenuと新規契約ボタンを追加
- ✅ リマインダーカードグリッドの実装
- ✅ 13ステップカードグリッドを契約選択時のみ表示するよう変更
- ✅ 契約・入金管理テーブルを常に表示するよう修正
- ✅ 2行ヘッダー構造対応（`.slice(1)` → `.slice(2)`）
  - `/api/contract/reminders/route.ts` 修正完了
  - `/api/contract/create/route.ts` 修正完了
  - `/api/contract/[id]/route.ts` 修正完了
- ✅ フィルタリングロジック修正（`app/dashboard/workflow/contract/page.tsx` 189-195行目）
  - 「進行中のみ」モードでcompletedタイプのカードのみ非表示に修正

#### 🔍 判明した問題と解決

**スプレッドシート構造の確認事項**:
- 営業予実管理スプレッドシートは**2行ヘッダー構造**（1行目=タイトル行、2行目=ヘッダー行）
- 契約・入金管理シートにQ〜AC列（進捗管理列）を手動で追加済み
  - Q1: タイトル（統合タイトル）
  - Q2〜AC2: ヘッダー（「ステップ1完了日」〜「ステップ13完了日」）
  - Q3〜: データ行
- すべてのAPIを2行ヘッダー構造に対応（`.slice(2)`使用）

**解決した問題**:
- ✅ リマインダーAPIのテスト実施: APIは正常に動作し、1件のリマインダー（信藤建設の入金待ち）が返却されることを確認
- ✅ フィルタリングロジックの問題を発見・修正: `reminder.type !== 'completed' || reminder.type === 'contract-expiry-near'` という論理的に正しくない条件を修正
- ✅ 修正後のロジック: `if (reminder.type === 'completed') { return false; }` でcompletedのみ除外

**次のステップ**:
- リマインダーカード表示の改善（Phase 1.5-4.5として実施）
- Phase 1.5-5: 統合テスト・デバッグ

---

### 引き継ぎ事項（Phase 1.5-4.5 リマインダー表示改善 - 完了）

**2025年10月12日 Phase 1.5-4.5実装完了**:

#### 📋 背景と課題

**現状の問題点**:
1. **進行中カードが不十分**: 「進行中」と表示されるだけで、「次に何をすべきか」が不明確
2. **契約満了日の計算ロジックが不適切**: 掲載開始号ベースではなく、契約日ベースで計算すべき

**ユーザーの要望**:
- 進行中カードに「次のステップ: ③ 基本契約書の押印・送信」のように具体的に表示すること
- 契約満了日を契約日の1年後として計算すること

#### ✅ 既に完了している作業

**1. 型定義の追加（types/workflow.ts 97-98行目）**:
```typescript
nextStep?: number;              // 次に進むべきステップ番号
nextStepTitle?: string;         // 次に進むべきステップのタイトル
```

**2. APIの修正（/api/contract/reminders/route.ts）**:
- ステップタイトルのマッピング追加（6-20行目）
- リマインダーロジックの修正（60-187行目）
  - ステップ⑧完了後のみ入金チェックを実施
  - 進行中カードに nextStep と nextStepTitle を含める
  - 入金待ち・入金遅延カードにも nextStep: 9 を明示

#### ✅ 完了した作業

**1. ReminderCard.tsx コンポーネントの修正完了**

**ファイル**: `components/workflow/ReminderCard.tsx`

**実装内容**:
- ✅ 進行中カード（131-149行目）: nextStep と nextStepTitle を表示
  - 「次のステップ: ① 情報収集」形式で表示
  - 「現在の進捗: 0/13 ステップ完了」を表示
  - プログレスバーと併用
  - ArrowRight アイコンを使用して視覚的に表示
- ✅ 入金待ちカード（101-113行目）: nextStepTitle を表示
  - 「次のアクション: ⑨ 入金確認」形式で表示
- ✅ 入金遅延カード（116-128行目）: nextStepTitle を表示
  - 「次のアクション: ⑨ 入金確認」形式で表示

**2. 契約満了日計算ロジックの修正完了**

**ファイル**: `/api/contract/reminders/route.ts`

**実装内容**:
- ✅ 関数名変更: `calculateContractEndDateFromContractDate` （210-222行目）
- ✅ 引数変更: `contractDate: string`（契約日を受け取る）
- ✅ ロジック変更: 契約日から1年後の日付を計算
  - 例: "2024/10/12" → "2025/10/12"
- ✅ 呼び出し側修正（163行目）: `row[3]`（D列 = 契約日）を渡す

**実装済みコード**:
```typescript
function calculateContractEndDateFromContractDate(contractDate: string): string {
  // 例: "2024/10/12" → "2025/10/12"
  if (!contractDate) return '';

  const date = new Date(contractDate);
  date.setFullYear(date.getFullYear() + 1);

  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');

  return `${year}/${month}/${day}`;
}
```

#### ✅ 完了確認

- ✅ ReminderCard.tsx で nextStep と nextStepTitle が表示される
- ✅ 進行中カードに「次のステップ: ① 情報収集」が表示される
- ✅ 入金待ち・入金遅延カードに「次のアクション: ⑨ 入金確認」が表示される
- ✅ 契約満了日が契約日の1年後として計算される
- ✅ APIテストで正しい契約満了日が返却される（信藤建設の例で確認済み）

#### 📝 次世代Claude Codeへの引き継ぎ

**Phase 1.5-4.5は完全に実装済みです**。前世代Claude Codeが実装しましたが、開発フローの更新を忘れていました。

- コードレビュー完了: ReminderCard.tsx（131-149行目）にnextStep表示実装済み
- コードレビュー完了: /api/contract/reminders/route.ts（163, 210-222行目）に契約日ベース計算実装済み
- APIテスト完了: curl テストで正しいレスポンスを確認

**完了日**: 2025年10月12日

---

### 引き継ぎ事項（フェーズ1.5実装 Phase 1.5-1〜1.5-3）

**2025年10月12日 Phase 1.5-1〜1.5-3実装完了**:

#### ✅ 完了した作業

**1. 型定義の追加（types/workflow.ts）**
- `ContractData` に進捗管理フィールド（step1CompletedAt〜step13CompletedAt）を追加（Q〜AC列対応）
- `ReminderCard` 型定義追加（6種類のカードタイプ: new-contract-required, payment-overdue, payment-pending, in-progress, completed, contract-expiry-near）
- `ParsedContractForm` 型定義追加（情報収集フォーマットのパース結果）

**2. 新規コンポーネント作成（4つ）**
- ✅ `components/workflow/ResourceMenu.tsx` - ヘッダー常時表示のリソースドロップダウンメニュー（情報収集フォーマット、基本契約書、申込書、マネーフォワードへのリンク）
- ✅ `components/workflow/FilterDropdown.tsx` - リマインダーカードのフィルタ切り替え（「進行中のみ」「すべて表示」）
- ✅ `components/workflow/ReminderCard.tsx` - 6種類のリマインダーカード表示（色分け、プログレスバー、優先度別表示）
- ✅ `components/workflow/NewContractModal.tsx` - 新規契約作成モーダル（情報収集フォーマット貼り付け→パース→契約作成）

**3. 新規API作成（4つ）**
- ✅ `/api/contract/parse` - 情報収集フォーマットのテキストをパースして構造化データに変換（和暦→西暦変換、正規表現による抽出）
- ✅ `/api/contract/create` - パース結果を元に契約・入金管理シートに新しい行を追加（Google Sheets API書き込み）
- ✅ `/api/contract/[id]` - 指定されたIDの契約データを取得（進捗状況含む、A〜AC列全取得）
- ✅ `/api/contract/reminders` - リマインダーカード生成API（顧客マスタ「受注」企業取得→契約シートと照合→6種類のリマインダー生成→優先度順ソート）

#### 📋 残りの作業

**Phase 1.5-4: メインページ統合**
- 既存の `app/dashboard/workflow/contract/page.tsx` への統合が必要
- ResourceMenu、FilterDropdown、ReminderCard、NewContractModalのインポートと配置
- リマインダーカードグリッドの実装
- 契約選択時に13ステップカードグリッドを表示する機能
- 新規契約ボタンの追加

**Phase 1.5-5: 統合テスト・デバッグ**
- 全機能の動作確認
- エラーハンドリング確認
- レスポンシブデザイン確認

#### 🔍 重要な技術詳細

**APIの実装方針**:
- `/api/contract/reminders` は顧客マスタ（S列「受注」）と契約・入金管理シート（A〜AC列）の2つのシートを読み取る
- 契約満了日は掲載開始号から12ヶ月後の月末を計算（例: 2025年12月号 → 2026/11/30）
- リマインダーの優先度: high（新規契約必要、入金遅延）> medium（入金待ち、契約満了近い）> low（進行中、完了）
- `/api/contract/create` はGoogle Sheets APIのappendメソッドを使用（最大ID+1で新規ID生成）

**コンポーネントの設計**:
- すべてのコンポーネントは `'use client'` ディレクティブ使用（クライアントサイドレンダリング）
- lucide-reactアイコンのみ使用（既存システムの統一性維持）
- Tailwind CSS v4のユーティリティクラスで実装
- モーダルのz-index: 60（既存のサイドパネルより上）

**次世代Claude Codeへの指示**:
1. 既存の `app/dashboard/workflow/contract/page.tsx` を必ず読んでから統合作業を開始すること
2. Phase 1で実装済みの13ステップカードグリッド、プログレスバー、サイドパネルは維持すること
3. リマインダーカードは13ステップカードグリッドの**上部**に配置すること
4. 契約未選択時は13ステップカードグリッドを非表示にし、リマインダーカードのみ表示すること
5. 新規契約作成後は自動的にリマインダーカードをリフレッシュすること

---

## 📋 開発フェーズ概要

| フェーズ | タイトル | ステータス | 完了日 |
|---------|---------|----------|--------|
| フェーズ1 | 既存システム調査 | ✅ 完了 | 2025-10-11 |
| フェーズ2 | アクティブデータ調査 | ✅ 完了 | 2025-10-11 |
| フェーズ3 | 実装草案ディスカッション | ✅ 完了 | 2025-10-11 |
| フェーズ4 | 詳細データ追加調査 | ✅ 完了 | 2025-10-11 |
| フェーズ5 | 完全実装計画書作成 | ✅ 完了 | 2025-10-11 |
| フェーズ6 | Phase 1（MVP）実装 | ✅ 完了 | 2025-10-12 |
| フェーズ1.5 | Phase 1問題点の修正・実運用化 | ✅ 完了 | 2025-10-12 |
| フェーズ1.6 | 顧客正式情報マスタの作成・企業ID管理 | ✅ 完了 | 2025-10-12 |
| **Phase 2** | **スプレッドシート書き込み・Google Drive連動** | **🔄 進行中** | **-** |

---

## 🔍 フェーズ1: 既存システム調査

**ステータス**: ✅ 完了

### 目的
既存システムの設計思想、UI/UX、技術仕様を事実ベースで把握する

### 調査対象と進捗

#### 1. Google Drive API
- ✅ Drive API の実装方法（調査対象ダッシュボードでは未使用を確認）
- ✅ 使用されているメソッド（OAuth認証ステータスチェックAPIのみ）
- ✅ ファイル/フォルダ操作の実装パターン（調査対象外）

#### 2. Google Sheets lib
- ✅ `lib/google-sheets.ts` の調査
- ✅ 使用されているメソッド（getSheetData, getBatchSheetData, getSpreadsheetMetadata, updateSheetCell等）
- ✅ データ取得・解析の実装パターン

#### 3. ゆめマガ制作進捗ダッシュボード
- **対象ディレクトリ**: `app/dashboard/yumemaga-v2/`
- ✅ UI/UX構造
- ✅ データフロー
- ✅ コンポーネント設計

#### 4. 営業進捗管理ダッシュボード
- **対象ディレクトリ**: `app/dashboard/sales/`
- ✅ UI/UX構造
- ✅ データフロー
- ✅ コンポーネント設計

#### 5. メインダッシュボード
- **対象ファイル**: `app/page.tsx`
- ✅ ダッシュボード構成
- ✅ ナビゲーション設計
- ✅ レイアウト設計

#### 6. ドキュメント
- ✅ 各種START-PROMPT
- ✅ progress-tracker
- ✅ 進捗系ドキュメント（10/9以降に作成されたもの）
- ✅ 最新のプロセス把握

### 調査時の注意事項
- **使用されていないAPIは記載しない**：メインダッシュボードと2つのダッシュボードで使用されていないAPIは勝手に記載しない（混乱防止のため）
- **事実のみを記載**：先入観や仮説を排除
- **文脈を保持**：実装されている内容をそのまま記録

### 成果物（サマリー作成）

#### 1. UI思想ドキュメント
**ファイル名**: `docs/workflow/system-survey/UI思想サマリー.md`
- ✅ 既存ダッシュボードのUI設計思想
- ✅ レイアウトパターン
- ✅ 視覚的デザイン規則

#### 2. UX思想ドキュメント
**ファイル名**: `docs/workflow/system-survey/UX思想サマリー.md`
- ✅ ユーザーインタラクションパターン
- ✅ データ更新フロー（手動更新ボタンなど）
- ✅ ナビゲーション設計

#### 3. API仕様書
**ファイル名**: `docs/workflow/system-survey/API仕様書.md`
- ✅ **重要**: 今回該当するメインダッシュボードと2つのダッシュボードで使用されているAPIのみ記載
- ✅ 使用されていないAPIは記載しない
- ✅ Google Sheets API の使用方法
- ✅ Google Drive API の使用方法（OAuth認証ステータスAPIのみ使用）

#### 4. 技術仕様書
**ファイル名**: `docs/workflow/system-survey/技術仕様書.md`
- ✅ ディレクトリ構造
- ✅ コンポーネント設計
- ✅ lib設計
- ✅ 型定義パターン
- ✅ データフローパターン

### 完了条件
- ✅ 4つのサマリードキュメントが作成されている
- ✅ APIの仕様を深く理解している
- ✅ 既存システムの設計思想を把握している

### 完了日
2025-10-11

---

## 📊 フェーズ2: アクティブデータ調査

**ステータス**: ✅ 完了

### 目的
実際に稼働中のGoogle SheetsとGoogle Driveの構造を把握する

### 前提条件
- ✅ フェーズ1でAPIの調査が完了していること
- ✅ APIを深く理解していること

### 調査内容と進捗

#### 1. サーバーの立ち上げ
- ✅ 開発サーバーを起動
- ✅ APIエンドポイントの動作確認

#### 2. アクティブなGoogle Spreadsheetsの調査

**調査対象**:
- ✅ 営業予実管理シート（9シート全て把握）
- ✅ 月次管理シート（月次予実管理シートとして把握）
- ✅ KPIダッシュボード（KPIダッシュボードシートとして把握）

**調査項目**:
- ✅ すべてのシートを把握する（9シート）
- ✅ すべての入っている情報と項目を把握する（契約・入金管理シート：16項目）
- ✅ ヘッダー構造（契約・入金管理シートの詳細把握）
- ✅ データ形式（日付、金額、文字列等を把握）
- ✅ データの種類（契約情報、入金情報等）
- ✅ システムとの連動方法（取得対象を明確化）
- ✅ 操作対象なのか、取得対象なのか（Phase 1は取得のみ、Phase 2で操作を実装）

#### 3. Google Driveの調査

**調査対象**:
- エビデンス保存用ドライブ（https://drive.google.com/drive/folders/1blH8qUUd_TLW_nznN5wozwn-vXGFMZ3q）

**調査項目**:
- ✅ フォルダ構造（現在空、企業ごと・契約ごとの階層構造を設計）
- ✅ 権限設定（システムアカウントに読み取り・書き込み権限あり）
- ✅ 命名規則（企業フォルダ、契約フォルダ、ファイルの命名規則を策定）

### 注意事項
- **全データの調査は不要**
- **全てのシートを把握する**ことに徹する
- **すべての入っている情報と項目を把握する**ことに徹する
- 詳細なデータ内容の調査はフェーズ4で実施

### 成果物
**ファイル名**: `docs/workflow/active-data-survey/`
- ✅ アクティブスプレッドシート調査レポート.md
- ✅ Google Drive構造調査レポート.md

### 完了条件
- ✅ 2つの調査レポートが作成されている
- ✅ すべてのシートとその構造を把握している

### 完了日
2025-10-11

---

## 💡 フェーズ3: 実装草案ディスカッション

**ステータス**: ✅ 完了

### 目的
フェーズ1とフェーズ2の調査結果を元に、実装の方向性を決定する

### 前提条件
- ✅ フェーズ1とフェーズ2が完了していること

### 実施内容
- ✅ 仮でどのようなものを作成するかの草案をディスカッションしながら考える
- ✅ ある程度固まったら草案を保存

### 決定事項

#### UI形式
- **カードグリッド方式（5カラム）+ Notion風サイドパネル**を採用
- レスポンシブ対応: PC 5カラム、タブレット 3カラム、モバイル 2カラム

#### プログレスバー
- **スクロール追従型マイルストーン**（上部固定・半透明背景）
- 主要5ステップ（①情報 ③契約 ⑦完了 ⑨入金 ⑬掲載）を表示

#### サイドパネル
- カードクリック時に**右からスライドイン**（Notion風）
- アニメーション時間: 300ms
- 背景: メインエリアを暗転（bg-black/30）

#### Phase 1実装範囲
- 基本UI（プログレスバー、カードグリッド、サイドパネル）
- チェックリスト機能（LocalStorage保存）
- メール例文モーダル + コピー機能
- 契約・入金管理シート連動（読み取りのみ）
- 手動更新ボタン

#### Phase 2以降に延期
- スプレッドシートへの書き込み
- Google Drive連動（ファイルアップロード）
- 自動リマインダー

### 成果物
**ファイル名**: `docs/workflow/implementation-draft/実装草案.md`
- ✅ 実装草案ドキュメント

### 完了条件
- ✅ 実装草案が策定されている
- ✅ 必要な調査項目が特定されている

### 完了日
2025-10-11

---

## 🔬 フェーズ4: 詳細データ追加調査

**ステータス**: ✅ 完了

### 目的
実装草案に基づき、必要な情報を詳細レベルで調査する

### 前提条件
- ✅ フェーズ3で実装草案が策定されていること

### 調査内容と進捗

#### 1. 業務フローガイド全文の読み込み
- ✅ 契約書作成_業務フローガイド.md（13ステップの詳細手順）
- ✅ 契約書作成_情報収集フォーマット.md
- ✅ 契約書リーガルチェック_プロンプト.md

#### 2. 関連するスプレッドシートの全情報レベル調査
- ✅ 契約・入金管理シート全16項目の詳細仕様
- ✅ 全データの構造（データ型、形式、空欄の扱い）
- ✅ 全カラムの詳細（業務フローとの対応関係）
- ✅ API設計（`/api/contract/list`）とデータパース処理

#### 3. Google Driveの追加調査
- ✅ フォルダ階層構造の詳細設計（企業フォルダ→契約フォルダ→ファイル）
- ✅ ファイル命名規則の詳細策定（基本契約書、申込書、請求書、エビデンス）
- ✅ Phase 2以降のAPI実装設計（フォルダ作成、ファイルアップロード、ファイル一覧取得）

### 成果物
**ファイル名**: `docs/workflow/detailed-survey/`
- ✅ スプレッドシート詳細調査レポート.md
- ✅ Google Drive詳細調査レポート.md

### 完了条件
- ✅ 詳細調査レポートが作成されている
- ✅ 実装に必要な全データ構造を把握している

### 完了日
2025-10-11

---

## 📐 フェーズ5: 完全実装計画書作成

**ステータス**: ✅ 完了

### 目的
実装に必要な全ての情報を統合し、完全な実装計画を策定する

### 前提条件
- ✅ フェーズ1〜4が完了していること

### 参照ドキュメント
1. ✅ 契約業務フロー統合_要件定義書（事務側）
2. ✅ 契約業務フロー統合_システム側要望・方針
3. ✅ システム調査サマリー（フェーズ1の4つのドキュメント）
4. ✅ アクティブデータ調査レポート（フェーズ2）
5. ✅ 実装草案ドキュメント（フェーズ3）
6. ✅ 詳細調査レポート（フェーズ4）

### 作成内容
- ✅ システム側の完全な実装計画書
- ✅ 実装スケジュール
- ✅ 技術仕様
- ✅ データフロー設計
- ✅ UI/UX設計
- ✅ API設計
- ✅ コンポーネント設計

### 成果物
**ファイル名**: `docs/workflow/契約業務フロー統合_完全実装計画書.md`
- ✅ 契約業務フロー統合_完全実装計画書

### 完了条件
- ✅ 完全実装計画書が作成されている
- ✅ 実装に必要な全ての設計が完了している

### 完了日
2025-10-11

---

## 🚀 フェーズ6: 実装

**ステータス**: ✅ 完了

### 目的
フェーズ5の完全実装計画書に基づき、Phase 1（MVP）の実装を実施する

### 前提条件
- ✅ フェーズ5で完全実装計画書が作成されていること

### 実施内容
- ✅ 完全実装計画書に従った実装
  - ✅ Phase 1-1: 基本UI実装
  - ✅ Phase 1-2: インタラクション実装
  - ✅ Phase 1-3: データ連動実装
  - ✅ Phase 1-4: メインダッシュボード統合
- ✅ テスト完了
- ✅ デバッグ完了
- ✅ ドキュメント更新完了

### 成果物
- ✅ 契約業務フロー統合機能（Phase 1 MVP完成）
- ✅ テスト・検証完了

### 実装詳細

#### Phase 1-1: 基本UI実装
- ✅ types/workflow.ts - 型定義作成
- ✅ data/contract-workflow.ts - 13ステップの詳細データ作成
- ✅ data/email-templates.ts - メール例文データ作成
- ✅ lib/workflow-storage.ts - LocalStorage管理作成
- ✅ components/workflow/ProgressBar.tsx - プログレスバーコンポーネント作成
- ✅ components/workflow/StepCard.tsx - ステップカードコンポーネント作成

#### Phase 1-2: インタラクション実装
- ✅ components/workflow/SidePanel.tsx - サイドパネルコンポーネント作成
- ✅ components/workflow/EmailModal.tsx - メール例文モーダル作成
- ✅ チェックリスト機能実装
- ✅ LocalStorage保存機能実装
- ✅ メール例文コピー機能実装

#### Phase 1-3: データ連動実装
- ✅ app/api/contract/list/route.ts - 契約一覧API作成
- ✅ components/workflow/ContractTable.tsx - 契約テーブルコンポーネント作成
- ✅ Google Sheets連動（読み取りのみ）
- ✅ 手動更新機能実装

#### Phase 1-4: メインダッシュボード統合
- ✅ app/page.tsx - 「契約業務フロー」メニュー追加（192-195行目）
- ✅ app/dashboard/workflow/contract/page.tsx - メインページ実装

### 完了条件
- ✅ 機能が実装され、実装計画書通りに動作している
- ✅ テストが完了している
- ✅ ドキュメントが更新されている

### 完了日
2025-10-12

---

## 🔧 フェーズ1.5: Phase 1問題点の修正・実運用化

**ステータス**: ✅ 完了

### 目的

Phase 1（MVP）実装後にユーザーとのディスカッションで判明した問題点を修正し、実運用可能な契約業務フローダッシュボードを実装する

### 前提条件

- ✅ フェーズ6（Phase 1実装）が完了していること
- ✅ Phase 1で判明した問題点が明確になっていること
- ✅ Phase 1.5完全実装計画書が作成されていること

### Phase 1で判明した問題点

#### 問題1: 「どの企業の」契約を管理しているのか不明確
- Phase 1では13ステップカードが表示されるが、特定の契約を選択する仕組みがない
- 契約・入金管理シートには複数企業のデータがあるが、どの契約を進めているのか不明

#### 問題2: 新規契約の開始方法が未実装
- 契約・入金管理シートにデータが既に存在する前提
- ダッシュボードから新規契約を開始する機能がない

#### 問題3: 進捗管理列が存在しない
- 契約・入金管理シートには16列（A〜P列）しかない
- 13ステップの進捗状況を記録する列がない
- LocalStorageのみで管理しており、他ユーザーと共有できない

#### 問題4: リソースへのアクセス導線がない
- 情報収集フォーマットはステップ①カードに存在
- 契約未選択状態ではステップカードが表示されない
- 新規契約作成時に情報収集フォーマットにアクセスできない

### Phase 1.5で実装する機能

#### 1. 契約選択機能
- リマインダーカードから特定の契約を選択
- 選択された契約の13ステップカードグリッドを表示
- 進捗状況を契約・入金管理シートから取得

#### 2. 新規契約作成機能
- 「新規契約」ボタンを設置
- 情報収集フォーマットの内容を貼り付けてパース
- 契約・入金管理シートに新しい行を追加

#### 3. 進捗管理機能
- 契約・入金管理シートに進捗管理列を追加（Q〜AC列）
- ダッシュボードは進捗列から進捗状況を読み込む
- ステップ完了時に該当列に日付を書き込む（Phase 2で実装）

#### 4. リマインダー機能
- 顧客マスタのS列「受注」企業を自動取得
- 契約・入金管理シートと照合し、リマインダーカードを表示
- カードの色で視覚的に状況を表示
  - 🔴 新規契約必要
  - 🟠 入金遅延
  - 🟡 入金待ち
  - 🔵 進行中
  - 🟢 完了（フィルタで表示切替）
  - 🟣 契約満了近い

#### 5. フィルタ機能
- デフォルト: 進行中のみ表示（完了カード非表示）
- すべて表示: 完了カードも表示
- 契約満了日の60日前の完了カードは自動表示

#### 6. リソースメニュー
- ヘッダーに常時表示されるドロップダウンメニュー
- 情報収集フォーマット、基本契約書、申込書、マネーフォワード等へのリンク

### 実装スケジュール

| サブフェーズ | タイトル | 作業内容 | ステータス | 完了日 |
|------------|---------|---------|----------|--------|
| Phase 1.5-1 | リソースメニュー・フィルタ機能 | ResourceMenu, FilterDropdown作成 | ✅ 完了 | 2025-10-12 |
| Phase 1.5-2 | リマインダーAPI・カード表示 | /api/contract/reminders, ReminderCard作成 | ✅ 完了 | 2025-10-12 |
| Phase 1.5-3 | 新規契約作成機能 | /api/contract/parse, create, NewContractModal作成 | ✅ 完了 | 2025-10-12 |
| Phase 1.5-4 | 契約選択・13ステップ表示 | /api/contract/[id], 契約選択機能実装、フィルタロジック修正 | ✅ 完了 | 2025-10-12 |
| Phase 1.5-4.5 | リマインダー表示改善 | nextStep/nextStepTitle表示、契約満了日計算修正 | ✅ 完了 | 2025-10-12 |
| Phase 1.5-5 | 統合テスト・デバッグ | 全機能統合テスト | ✅ 完了 | 2025-10-12 |

### 成果物

#### 新規コンポーネント
- ✅ `components/workflow/ResourceMenu.tsx`
- ✅ `components/workflow/FilterDropdown.tsx`
- ✅ `components/workflow/ReminderCard.tsx`
- ✅ `components/workflow/NewContractModal.tsx`

#### 新規API
- ✅ `/api/contract/reminders` - リマインダー取得
- ✅ `/api/contract/create` - 新規契約作成
- ✅ `/api/contract/[id]` - 契約詳細取得
- ✅ `/api/contract/parse` - フォーマットパース

#### 型定義の追加
- ✅ `types/workflow.ts` に ReminderCard, ParsedContractForm, ContractData（拡張）を追加

### 完了条件

- ✅ リソースメニューがヘッダーに表示され、正しく動作する
- ✅ リマインダーカードが表示され、カードの色分けが正しい
- ✅ フィルタ機能が正しく動作する
- ✅ 新規契約ボタンからモーダルが開く
- ✅ 情報収集フォーマットをパースして契約を作成できる
- ✅ リマインダーカードをクリックすると13ステップカードグリッドが表示される
- ✅ 進捗状況が契約・入金管理シートから正しく読み込まれる
- ✅ すべての機能が統合され、正しく動作する
- ✅ 進行中カードに「次のステップ」が表示される
- ✅ 契約満了日が契約日の1年後として計算される

### 参照ドキュメント

**必読**:
- `docs/workflow/契約業務フロー統合_Phase1.5_完全実装計画書.md` - Phase 1.5の完全な実装計画

**参考**:
- `docs/workflow/契約業務フロー統合_完全実装計画書.md` - Phase 1の実装計画
- `docs/workflow/CONTRACT_WORKFLOW_START_PROMPT.md` - 開始時のガイド

### 完了日

2025-10-12

**Phase 1.5-5完了日**: 2025-10-12（前世代Claude Codeが実装済みであることを確認）

---

## 🏢 フェーズ1.6: 顧客正式情報マスタの作成・企業ID管理

**ステータス**: ✅ 完了（2025年10月12日）

### 引き継ぎ事項（2025年10月12日 - Phase 1.6実装完了）

**ステータス**: ✅ 完了（必須機能 + UI機能すべて実装完了）

#### ✅ フロー統合の確認完了

**受注検知から契約作成までのフロー**:
1. **受注検知**: `/api/contract/reminders` が顧客マスタのS列「受注」を検知
2. **企業マスタ登録**: `getOrCreateCompanyId()` で契約企業マスタに企業を登録（W列に顧客マスタ企業名を保存）
3. **契約レコード作成**: 契約・入金管理シートにA, B, C列のみ書き込み（D列以降は空欄）
4. **情報収集フォーマート受領**: `/api/contract/create` が既存行のD列以降を更新 + 契約企業マスタの詳細情報を更新

**重要**: `/api/contract/auto-create` は削除されており、その機能は `/api/contract/reminders` に統合済み。

#### ✅ 実装済みの内容

**データ構造**:
- ✅ 契約企業マスタシート作成済み（GASスクリプトで作成、名称は「契約企業マスタ」）
- ✅ スプレッドシート構造変更完了（B列に企業ID追加、C列に企業名）

**ヘルパー関数**:
- ✅ `lib/company-master-utils.ts` - getOrCreateCompanyId実装済み
- ✅ `lib/normalize-company-name.ts` - 企業名正規化実装済み
- ✅ `lib/generate-contract-id.ts` - 契約ID生成実装済み

**API実装**:
- ✅ `/api/contract/reminders` - 受注検知 + 企業マスタ登録 + 契約レコード作成を統合
- ✅ `/api/contract/create` - 既存行更新 + 企業マスタ詳細情報更新
- ✅ `/api/contract/[id]` - 列インデックス修正済み（範囲 A:AD、companyId取得）
- ✅ `/api/contract/list` - 列インデックス修正済み（範囲 A:AD、companyId追加）
- ✅ `/api/company-master/create` - 企業情報作成（重複チェック機能付き）
- ✅ `/api/company-master/list` - 企業一覧取得（A:B列のみ）
- ✅ `/api/contract/create-for-existing` - 既存企業追加契約API

**型定義**:
- ✅ `types/workflow.ts` に `CompanyMasterData` 型定義追加（46行目）
- ✅ `ContractData` に `companyId: number` フィールド追加（46行目）

**UI実装**:
- ✅ `components/workflow/ExistingCompanyContractModal.tsx` - 既存企業追加契約モーダル実装済み
- ✅ メインページ (app/dashboard/workflow/contract/page.tsx) に「既存企業追加契約」ボタン追加（297-301行目）

#### ✅ Phase 1.6 実装完了（2025年10月12日）

**ステータス**: ✅ 完了（必須機能 + UI機能実装完了）

**必須修正完了**:
- ✅ `/api/contract/list` の修正完了（app/api/contract/list/route.ts）
  - 修正内容:
    - 14行目: 取得範囲を `A:P` → `A:AD` に変更
    - 53行目: 企業名チェックを `row[1]` → `row[2]` に修正
    - 57行目: `companyId: parseInt(row[1])` フィールド追加
    - 58-72行目: 全ての列インデックスを +1 にシフト
  - Phase 1.6の列マッピングに完全対応
  - `/api/contract/[id]` と同じ列構造を使用

**UI機能実装完了**:
- ✅ `/api/company-master/[id]` の作成（app/api/company-master/[id]/route.ts）
  - 企業IDから企業情報を取得するAPI
  - 契約企業マスタシートから全25列のデータを取得
  - CompanyMasterData型に変換して返却
- ✅ SidePanelへの企業情報セクション追加（components/workflow/SidePanel.tsx）
  - `companyId` プロップを追加（16行目）
  - ステップ①のみ企業情報セクションを表示（140-224行目）
  - 表示項目: 企業正式名称、住所、電話番号、メールアドレス、担当者
  - 「詳細を表示」ボタンを追加（210-217行目）
- ✅ 企業情報詳細モーダルの実装（components/workflow/SidePanel.tsx 331-514行目）
  - 全25項目を5つのセクションに分けて表示
    - 基本情報: 企業ID、企業正式名称、企業略称、代表者役職、代表者名
    - 連絡先情報: 郵便番号、住所、電話番号、FAX、メール、HP URL
    - 担当者情報: 担当者名、担当者メール、担当者電話
    - その他情報: 業種、従業員数、資本金、設立年月日、備考
    - 登録情報: 登録日、最終更新日、データソース、契約実績
  - z-index: 60（オーバーレイ）、70（モーダル本体）でサイドパネル（z-50）より上に表示
  - スクロール可能な大きめのモーダル（max-w-3xl、max-h-90vh）
- ✅ メインページの修正（app/dashboard/workflow/contract/page.tsx）
  - SidePanelに `companyId={selectedContract?.companyId}` を渡す（394行目）
  - 契約選択時に企業情報をサイドパネルで確認可能

**未実装（Phase 1.6計画書で予定されていたが実装不要と判断）**:
- ⬜ インライン編集機能
  - 理由: Phase 2で入力フォームからのスプレッドシート更新を実装予定のため、Phase 1.6では表示機能のみで十分

#### 📝 次世代Claude Codeへの指示

1. **Phase 1.6は完全に完了**: すべての必須機能とUI機能が実装済み
   - 企業情報の取得・表示が完全に動作
   - ステップ①サイドパネルで企業情報を確認可能
   - 「詳細を表示」ボタンで全情報を閲覧可能

2. **動作確認済み**:
   - 契約選択 → ステップ①クリック → サイドパネルに企業情報表示
   - 「詳細を表示」ボタン → モーダルで全情報表示
   - companyIdがundefinedの場合は企業情報セクション非表示

3. **次のステップ**: Phase 1.6完了として、次のフェーズ（Phase 2または別機能）に進むかユーザーに確認

4. **参照ドキュメント**:
   - `docs/workflow/契約業務フロー統合_Phase1.6_完全実装計画書.md` - Phase 1.6の完全な実装計画
   - `components/workflow/SidePanel.tsx` - 企業情報セクションとモーダルの実装
   - `app/api/company-master/[id]/route.ts` - 企業情報取得APIの実装

### 目的

顧客正式情報マスタを作成し、企業情報の一元管理とID管理を実現する

### 前提条件

- ✅ フェーズ1.5（Phase 1.5実装）が完了していること
- ✅ Phase 1.6完全実装計画書が作成されていること

### Phase 1.5完了後に判明した問題点

#### 問題1: 情報の重複と不一致リスク
- 情報収集フォーマットの詳細情報が活用されていない
- 企業情報を複数箇所で管理する必要がある

#### 問題2: 企業名の表記ゆれ
- 「株式会社A」「（株）A」「A社」などの表記ゆれ
- リマインダー機能が正しく動作しない可能性

#### 問題3: ステップ①「情報収集」カードの役割が不明確
- 新規契約と既存契約で役割が異なる
- 既存契約で企業情報を確認・更新する手段がない

### Phase 1.6で実装する機能

#### 1. 顧客正式情報マスタシートの作成
- 営業予実管理スプレッドシートに新規シート追加
- 25列の詳細な企業情報を格納
- 企業IDによる一元管理

#### 2. 契約・入金管理シートの修正
- B列を「企業名」→「企業ID」に変更
- AD列に企業名（参照用、VLOOKUP）を追加

#### 3. データマイグレーション
- 既存の企業名を企業IDに変換
- 顧客正式情報マスタに既存企業を登録

#### 4. API実装
- 企業情報の取得・作成・更新API（4本）
- 新規契約作成APIの修正（企業ID対応）

#### 5. UI実装
- ステップ①サイドパネルに企業情報セクション追加
- 企業情報詳細モーダル
- インライン編集機能

### 実装スケジュール

| サブフェーズ | タイトル | 作業内容 | ステータス | 完了日 |
|------------|---------|---------|----------|--------|
| Phase 1.6-1 | データマイグレーション | 顧客正式情報マスタ作成、既存データ変換 | ✅ 完了 | 2025-10-12 |
| Phase 1.6-2 | API実装 | 企業情報API（8本）、列構造修正 | ✅ 完了 | 2025-10-12 |
| Phase 1.6-3 | UI実装 | ステップ①サイドパネル強化、詳細モーダル | ✅ 完了 | 2025-10-12 |
| Phase 1.6-4 | 既存機能の修正 | 契約一覧API修正、companyId対応 | ✅ 完了 | 2025-10-12 |
| Phase 1.6-5 | 統合テスト・デバッグ | 全機能統合テスト | ✅ 完了 | 2025-10-12 |

### 成果物

#### 新規シート
- `顧客正式情報マスタ` - 企業情報の一元管理シート（25列）

#### 新規API
- `/api/company-master/list` - 企業一覧取得
- `/api/company-master/[id]` - 企業詳細取得
- `/api/company-master/create` - 企業情報作成
- `/api/company-master/update/[id]` - 企業情報更新

#### 修正API
- `/api/contract/create` - 企業ID対応に修正
- `/api/contract/reminders` - 企業名をVLOOKUPで取得

#### 修正コンポーネント
- `app/dashboard/workflow/contract/page.tsx` - ステップ①サイドパネルに企業情報セクション追加

#### 型定義の追加
- `types/workflow.ts` に `CompanyMasterData` を追加
- `ContractData` を修正（企業名 → 企業ID）

### 完了条件

- [x] 顧客正式情報マスタシート（契約企業マスタ）が作成されている
- [x] 既存契約データのマイグレーションが完了している（企業ID追加）
- [x] 企業情報の取得・作成・更新APIが正しく動作する
- [x] ステップ①サイドパネルに企業情報が表示される
- [x] 企業情報の詳細表示ができる（詳細モーダル）
- [x] 新規契約作成時に企業IDが正しく書き込まれる
- [x] リマインダーカードに正しい企業名が表示される
- [x] すべての機能が統合され、正しく動作する

### 参照ドキュメント

**必読**:
- `docs/workflow/契約業務フロー統合_Phase1.6_完全実装計画書.md` - Phase 1.6の完全な実装計画

**参考**:
- `docs/workflow/契約業務フロー統合_Phase1.5_完全実装計画書.md` - Phase 1.5の実装計画
- `docs/workflow/CONTRACT_WORKFLOW_START_PROMPT.md` - 開始時のガイド

### 完了日

2025-10-12

---

## 📊 Phase 2: スプレッドシート書き込み・Google Drive連動

**ステータス**: 🔄 進行中（Phase 2.1完了）

### 目的

Phase 1.6までの「読み取りのみ」から「書き込み可能」へ進化し、完全な業務フロー管理を実現する

### 前提条件

- ✅ フェーズ1.6（Phase 1.6実装）が完了していること
- ✅ Phase 2完全実装計画書が作成されていること

### Phase 2の実装範囲

#### Phase 2.1: ステップ完了時のスプレッドシート書き込み ✅ 完了

**実装日**: 2025年10月12日

**実装内容**:
1. ✅ `/api/contract/complete-step` API作成
   - R〜AD列への正しい日付書き込み（R列=ステップ1、AD列=ステップ13）
   - ステップ番号に応じた列マッピング
   - バッチ更新による効率的な書き込み
   - 全13ステップ対応

2. ✅ SidePanelの完了機能実装
   - 「このステップを完了にする」ボタン追加
   - 完了確認モーダル実装
   - 更新情報の詳細表示（どの列に何が記録されるか）
   - エラーハンドリング実装

3. ✅ ResourceMenuの拡張
   - 契約・入金管理シートへの直接リンク追加
   - `NEXT_PUBLIC_SALES_SPREADSHEET_ID` 環境変数追加

4. ✅ メインページの統合
   - ステップ完了コールバック実装
   - 契約データ自動再取得
   - リマインダーカード自動更新

**技術詳細**:
- Google Sheets API の batchUpdate メソッド使用
- 列マッピング（例）:
  - ステップ①: R列（ステップ1完了日）
  - ステップ②: H列（契約書送付）+ S列（ステップ2完了日）
  - ステップ③: I列（契約書回収）+ T列（ステップ3完了日）
  - ステップ⑨: M列（入金実績日）+ N列（入金ステータス）+ Z列（ステップ9完了日）
  - など全13ステップ対応

**成果物**:
- `app/api/contract/complete-step/route.ts` - ステップ完了API
- `components/workflow/SidePanel.tsx` - 完了ボタン＋モーダル実装
- `components/workflow/ResourceMenu.tsx` - 契約・入金管理シートリンク追加
- `app/dashboard/workflow/contract/page.tsx` - ステップ完了コールバック実装

**ビルド確認**: ✅ 完了（27.3秒でReady、エラーなし）

#### Phase 2.2: Google Drive連動 🚨 実装中断

**ステータス**: 🚨 **実装中断 - 設計変更が必要**

**実装日**: 2025年10月12日

**実装内容（中断前）**:
1. ❌ 環境変数追加（`.env.local`）
   - `GOOGLE_DRIVE_FOLDER_ID`を追加

2. ❌ 3つのAPI作成（サービスアカウント版 - **誤った実装**）
   - `/api/drive/create-folder` - フォルダ自動作成
   - `/api/drive/upload` - ファイルアップロード
   - `/api/drive/list-files` - ファイル一覧取得

3. ❌ SidePanel UIの実装
   - ファイルアップロード機能（ドラッグ&ドロップ対応）
   - ファイル一覧表示機能

**発生した問題**:
```
⨯ [TypeError: File URL path must be absolute]
GET /api/contract/1 500 in 1790ms
→ 契約業務フローダッシュボードが開けない
```

**根本原因**:
1. Phase 2.2で作成したAPIが `lib/google-drive.ts` をインポート
2. `lib/google-drive.ts` が `lib/google-oauth.ts` をインポート
3. `google-oauth.ts` が `fs` モジュールを使用
4. Next.js 15.5.4 + Turbopack でバンドルエラー

**設計上の誤り**:
- **サービスアカウント認証を使用** → 15GBの容量制限
- **OAuth認証を使うべき** → 実質無制限（ユーザーのDrive容量）
- ゆめマガダッシュボードは既にOAuth認証で実装済み

**引き継ぎドキュメント**:
📄 **`docs/workflow/Phase2.2_引き継ぎ_問題と解決策.md`** ← **必読**

このドキュメントには以下が記載されています：
- 実装した内容の詳細
- 問題の連鎖の完全な分析
- 既存システム（ゆめマガダッシュボード）の正しい実装方法
- 解決すべき課題
- 推奨される実装計画（プランA: 修正、プランB: ロールバック）

**次世代Claude Codeへのアクション**:

**優先度1（緊急）**:
- [ ] Phase 2.2の実装をロールバック（プランB）
- [ ] 契約業務フローダッシュボードを復旧
- [ ] Phase 2.1（ステップ完了機能）の動作確認

**優先度2（重要）**:
- [ ] `fs`モジュール問題の解決策を決定
- [ ] ゆめマガダッシュボードのOAuth実装を完全調査
- [ ] OAuth認証の状態を確認

**優先度3（通常）**:
- [ ] Phase 2.2をOAuth認証ベースで再設計
- [ ] 再実装
- [ ] 統合テスト

### 完了条件

**Phase 2.1**:
- [x] `/api/contract/complete-step` APIが正しく動作する
- [x] 全13ステップで完了ボタンが表示される
- [x] 完了ボタンをクリックすると確認モーダルが表示される
- [x] 完了処理が正しく実行され、スプレッドシートが更新される
- [x] カードのステータスが「✅ 完了」に更新される
- [x] リマインダーカードが自動更新される
- [x] リソースメニューに契約・入金管理シートのリンクが表示される
- [x] エラーが適切に処理される
- [x] ビルドエラーがない

**Phase 2.2**:
- [ ] Google Drive APIの実装
- [ ] フォルダ自動作成機能
- [ ] ファイルアップロード機能
- [ ] ファイル一覧表示機能

### 参照ドキュメント

**必読**:
- `docs/workflow/契約業務フロー統合_Phase2_完全実装計画書.md` - Phase 2の完全な実装計画

**参考**:
- `docs/workflow/契約業務フロー統合_Phase1.6_完全実装計画書.md` - Phase 1.6の実装計画

### Phase 2.1 完了日

2025-10-12

---

## 📝 全体の注意事項

### ドキュメント作成時の厳守事項
- **事実のみを記載**：先入観や主観を一切混入させない
- **仮説の排除**：予測や憶測を記載しない
- **文脈の保持**：調査した内容をそのままの文脈で保存

### フェーズ移行の条件
- 各フェーズの成果物が完成していること
- 必要な情報が揃っていること
- 次フェーズの前提条件を満たしていること

---

**作成日**: 2025年10月11日
**最終更新**: 2025年10月12日（Phase 1.6追加）

以上
