# 契約業務フロー統合 - 開発フロー

**作成日**: 2025年10月11日
**作成者**: システム開発マネージャー
**目的**: 契約業務フロー統合の開発フェーズと作業手順の明確化

---

## 🎯 現在の進捗状況

**現在のフェーズ**: フェーズ6 - 実装
**ステータス**: ✅ 完了
**最終更新日**: 2025年10月12日
**担当者**: Claude Code

### 進捗サマリー
- ✅ 事務側要件定義受領
- ✅ システム側要望・方針ドキュメント作成
- ✅ 開発フロードキュメント作成
- ✅ フェーズ1: 既存システム調査完了
- ✅ フェーズ2: アクティブデータ調査完了
- ✅ フェーズ3: 実装草案ディスカッション完了
- ✅ フェーズ4: 詳細データ追加調査完了
- ✅ フェーズ5: 完全実装計画書作成完了
- ✅ フェーズ6: Phase 1（MVP）実装・テスト完了

### 引き継ぎ事項（フェーズ1）

**重要発見事項**:
- Google Drive APIは、メインダッシュボードと調査対象の2つのダッシュボードでは使用されていません。OAuth認証ステータスチェックAPI (`/api/auth/status`) のみ確認されています。
- すべてのダッシュボードで手動更新方式（初回マウント時に自動取得、以降は手動更新ボタン）が採用されています。
- API取得は`Promise.all`を使用した並列取得パターンが主流です。
- UI/UXは完全にカードベースレイアウトで統一されており、Tailwind CSS v4 + lucide-reactアイコンで実装されています。
- 型定義は`types/`ディレクトリ配下で機能ごとに分割管理されています。

### 引き継ぎ事項（フェーズ2）

**重要発見事項**:
- 営業予実管理スプレッドシートには**9つのシート**があり、そのうち「契約・入金管理」シートが契約業務フロー13ステップに直接対応しています。
- 契約・入金管理シートは**16項目**で構成され、契約フロー の7ステップ（③⑤⑦⑧⑨⑩⑬）がスプレッドシートと連動します。
- Google Drive エビデンス保存フォルダは現在空で、企業ごと・契約ごとの階層構造で保存する設計方針を策定しました。
- 既存のシート構造を活用することで、新規シート作成が不要であることを確認しました。

### 引き継ぎ事項（フェーズ3）

**実装方針の決定事項**:
- UI形式: **カードグリッド（5カラム）+ Notion風サイドパネル**方式を採用
- プログレスバー: **スクロール追従型マイルストーン**（主要5ステップ: ①③⑦⑨⑬）を上部固定表示
- サイドパネル: カードクリック時に右からスライドイン（300msアニメーション）
- Phase 1実装範囲: 基本UI、チェックリスト（LocalStorage）、メール例文モーダル、契約・入金管理シート連動（読み取りのみ）
- Phase 2以降: スプレッドシート書き込み、Google Drive連動、ファイルアップロード
- フェーズ4で詳細調査が必要な項目: 業務フローガイド全文、契約・入金管理シート全データ、Google Drive API実装方法

### 引き継ぎ事項（フェーズ4）

**詳細調査完了事項**:
- 業務フローガイド全文（13ステップ）、情報収集フォーマット、リーガルチェックプロンプトの読み込み完了
- 契約・入金管理シート全16項目の詳細仕様を把握（データ型、形式、業務フローとの対応関係）
- API設計（`/api/contract/list`）とデータパース処理の実装方針を策定
- Google Drive フォルダ階層構造（企業フォルダ→契約フォルダ→ファイル）の詳細設計完了
- ファイル命名規則（基本契約書、申込書、請求書、エビデンス）の詳細仕様を策定
- Phase 2以降のGoogle Drive API実装設計（フォルダ作成、ファイルアップロード、ファイル一覧取得）を完了
- 2つの詳細調査レポート作成完了

### 引き継ぎ事項（フェーズ5）

**完全実装計画書作成完了**:
- フェーズ1〜4の全ドキュメント（10件）と業務フローガイド（3件）を統合
- 完全実装計画書を作成（100ページ超の詳細ドキュメント）
- プロジェクト概要、システム設計、技術仕様、データフロー設計、UI/UX設計、API設計、コンポーネント設計、型定義、静的データ設計、実装スケジュール、テスト計画、Phase 2以降への拡張を網羅
- 実装に必要な全てのコード例、型定義、データ構造を記載
- Phase 1（MVP）の完了条件を明確化
- Phase 1-1〜1-4の4日間実装スケジュールを策定
- **次世代Claude Codeはこの完全実装計画書に従って実装を開始できます**

### 引き継ぎ事項（フェーズ6）

**Phase 1（MVP）実装完了**:
- ✅ **Phase 1-1**: 基本UI実装完了
  - 型定義作成（types/workflow.ts）
  - 静的データ作成（data/contract-workflow.ts, data/email-templates.ts）
  - LocalStorage管理（lib/workflow-storage.ts）
  - プログレスバーコンポーネント（components/workflow/ProgressBar.tsx）
  - ステップカードコンポーネント（components/workflow/StepCard.tsx）
- ✅ **Phase 1-2**: インタラクション実装完了
  - サイドパネルコンポーネント（components/workflow/SidePanel.tsx）
  - メール例文モーダル（components/workflow/EmailModal.tsx）
  - チェックリスト機能・LocalStorage保存機能
- ✅ **Phase 1-3**: データ連動実装完了
  - 契約一覧API（/api/contract/list）
  - ContractTableコンポーネント（components/workflow/ContractTable.tsx）
  - Google Sheets連動（読み取りのみ）
- ✅ **Phase 1-4**: メインダッシュボード統合完了
  - app/page.tsx に「契約業務フロー」メニュー追加（192-195行目）
  - メインページ実装完了（app/dashboard/workflow/contract/page.tsx）

**実装された機能**:
- 13ステップのカードグリッド表示（5カラム、レスポンシブ対応）
- スクロール追従型プログレスバー（主要5ステップ: ①③⑦⑨⑬）
- Notion風サイドパネル（右からスライドイン・300msアニメーション）
- チェックリスト機能（LocalStorage保存）
- メール例文モーダル＋コピー機能
- 外部リンクボタン（原本URL）
- 契約・入金管理シート連動（読み取りのみ）
- 手動更新ボタン

**未実装（Phase 2以降）**:
- スプレッドシートへの書き込み
- Google Driveファイルアップロード
- 入力フォームからのスプレッドシート更新
- 自動リマインダー機能
- 複数契約の同時管理

**テスト完了**:
- ✅ 動作確認・テスト実施完了
- ✅ ユーザー受け入れテスト完了

**次のステップ**:
- Phase 2の計画策定

---

## 📋 開発フェーズ概要

| フェーズ | タイトル | ステータス | 完了日 |
|---------|---------|----------|--------|
| フェーズ1 | 既存システム調査 | ✅ 完了 | 2025-10-11 |
| フェーズ2 | アクティブデータ調査 | ✅ 完了 | 2025-10-11 |
| フェーズ3 | 実装草案ディスカッション | ✅ 完了 | 2025-10-11 |
| フェーズ4 | 詳細データ追加調査 | ✅ 完了 | 2025-10-11 |
| フェーズ5 | 完全実装計画書作成 | ✅ 完了 | 2025-10-11 |
| フェーズ6 | 実装 | ✅ 完了 | 2025-10-12 |

---

## 🔍 フェーズ1: 既存システム調査

**ステータス**: ✅ 完了

### 目的
既存システムの設計思想、UI/UX、技術仕様を事実ベースで把握する

### 調査対象と進捗

#### 1. Google Drive API
- ✅ Drive API の実装方法（調査対象ダッシュボードでは未使用を確認）
- ✅ 使用されているメソッド（OAuth認証ステータスチェックAPIのみ）
- ✅ ファイル/フォルダ操作の実装パターン（調査対象外）

#### 2. Google Sheets lib
- ✅ `lib/google-sheets.ts` の調査
- ✅ 使用されているメソッド（getSheetData, getBatchSheetData, getSpreadsheetMetadata, updateSheetCell等）
- ✅ データ取得・解析の実装パターン

#### 3. ゆめマガ制作進捗ダッシュボード
- **対象ディレクトリ**: `app/dashboard/yumemaga-v2/`
- ✅ UI/UX構造
- ✅ データフロー
- ✅ コンポーネント設計

#### 4. 営業進捗管理ダッシュボード
- **対象ディレクトリ**: `app/dashboard/sales/`
- ✅ UI/UX構造
- ✅ データフロー
- ✅ コンポーネント設計

#### 5. メインダッシュボード
- **対象ファイル**: `app/page.tsx`
- ✅ ダッシュボード構成
- ✅ ナビゲーション設計
- ✅ レイアウト設計

#### 6. ドキュメント
- ✅ 各種START-PROMPT
- ✅ progress-tracker
- ✅ 進捗系ドキュメント（10/9以降に作成されたもの）
- ✅ 最新のプロセス把握

### 調査時の注意事項
- **使用されていないAPIは記載しない**：メインダッシュボードと2つのダッシュボードで使用されていないAPIは勝手に記載しない（混乱防止のため）
- **事実のみを記載**：先入観や仮説を排除
- **文脈を保持**：実装されている内容をそのまま記録

### 成果物（サマリー作成）

#### 1. UI思想ドキュメント
**ファイル名**: `docs/workflow/system-survey/UI思想サマリー.md`
- ✅ 既存ダッシュボードのUI設計思想
- ✅ レイアウトパターン
- ✅ 視覚的デザイン規則

#### 2. UX思想ドキュメント
**ファイル名**: `docs/workflow/system-survey/UX思想サマリー.md`
- ✅ ユーザーインタラクションパターン
- ✅ データ更新フロー（手動更新ボタンなど）
- ✅ ナビゲーション設計

#### 3. API仕様書
**ファイル名**: `docs/workflow/system-survey/API仕様書.md`
- ✅ **重要**: 今回該当するメインダッシュボードと2つのダッシュボードで使用されているAPIのみ記載
- ✅ 使用されていないAPIは記載しない
- ✅ Google Sheets API の使用方法
- ✅ Google Drive API の使用方法（OAuth認証ステータスAPIのみ使用）

#### 4. 技術仕様書
**ファイル名**: `docs/workflow/system-survey/技術仕様書.md`
- ✅ ディレクトリ構造
- ✅ コンポーネント設計
- ✅ lib設計
- ✅ 型定義パターン
- ✅ データフローパターン

### 完了条件
- ✅ 4つのサマリードキュメントが作成されている
- ✅ APIの仕様を深く理解している
- ✅ 既存システムの設計思想を把握している

### 完了日
2025-10-11

---

## 📊 フェーズ2: アクティブデータ調査

**ステータス**: ✅ 完了

### 目的
実際に稼働中のGoogle SheetsとGoogle Driveの構造を把握する

### 前提条件
- ✅ フェーズ1でAPIの調査が完了していること
- ✅ APIを深く理解していること

### 調査内容と進捗

#### 1. サーバーの立ち上げ
- ✅ 開発サーバーを起動
- ✅ APIエンドポイントの動作確認

#### 2. アクティブなGoogle Spreadsheetsの調査

**調査対象**:
- ✅ 営業予実管理シート（9シート全て把握）
- ✅ 月次管理シート（月次予実管理シートとして把握）
- ✅ KPIダッシュボード（KPIダッシュボードシートとして把握）

**調査項目**:
- ✅ すべてのシートを把握する（9シート）
- ✅ すべての入っている情報と項目を把握する（契約・入金管理シート：16項目）
- ✅ ヘッダー構造（契約・入金管理シートの詳細把握）
- ✅ データ形式（日付、金額、文字列等を把握）
- ✅ データの種類（契約情報、入金情報等）
- ✅ システムとの連動方法（取得対象を明確化）
- ✅ 操作対象なのか、取得対象なのか（Phase 1は取得のみ、Phase 2で操作を実装）

#### 3. Google Driveの調査

**調査対象**:
- エビデンス保存用ドライブ（https://drive.google.com/drive/folders/1blH8qUUd_TLW_nznN5wozwn-vXGFMZ3q）

**調査項目**:
- ✅ フォルダ構造（現在空、企業ごと・契約ごとの階層構造を設計）
- ✅ 権限設定（システムアカウントに読み取り・書き込み権限あり）
- ✅ 命名規則（企業フォルダ、契約フォルダ、ファイルの命名規則を策定）

### 注意事項
- **全データの調査は不要**
- **全てのシートを把握する**ことに徹する
- **すべての入っている情報と項目を把握する**ことに徹する
- 詳細なデータ内容の調査はフェーズ4で実施

### 成果物
**ファイル名**: `docs/workflow/active-data-survey/`
- ✅ アクティブスプレッドシート調査レポート.md
- ✅ Google Drive構造調査レポート.md

### 完了条件
- ✅ 2つの調査レポートが作成されている
- ✅ すべてのシートとその構造を把握している

### 完了日
2025-10-11

---

## 💡 フェーズ3: 実装草案ディスカッション

**ステータス**: ✅ 完了

### 目的
フェーズ1とフェーズ2の調査結果を元に、実装の方向性を決定する

### 前提条件
- ✅ フェーズ1とフェーズ2が完了していること

### 実施内容
- ✅ 仮でどのようなものを作成するかの草案をディスカッションしながら考える
- ✅ ある程度固まったら草案を保存

### 決定事項

#### UI形式
- **カードグリッド方式（5カラム）+ Notion風サイドパネル**を採用
- レスポンシブ対応: PC 5カラム、タブレット 3カラム、モバイル 2カラム

#### プログレスバー
- **スクロール追従型マイルストーン**（上部固定・半透明背景）
- 主要5ステップ（①情報 ③契約 ⑦完了 ⑨入金 ⑬掲載）を表示

#### サイドパネル
- カードクリック時に**右からスライドイン**（Notion風）
- アニメーション時間: 300ms
- 背景: メインエリアを暗転（bg-black/30）

#### Phase 1実装範囲
- 基本UI（プログレスバー、カードグリッド、サイドパネル）
- チェックリスト機能（LocalStorage保存）
- メール例文モーダル + コピー機能
- 契約・入金管理シート連動（読み取りのみ）
- 手動更新ボタン

#### Phase 2以降に延期
- スプレッドシートへの書き込み
- Google Drive連動（ファイルアップロード）
- 自動リマインダー

### 成果物
**ファイル名**: `docs/workflow/implementation-draft/実装草案.md`
- ✅ 実装草案ドキュメント

### 完了条件
- ✅ 実装草案が策定されている
- ✅ 必要な調査項目が特定されている

### 完了日
2025-10-11

---

## 🔬 フェーズ4: 詳細データ追加調査

**ステータス**: ✅ 完了

### 目的
実装草案に基づき、必要な情報を詳細レベルで調査する

### 前提条件
- ✅ フェーズ3で実装草案が策定されていること

### 調査内容と進捗

#### 1. 業務フローガイド全文の読み込み
- ✅ 契約書作成_業務フローガイド.md（13ステップの詳細手順）
- ✅ 契約書作成_情報収集フォーマット.md
- ✅ 契約書リーガルチェック_プロンプト.md

#### 2. 関連するスプレッドシートの全情報レベル調査
- ✅ 契約・入金管理シート全16項目の詳細仕様
- ✅ 全データの構造（データ型、形式、空欄の扱い）
- ✅ 全カラムの詳細（業務フローとの対応関係）
- ✅ API設計（`/api/contract/list`）とデータパース処理

#### 3. Google Driveの追加調査
- ✅ フォルダ階層構造の詳細設計（企業フォルダ→契約フォルダ→ファイル）
- ✅ ファイル命名規則の詳細策定（基本契約書、申込書、請求書、エビデンス）
- ✅ Phase 2以降のAPI実装設計（フォルダ作成、ファイルアップロード、ファイル一覧取得）

### 成果物
**ファイル名**: `docs/workflow/detailed-survey/`
- ✅ スプレッドシート詳細調査レポート.md
- ✅ Google Drive詳細調査レポート.md

### 完了条件
- ✅ 詳細調査レポートが作成されている
- ✅ 実装に必要な全データ構造を把握している

### 完了日
2025-10-11

---

## 📐 フェーズ5: 完全実装計画書作成

**ステータス**: ✅ 完了

### 目的
実装に必要な全ての情報を統合し、完全な実装計画を策定する

### 前提条件
- ✅ フェーズ1〜4が完了していること

### 参照ドキュメント
1. ✅ 契約業務フロー統合_要件定義書（事務側）
2. ✅ 契約業務フロー統合_システム側要望・方針
3. ✅ システム調査サマリー（フェーズ1の4つのドキュメント）
4. ✅ アクティブデータ調査レポート（フェーズ2）
5. ✅ 実装草案ドキュメント（フェーズ3）
6. ✅ 詳細調査レポート（フェーズ4）

### 作成内容
- ✅ システム側の完全な実装計画書
- ✅ 実装スケジュール
- ✅ 技術仕様
- ✅ データフロー設計
- ✅ UI/UX設計
- ✅ API設計
- ✅ コンポーネント設計

### 成果物
**ファイル名**: `docs/workflow/契約業務フロー統合_完全実装計画書.md`
- ✅ 契約業務フロー統合_完全実装計画書

### 完了条件
- ✅ 完全実装計画書が作成されている
- ✅ 実装に必要な全ての設計が完了している

### 完了日
2025-10-11

---

## 🚀 フェーズ6: 実装

**ステータス**: ✅ 完了

### 目的
フェーズ5の完全実装計画書に基づき、Phase 1（MVP）の実装を実施する

### 前提条件
- ✅ フェーズ5で完全実装計画書が作成されていること

### 実施内容
- ✅ 完全実装計画書に従った実装
  - ✅ Phase 1-1: 基本UI実装
  - ✅ Phase 1-2: インタラクション実装
  - ✅ Phase 1-3: データ連動実装
  - ✅ Phase 1-4: メインダッシュボード統合
- ✅ テスト完了
- ✅ デバッグ完了
- ✅ ドキュメント更新完了

### 成果物
- ✅ 契約業務フロー統合機能（Phase 1 MVP完成）
- ✅ テスト・検証完了

### 実装詳細

#### Phase 1-1: 基本UI実装
- ✅ types/workflow.ts - 型定義作成
- ✅ data/contract-workflow.ts - 13ステップの詳細データ作成
- ✅ data/email-templates.ts - メール例文データ作成
- ✅ lib/workflow-storage.ts - LocalStorage管理作成
- ✅ components/workflow/ProgressBar.tsx - プログレスバーコンポーネント作成
- ✅ components/workflow/StepCard.tsx - ステップカードコンポーネント作成

#### Phase 1-2: インタラクション実装
- ✅ components/workflow/SidePanel.tsx - サイドパネルコンポーネント作成
- ✅ components/workflow/EmailModal.tsx - メール例文モーダル作成
- ✅ チェックリスト機能実装
- ✅ LocalStorage保存機能実装
- ✅ メール例文コピー機能実装

#### Phase 1-3: データ連動実装
- ✅ app/api/contract/list/route.ts - 契約一覧API作成
- ✅ components/workflow/ContractTable.tsx - 契約テーブルコンポーネント作成
- ✅ Google Sheets連動（読み取りのみ）
- ✅ 手動更新機能実装

#### Phase 1-4: メインダッシュボード統合
- ✅ app/page.tsx - 「契約業務フロー」メニュー追加（192-195行目）
- ✅ app/dashboard/workflow/contract/page.tsx - メインページ実装

### 完了条件
- ✅ 機能が実装され、実装計画書通りに動作している
- ✅ テストが完了している
- ✅ ドキュメントが更新されている

### 完了日
2025-10-12

---

## 📝 全体の注意事項

### ドキュメント作成時の厳守事項
- **事実のみを記載**：先入観や主観を一切混入させない
- **仮説の排除**：予測や憶測を記載しない
- **文脈の保持**：調査した内容をそのままの文脈で保存

### フェーズ移行の条件
- 各フェーズの成果物が完成していること
- 必要な情報が揃っていること
- 次フェーズの前提条件を満たしていること

---

**作成日**: 2025年10月11日
**最終更新**: 2025年10月12日

以上
