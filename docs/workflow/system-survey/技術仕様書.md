# 技術仕様書

**作成日**: 2025年10月11日
**作成者**: Claude Code
**目的**: 既存システムの技術仕様を事実ベースで記録する

---

## 📋 技術スタック

### フロントエンド

- **フレームワーク**: Next.js 15 (App Router)
- **言語**: TypeScript
- **スタイリング**: Tailwind CSS v4 (`@tailwindcss/postcss`)
- **アイコン**: lucide-react
- **状態管理**: React useState + useEffect

### バックエンド

- **API**: Next.js API Routes
- **データソース**: Google Sheets
- **認証**: Google Service Account

### ライブラリ

- **Google API**: googleapis

---

## 📁 ディレクトリ構造

**プロジェクトルート**: `/mnt/c/yumesuta-management-system`

```
/mnt/c/yumesuta-management-system/
├── app/
│   ├── page.tsx                           # メインダッシュボード
│   ├── dashboard/
│   │   ├── sales/
│   │   │   └── page.tsx                   # 営業進捗管理ダッシュボード
│   │   ├── yumemaga-v2/
│   │   │   ├── page.tsx                   # ゆめマガ制作進捗ダッシュボード
│   │   │   └── company-form/
│   │   │       └── page.tsx               # 企業情報入力フォーム
│   │   ├── tasks/                         # タスク管理
│   │   ├── analytics/                     # HP・LLMO分析
│   │   ├── sns/                           # SNS投稿管理
│   │   └── partners/                      # パートナー・スター
│   └── api/
│       ├── sales-kpi/route.ts             # 営業KPI API
│       ├── process-schedule/route.ts      # 工程スケジュールAPI
│       ├── yumemaga-v2/                   # ゆめマガv2 API群
│       │   ├── processes/route.ts
│       │   ├── progress/route.ts
│       │   ├── next-month/route.ts
│       │   ├── ready-processes/route.ts
│       │   ├── company-processes/route.ts
│       │   ├── company-page-production/route.ts
│       │   ├── categories/route.ts
│       │   ├── available-issues/route.ts
│       │   ├── actual-date/route.ts
│       │   ├── company-status/route.ts
│       │   ├── planned-date/route.ts
│       │   └── confirmation-status/route.ts
│       ├── tasks/route.ts
│       ├── analytics/route.ts
│       ├── sns/route.ts
│       ├── partners/route.ts
│       ├── quick-access/route.ts
│       ├── keyword-rank/route.ts
│       └── auth/
│           └── status/route.ts
├── components/
│   ├── next-month/
│   │   └── NextMonthPrepSection.tsx
│   ├── category-management/
│   │   └── CategoryManagementSection.tsx
│   ├── data-submission/
│   │   └── DataSubmissionSection.tsx
│   ├── overall-progress/
│   │   └── OverallProgressSection.tsx
│   ├── company-management/
│   │   └── CompanyManagementSection.tsx
│   └── company-page-production/
│       └── CompanyPageProductionSection.tsx
├── lib/
│   └── google-sheets.ts                   # Google Sheets API クライアント
├── types/
│   ├── sales.ts                           # 営業関連型定義
│   ├── process.ts                         # 工程関連型定義
│   ├── task.ts                            # タスク関連型定義
│   ├── analytics.ts                       # 分析関連型定義
│   ├── sns.ts                             # SNS関連型定義
│   ├── partner.ts                         # パートナー関連型定義
│   └── quick-access.ts                    # クイックアクセス型定義
├── docs/
│   ├── requirements/
│   │   └── requirements-definition.md     # 要件定義書
│   ├── development/
│   │   ├── development-progress.md        # 開発進捗管理
│   │   └── START_PROMPT.md                # 開発スタートプロンプト
│   └── SYSTEM_OVERVIEW.md                 # システム説明文書
├── .env.local                             # 環境変数（Git管理外）
├── package.json
├── tsconfig.json
├── tailwind.config.ts
└── next.config.ts
```

---

## 🔧 コンポーネント設計

### ページコンポーネント（Client Component）

**すべてのダッシュボードページで使用**:
```tsx
'use client';

import { useState, useEffect } from 'react';
```

**特徴**:
- `'use client'`ディレクティブで明示的にクライアントコンポーネント化
- React HooksでState管理
- API呼び出しはuseEffect + fetchで実装

---

### カスタムコンポーネント（ゆめマガダッシュボード）

**実装例** (`app/dashboard/yumemaga-v2/page.tsx` 17-22行目):
```tsx
import { NextMonthPrepSection } from '@/components/next-month/NextMonthPrepSection';
import { CategoryManagementSection } from '@/components/category-management/CategoryManagementSection';
import { DataSubmissionSection } from '@/components/data-submission/DataSubmissionSection';
import { OverallProgressSection } from '@/components/overall-progress/OverallProgressSection';
import { CompanyManagementSection } from '@/components/company-management/CompanyManagementSection';
import { CompanyPageProductionSection } from '@/components/company-page-production/CompanyPageProductionSection';
```

**配置**:
- `components/` ディレクトリ配下
- 機能ごとにサブディレクトリ分割

---

## 🔧 lib設計

### Google Sheets API クライアント

**ファイル**: `lib/google-sheets.ts`

**エクスポートされている関数**:

1. `getGoogleSheetsClient()`: Google Sheets APIクライアントを初期化
2. `getSheetData(spreadsheetId, range)`: スプレッドシートからデータを取得
3. `getBatchSheetData(spreadsheetId, ranges)`: 複数範囲からデータを一括取得
4. `getSpreadsheetMetadata(spreadsheetId)`: スプレッドシートのメタデータを取得
5. `updateSheetData(spreadsheetId, range, values)`: データを上書き更新
6. `updateCell(spreadsheetId, sheetName, row, col, value)`: 単一セルを更新
7. `updateCellExtended(spreadsheetId, sheetName, row, col, value)`: 多文字カラム対応の単一セル更新
8. `appendSheetData(spreadsheetId, sheetName, values)`: 行を末尾に追加
9. `insertColumns(spreadsheetId, sheetId, startIndex, columnCount)`: カラム挿入
10. `deleteColumns(spreadsheetId, sheetId, startIndex, columnCount)`: カラム削除
11. `deleteRows(spreadsheetId, sheetId, startIndex, rowCount)`: 行削除
12. `updateSheetCell(spreadsheetId, sheetName, cellAddress, value)`: セルアドレス指定で更新
13. `appendSheetRow(spreadsheetId, sheetName, rowData)`: 単一行を追加
14. `updateSheetRow(spreadsheetId, sheetName, rowNumber, rowData)`: 行を更新

**認証方式**: Google Service Account

**スコープ**: `https://www.googleapis.com/auth/spreadsheets`

---

## 🗂️ 型定義パターン

### types/ ディレクトリ

**ファイル一覧**:
- `types/sales.ts` - 営業KPI・進捗型定義
- `types/process.ts` - 工程・スケジュール型定義
- `types/task.ts` - タスク管理型定義
- `types/analytics.ts` - 分析データ型定義
- `types/sns.ts` - SNS投稿型定義
- `types/partner.ts` - パートナー・スター型定義
- `types/quick-access.ts` - クイックアクセスボタン型定義

### 型定義例

**営業KPI型** (`types/sales.ts`):
```tsx
export interface SalesKPIResponse {
  success: boolean;
  data?: {
    kpi: KPIMetrics;
    magazineDistribution: MagazineDistributionMetrics;
    monthlyPerformance: MonthlyPerformance;
    customerStats: CustomerStats;
    updatedAt: string;
  };
  error?: string;
}
```

---

## 📊 データフローパターン

### 1. 基本的なフロー

```
ユーザー操作（ボタンクリック / ページマウント）
  ↓
fetchData関数が実行
  ↓
setLoading(true)
  ↓
fetch('/api/endpoint')
  ↓
レスポンス受信
  ↓
データ整形・型変換
  ↓
setState(data)
  ↓
setLoading(false)
  ↓
再レンダリング
```

### 2. 並列API取得（メインダッシュボード）

**実装** (`app/page.tsx` 75-95行目):
```tsx
const [salesRes, yumemagaRes, tasksRes, analyticsRes, snsRes, partnersRes, quickAccessRes, keywordRankRes] = await Promise.all([
  fetch('/api/sales-kpi'),
  fetch('/api/process-schedule'),
  fetch('/api/tasks'),
  fetch('/api/analytics'),
  fetch('/api/sns'),
  fetch('/api/partners'),
  fetch('/api/quick-access'),
  fetch('/api/keyword-rank'),
]);

const [salesData, yumemagaData, tasksData, analyticsData, snsData, partnersData, quickAccessData, keywordRankData] = await Promise.all([
  salesRes.json(),
  yumemagaRes.json(),
  tasksRes.json(),
  analyticsRes.json(),
  snsRes.json(),
  partnersRes.json(),
  quickAccessRes.json(),
  keywordRankRes.json(),
]);
```

**特徴**:
- `Promise.all`で8つのAPIを並列取得
- 全レスポンスを一度に取得後、データ整形

### 3. 依存関係のあるデータ取得

**ゆめマガダッシュボード** (`app/dashboard/yumemaga-v2/page.tsx` 208-244行目):
```tsx
// カテゴリマスター取得（優先）
useEffect(() => {
  const fetchCategoryMetadata = async () => {
    const res = await fetch('/api/yumemaga-v2/categories');
    const data = await res.json();
    if (data.success) {
      setCategoryMetadata(data.categories);
    }
  };
  fetchCategoryMetadata();
}, []);

// カテゴリマスター取得後に全データ取得
useEffect(() => {
  if (categoryMetadata.length > 0) {
    fetchAllData();
  }
}, [selectedIssue, categoryMetadata]);
```

**特徴**:
- `categoryMetadata`が取得されるまで`fetchAllData`を実行しない
- 依存配列に`categoryMetadata`を指定

---

## 🎨 スタイリングパターン

### Tailwind CSS v4の使用

**設定ファイル**: `tailwind.config.ts`

**ユーティリティクラスの使用**:
```tsx
<div className="min-h-screen bg-gray-50 p-8">
  <div className="max-w-7xl mx-auto">
    <div className="bg-white rounded-lg shadow-md p-6">
      {/* コンテンツ */}
    </div>
  </div>
</div>
```

**特徴**:
- インラインでユーティリティクラスを組み合わせ
- カスタムCSSファイルは使用しない
- すべてのスタイリングがコンポーネント内で完結

### 動的クラスの生成

**条件付きスタイル**:
```tsx
<div className={`p-4 rounded-lg border-2 ${
  metric.status === 'ok'
    ? 'bg-green-50 border-green-200'
    : 'bg-red-50 border-red-200'
}`}>
```

**テンプレートリテラル + 三項演算子**で動的にクラスを切り替え

---

## 🔐 環境変数

**ファイル**: `.env.local` (Git管理外)

**必須環境変数**:
```
GOOGLE_SERVICE_ACCOUNT_KEY=<JSON形式のサービスアカウント認証情報>
SALES_SPREADSHEET_ID=<営業管理スプレッドシートID>
YUMEMAGA_SPREADSHEET_ID=<ゆめマガスプレッドシートID>
PARTNERS_SPREADSHEET_ID=<パートナー・スターデータスプレッドシートID>
```

**実装例** (`lib/google-sheets.ts` 29行目):
```tsx
const credentialsJson = process.env.GOOGLE_SERVICE_ACCOUNT_KEY;
```

---

## ⚙️ ビルド・開発

### 開発サーバー

**コマンド**:
```bash
npm run dev
```

**設定**: Next.js Turbopack使用

**URL**: http://localhost:3000

### プロダクションビルド

**コマンド**:
```bash
npm run build --turbopack
npm start
```

---

## 📦 パッケージ管理

**ファイル**: `package.json`

**主要な依存関係**:
- `next`: ^15.x
- `react`: ^19.x
- `react-dom`: ^19.x
- `typescript`: ^5.x
- `tailwindcss`: ^4.x
- `lucide-react`: ^0.x
- `googleapis`: ^144.x

---

## 🔧 TypeScript設定

**ファイル**: `tsconfig.json`

**主要設定**:
```json
{
  "compilerOptions": {
    "target": "ES2020",
    "lib": ["ES2020", "DOM", "DOM.Iterable"],
    "jsx": "preserve",
    "module": "esnext",
    "moduleResolution": "bundler",
    "strict": true,
    "paths": {
      "@/*": ["./*"]
    }
  }
}
```

**パスエイリアス**:
- `@/` → プロジェクトルート

---

## 🚀 デプロイ

**プラットフォーム**: 未設定（ローカル開発環境のみ）

---

## 📚 ドキュメント

**docs/ ディレクトリ**:
- `docs/requirements/requirements-definition.md` - 要件定義書 v2.0
- `docs/SYSTEM_OVERVIEW.md` - システム説明文書 v2.0
- `docs/development/development-progress.md` - 開発進捗管理（MVP完成記録）
- `docs/development/START_PROMPT.md` - 開発スタートプロンプト

---

## 🎯 アーキテクチャ設計原則（事実ベース）

1. **App Router使用**: Next.js 15のApp Routerを使用
2. **Client Component**: すべてのダッシュボードページは`'use client'`
3. **API Routes**: バックエンドロジックはNext.js API Routesで実装
4. **Google Sheets連携**: `lib/google-sheets.ts`経由で統一的にアクセス
5. **型安全性**: TypeScriptで型定義を厳密に管理
6. **コンポーネント分割**: 機能ごとに`components/`配下で管理
7. **手動更新方式**: 初回マウント時に自動取得、以降は手動更新ボタン
8. **Read-Only MVP**: 表示機能のみ（書き込み機能は一部のみ実装）
9. **環境変数管理**: `.env.local`でシークレット情報を管理

---

**調査完了日**: 2025年10月11日
**調査者**: Claude Code
